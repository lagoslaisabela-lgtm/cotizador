<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lagos La Isabela — Ordenes</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  /* ──────────────── DRIVE SYNC STYLES ──────────────── */
  .drive-status-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px 6px 8px;
    border-radius: 20px;
    border: 1px solid rgba(0,180,216,0.2);
    background: rgba(10,22,40,0.6);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  .drive-status-bar:hover { border-color: rgba(0,180,216,0.5); color: var(--text-secondary); }
  .drive-status-bar.connected { border-color: rgba(6,214,160,0.4); color: var(--green); background: rgba(6,214,160,0.07); }
  .drive-status-bar.syncing   { border-color: rgba(0,180,216,0.4); color: var(--teal);  background: rgba(0,180,216,0.07); }
  .drive-status-bar.error     { border-color: rgba(239,71,111,0.4); color: var(--coral); background: rgba(239,71,111,0.07); }

  .drive-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: currentColor;
    flex-shrink: 0;
  }
  .drive-status-bar.syncing .drive-dot {
    animation: pulse-dot 1s infinite;
  }
  @keyframes pulse-dot {
    0%,100% { opacity: 1; transform: scale(1); }
    50%      { opacity: 0.4; transform: scale(0.7); }
  }

  .drive-sync-time {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 400;
  }

  /* Setup modal */
  .setup-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(5,12,25,0.92);
    backdrop-filter: blur(8px);
    z-index: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .setup-modal-overlay.open { opacity: 1; pointer-events: all; }

  .setup-modal {
    background: var(--ocean-mid);
    border: 1px solid rgba(0,180,216,0.3);
    border-radius: var(--radius);
    width: 100%;
    max-width: 560px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.6);
    transform: translateY(16px);
    transition: transform 0.25s;
    overflow: hidden;
  }
  .setup-modal-overlay.open .setup-modal { transform: translateY(0); }

  .setup-header {
    background: linear-gradient(135deg, rgba(0,180,216,0.15), rgba(6,214,160,0.08));
    border-bottom: 1px solid var(--card-border);
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .setup-header h3 {
    font-family: 'Syne', sans-serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--teal-pale);
    display: flex; align-items: center; gap: 10px;
  }

  .setup-body { padding: 24px; }

  .setup-step {
    display: flex;
    gap: 14px;
    margin-bottom: 20px;
    align-items: flex-start;
  }
  .step-num {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: rgba(0,180,216,0.15);
    border: 1px solid rgba(0,180,216,0.3);
    color: var(--teal);
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .step-content { flex: 1; }
  .step-content strong {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }
  .step-content p, .step-content a {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  .step-content a { color: var(--teal); text-decoration: none; }
  .step-content a:hover { text-decoration: underline; }
  .step-content code {
    background: rgba(0,180,216,0.1);
    border: 1px solid rgba(0,180,216,0.2);
    border-radius: 4px;
    padding: 1px 6px;
    font-family: 'Roboto Mono', monospace;
    font-size: 11px;
    color: var(--teal-pale);
    word-break: break-all;
  }

  .setup-input-wrap { margin-top: 8px; display: flex; gap: 8px; }
  .setup-input-wrap input { flex: 1; font-size: 13px; }

  .divider-label {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 16px 0;
    color: var(--text-muted);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.7px;
  }
  .divider-label::before, .divider-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--card-border);
  }

  .google-btn {
    width: 100%;
    padding: 12px 20px;
    background: white;
    color: #3c4043;
    border: 1px solid #dadce0;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .google-btn:hover { background: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
  .google-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .google-btn svg { flex-shrink: 0; }

  .setup-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--card-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .setup-footer-note {
    font-size: 11px;
    color: var(--text-muted);
  }
</style>
<style>
  /* ═══════════ TEMA OSCURO (por defecto) ═══════════ */
  :root {
    --ocean-deep:    #0a1628;
    --ocean-mid:     #0d2240;
    --ocean-surface: #0f3460;
    --teal:          #00b4d8;
    --teal-bright:   #48cae4;
    --teal-pale:     #90e0ef;
    --silver:        #caf0f8;
    --gold:          #ffd166;
    --coral:         #ef476f;
    --green:         #06d6a0;

    /* Semánticas oscuras */
    --surface:       #0d1f3c;
    --text-primary:  #e8f4f8;
    --text-secondary:#90b4c4;
    --text-muted:    #4a7a8f;
    --card-bg:       rgba(13,34,64,0.85);
    --card-border:   rgba(0,180,216,0.2);
    --input-bg:      rgba(10,22,40,0.8);
    --input-border:  rgba(0,180,216,0.2);
    --shadow-teal:   0 0 30px rgba(0,180,216,0.15);
    --radius:        14px;
    --radius-sm:     8px;
  }

  /* ═══════════ TEMA CLARO ═══════════ */
  body.light {
    --ocean-deep:    #f0f6ff;
    --ocean-mid:     #e2ecf9;
    --ocean-surface: #cce0f5;
    --surface:       #ffffff;
    --text-primary:  #0d1f3c;
    --text-secondary:#2a5278;
    --text-muted:    #6a8fad;
    --card-bg:       rgba(255,255,255,0.90);
    --card-border:   rgba(0,140,200,0.18);
    --input-bg:      rgba(240,248,255,0.95);
    --input-border:  rgba(0,140,200,0.25);
    --shadow-teal:   0 0 30px rgba(0,140,200,0.10);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--ocean-deep);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.35s, color 0.35s;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0,180,216,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 40% 40% at 80% 80%, rgba(6,214,160,0.06) 0%, transparent 50%),
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 60px,
        rgba(0,180,216,0.015) 60px,
        rgba(0,180,216,0.015) 61px
      ),
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 60px,
        rgba(0,180,216,0.015) 60px,
        rgba(0,180,216,0.015) 61px
      );
    pointer-events: none;
    z-index: 0;
    transition: opacity 0.35s;
  }

  body.light::before {
    background:
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0,140,200,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 40% 40% at 80% 80%, rgba(6,214,160,0.04) 0%, transparent 50%),
      repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(0,140,200,0.025) 60px, rgba(0,140,200,0.025) 61px),
      repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(0,140,200,0.025) 60px, rgba(0,140,200,0.025) 61px);
  }

  /* ──────────────── HEADER ──────────────── */
  #top-bar {
    position: sticky;
    top: 0;
    z-index: 200;
  }

  header {
    background: rgba(10,22,40,0.95);
    backdrop-filter: blur(20px);
    padding: 0 24px;
    overflow: hidden;
    transition: background 0.35s;
  }
  body.light header {
    background: rgba(240,248,255,0.96);
    border-bottom: 1px solid rgba(0,140,200,0.15);
  }

  .header-inner {
    max-width: 1280px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    min-height: 64px;
    padding: 20px 0;
    gap: 16px;
    width: 100%;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
  }

  .logo-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  /* Pez nadando libre por todo el header */
  #fish-swimmer {
    position: absolute;
    font-size: 22px;
    pointer-events: none;
    z-index: 0;
    will-change: transform, left, top;
    user-select: none;
    line-height: 1;
  }

  .logo-text {
    font-family: 'DM Sans', sans-serif;
    font-weight: 800;
    font-size: 20px;
    color: var(--text-primary);
    letter-spacing: 0.5px;
    position: relative;
    z-index: 1;
  }

  .logo-text span { color: var(--teal); }

  .header-time {
    font-size: 13px;
    color: var(--text-secondary);
    text-align: right;
    line-height: 1.6;
    position: relative;
    z-index: 1;
  }

  .header-time strong {
    display: block;
    font-size: 17px;
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: 0.5px;
  }

  /* ──────────────── NAV TABS ──────────────── */
  nav {
    background: rgba(8,18,35,0.88);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    padding: 10px 24px;
    display: flex;
    justify-content: center;
    transition: background 0.35s;
  }
  body.light nav { background: rgba(225,240,255,0.92); }

  .nav-inner {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    scrollbar-width: none;
    background: rgba(6, 15, 30, 0.82);
    backdrop-filter: saturate(160%) blur(24px);
    -webkit-backdrop-filter: saturate(160%) blur(24px);
    border: 1px solid rgba(0,180,216,0.18);
    border-radius: 50px;
    padding: 5px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.07);
    transition: background 0.35s, border-color 0.35s, box-shadow 0.35s;
  }
  body.light .nav-inner {
    background: rgba(255,255,255,0.88);
    border-color: rgba(0,140,200,0.28);
    box-shadow: 0 4px 20px rgba(0,140,200,0.12), inset 0 1px 0 rgba(255,255,255,0.9);
  }

  .nav-inner::-webkit-scrollbar { display: none; }

  .tab-btn {
    padding: 9px 18px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    border-radius: 50px;
    transition: all 0.22s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    position: relative;
  }

  .tab-btn:hover {
    color: var(--text-primary);
    background: rgba(255,255,255,0.06);
  }

  .tab-btn.active {
    color: var(--ocean-deep);
    background: linear-gradient(135deg, var(--teal-bright), var(--green));
    box-shadow: 0 0 18px rgba(0,198,224,0.45), 0 2px 8px rgba(0,0,0,0.3);
    font-weight: 700;
  }

  .tab-btn.active .tab-badge {
    background: rgba(6,15,30,0.35);
    color: #fff;
  }

  .tab-badge {
    background: rgba(0,180,216,0.25);
    color: var(--teal-bright);
    border: 1px solid rgba(0,180,216,0.3);
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 20px;
    min-width: 18px;
    text-align: center;
    transition: all 0.22s;
  }

  /* ──────────────── MAIN LAYOUT ──────────────── */
  main {
    max-width: 1280px;
    margin: 0 auto;
    padding: 24px;
    position: relative;
    z-index: 1;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* ──────────────── CARDS ──────────────── */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 24px;
    backdrop-filter: blur(10px);
    overflow: visible;
  }

  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* ──────────────── GRID ──────────────── */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

  @media (max-width: 900px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 640px) {
    .grid-2 { grid-template-columns: 1fr; }
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: 1fr 1fr; }
    main { padding: 16px; }
  }

  /* ──────────────── INPUTS ──────────────── */
  .form-group { margin-bottom: 16px; }

  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }

  input[type="text"],
  input[type="number"],
  input[type="tel"] {
    width: 100%;
    background: var(--input-bg);
    border: 1px solid rgba(0,180,216,0.25);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }

  input:focus {
    outline: none;
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(0,180,216,0.15);
  }

  input::placeholder { color: var(--text-muted); }

  /* ──────────────── SPECIES GRID ──────────────── */
  .species-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 14px;
    margin-bottom: 20px;
  }

  .species-card {
    background: var(--input-bg);
    border: 1px solid rgba(0,180,216,0.15);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .species-card.has-value {
    border-color: rgba(0,180,216,0.45);
    box-shadow: 0 0 20px rgba(0,180,216,0.08);
  }

  .species-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .species-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-primary);
  }

  .species-price {
    font-size: 12px;
    color: var(--teal);
    font-weight: 600;
    font-family: 'Roboto Mono', monospace;
  }

  .species-inputs {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .species-inputs input {
    flex: 1;
    padding: 8px 12px;
    font-size: 14px;
  }

  /* Custom checkbox */
  .eviscera-label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    white-space: nowrap;
    font-size: 11px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .eviscera-label input[type="checkbox"] { display: none; }

  .custom-check {
    width: 28px; height: 28px;
    border: 2px solid rgba(0,180,216,0.3);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
    font-size: 14px;
  }

  .eviscera-label:has(input:checked) .custom-check {
    background: rgba(6,214,160,0.2);
    border-color: var(--green);
    color: var(--green);
  }

  .eviscera-label:not(:has(input:checked)) .custom-check { color: transparent; }

  .species-subtotal {
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
  }

  .species-subtotal span:last-child {
    color: var(--gold);
    font-weight: 600;
    font-family: 'Roboto Mono', monospace;
  }

  /* ──────────────── TOTAL BOX ──────────────── */
  .total-box {
    background: linear-gradient(135deg, rgba(0,180,216,0.12), rgba(6,214,160,0.08));
    border: 1px solid rgba(0,180,216,0.35);
    border-radius: var(--radius);
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }

  .total-label {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .total-amount {
    font-family: 'Roboto Mono', monospace;
    font-size: 30px;
    font-weight: 700;
    color: var(--teal-bright);
    letter-spacing: -0.5px;
  }

  .total-details {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* ── Pago y devuelta ── */
  .pago-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid rgba(0,180,216,0.15);
  }
  .pago-input-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 180px;
  }
  .pago-input-wrap label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  #pago-input {
    flex: 1;
    padding: 9px 13px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(0,180,216,0.25);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: 'Roboto Mono', monospace;
    font-size: 16px;
    font-weight: 600;
    outline: none;
    transition: all 0.2s;
    max-width: 180px;
  }
  #pago-input:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(0,180,216,0.2);
    background: rgba(0,180,216,0.06);
  }
  .devuelta-box {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
  }
  .devuelta-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
  }
  .devuelta-amount {
    font-family: 'Roboto Mono', monospace;
    font-size: 26px;
    font-weight: 700;
    transition: color 0.2s;
  }
  .devuelta-amount.ok      { color: var(--green); }
  .devuelta-amount.exact   { color: var(--teal-bright); }
  .devuelta-amount.falta   { color: var(--coral); }
  .devuelta-amount.pending { color: var(--text-muted); }

  /* ──────────────── BUTTONS ──────────────── */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 22px;
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--teal), #007ea7);
    color: white;
    box-shadow: 0 4px 16px rgba(0,180,216,0.3);
  }

  .btn-primary:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 24px rgba(0,180,216,0.4);
  }

  .btn-success {
    background: linear-gradient(135deg, var(--green), #05a87e);
    color: var(--text-primary);
    box-shadow: 0 4px 16px rgba(6,214,160,0.25);
  }

  .btn-success:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 24px rgba(6,214,160,0.35);
  }

  .btn-danger {
    background: rgba(239,71,111,0.15);
    color: var(--coral);
    border: 1px solid rgba(239,71,111,0.3);
  }

  .btn-danger:hover { background: rgba(239,71,111,0.25); }

  .btn-whatsapp {
    background: rgba(37,211,102,0.15);
    color: #25d366;
    border: 1px solid rgba(37,211,102,0.3);
    display: inline-flex;
    align-items: center;
    gap: 7px;
  }

  .btn-whatsapp:hover {
    background: rgba(37,211,102,0.25);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(37,211,102,0.2);
  }

  .btn-ghost {
    background: rgba(0,180,216,0.08);
    color: var(--teal);
    border: 1px solid rgba(0,180,216,0.2);
  }

  .btn-ghost:hover { background: rgba(0,180,216,0.15); }

  .btn-sm { padding: 8px 14px; font-size: 13px; }

  .btn-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  /* ──────────────── STAT CARDS ──────────────── */
  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }

  .stat-card.blue::before { background: linear-gradient(90deg, var(--teal), transparent); }
  .stat-card.green::before { background: linear-gradient(90deg, var(--green), transparent); }
  .stat-card.gold::before { background: linear-gradient(90deg, var(--gold), transparent); }
  .stat-card.coral::before { background: linear-gradient(90deg, var(--coral), transparent); }

  .stat-icon {
    font-size: 24px;
    margin-bottom: 12px;
  }

  .stat-value {
    font-family: 'Roboto Mono', monospace;
    font-size: 26px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: 6px;
  }

  .stat-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.7px;
    font-weight: 600;
  }

  /* ──────────────── TABLE ──────────────── */
  .table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius-sm);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  thead th {
    background: rgba(0,180,216,0.08);
    color: var(--text-secondary);
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 12px 14px;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--card-border);
  }

  tbody tr {
    border-bottom: 1px solid rgba(0,180,216,0.06);
    transition: background 0.15s;
  }

  tbody tr:hover { background: rgba(0,180,216,0.04); }
  tbody tr:last-child { border-bottom: none; }

  tbody td {
    padding: 12px 14px;
    color: var(--text-primary);
    vertical-align: top;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }

  .badge-teal { background: rgba(0,180,216,0.15); color: var(--teal); }
  .badge-gold { background: rgba(255,209,102,0.15); color: var(--gold); }

  /* ──────────────── SEARCH ──────────────── */
  .search-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .search-row input {
    flex: 1;
    min-width: 200px;
  }

  /* ──────────────── SECTION SPACING ──────────────── */
  .section { margin-bottom: 24px; }

  /* ──────────────── DIVIDER ──────────────── */
  .divider {
    border: none;
    border-top: 1px solid var(--card-border);
    margin: 20px 0;
  }

  /* ──────────────── TOAST ──────────────── */
  #toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--green);
    color: var(--ocean-deep);
    padding: 12px 20px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    z-index: 9999;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }

  #toast.show { transform: translateY(0); opacity: 1; }
  #toast.error { background: var(--coral); color: white; }

  /* ──────────────── SPECIES SUMMARY TABLE ──────────────── */
  .species-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .bar-label { width: 140px; font-size: 13px; color: var(--text-secondary); flex-shrink: 0; }
  .bar-track { flex: 1; height: 6px; background: rgba(0,180,216,0.1); border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; background: linear-gradient(90deg, var(--teal), var(--green)); border-radius: 3px; transition: width 0.5s; }
  .bar-value { width: 90px; text-align: right; font-size: 12px; color: var(--text-muted); }

  /* ──────────────── EMPTY STATE ──────────────── */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-muted);
  }

  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* ──────────────── MOBILE FIXES ──────────────── */
  @media (max-width: 480px) {
    .species-grid { grid-template-columns: 1fr; }
    .total-amount { font-size: 26px; }
    .stat-value { font-size: 22px; }
    .tab-btn { padding: 8px 12px; font-size: 12px; }
    .btn { padding: 10px 16px; }
    nav { padding: 10px 12px; }
    .nav-inner { padding: 4px; gap: 4px; }
    /* En móvil, ocultar el timer flotante cuando hay botones de acción visibles */
    body.tab-has-actions #ev-float-btn { opacity: 0 !important; pointer-events: none !important; transform: scale(0.7); }
  }

  /* ──────────────── SUMMARY ITEMS ──────────────── */
  .quote-items-preview {
    background: var(--input-bg);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-bottom: 14px;
    font-size: 13px;
  }

  .quote-item-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid rgba(0,180,216,0.06);
  }
  .quote-item-row:last-child { border-bottom: none; }
  .quote-item-row span:first-child { color: var(--text-secondary); }
  .quote-item-row span:last-child { color: var(--text-primary); font-weight: 500; }

  .highlight-row span:last-child { color: var(--gold) !important; font-family: 'Roboto Mono', monospace; }
  .highlight-row.total-row { border-top: 1px solid rgba(0,180,216,0.2); margin-top: 4px; padding-top: 9px; }
  .highlight-row.total-row span:last-child { color: var(--teal-bright) !important; font-size: 15px; font-weight: 700; font-family: 'Roboto Mono', monospace; }
  .quote-item-row span:last-child { font-family: 'Roboto Mono', monospace; }

  /* ──────────────── MODAL EDICIÓN ──────────────── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(5,12,25,0.88);
    backdrop-filter: blur(6px);
    z-index: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--ocean-mid);
    border: 1px solid rgba(0,180,216,0.3);
    border-radius: var(--radius);
    width: 100%;
    max-width: 740px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 60px rgba(0,0,0,0.55);
    transform: translateY(20px);
    transition: transform 0.25s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--card-border);
    flex-shrink: 0;
  }
  .modal-header h3 {
    font-family: 'Syne', sans-serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--teal-pale);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .modal-close {
    width: 32px; height: 32px;
    border: none;
    background: rgba(0,180,216,0.08);
    color: var(--text-secondary);
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    line-height: 1;
  }
  .modal-close:hover { background: rgba(239,71,111,0.15); color: var(--coral); }

  .modal-body {
    padding: 20px 24px;
    overflow-y: auto;
    flex: 1;
  }
  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--card-border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    flex-shrink: 0;
  }

  .edit-section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin: 18px 0 10px;
  }
  .edit-section-title:first-child { margin-top: 0; }

  .edit-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .edit-table th {
    background: rgba(0,180,216,0.07);
    color: var(--text-secondary);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.7px;
    padding: 9px 10px;
    text-align: left;
    border-bottom: 1px solid var(--card-border);
    white-space: nowrap;
  }
  .edit-table td {
    padding: 7px 10px;
    border-bottom: 1px solid rgba(0,180,216,0.05);
    vertical-align: middle;
    color: var(--text-primary);
  }
  .edit-table tr:last-child td { border-bottom: none; }
  .edit-table input[type="number"],
  .edit-table input[type="text"] {
    padding: 6px 9px;
    font-size: 13px;
    width: 100%;
    min-width: 60px;
  }

  .edit-total-bar {
    background: linear-gradient(135deg, rgba(0,180,216,0.1), rgba(6,214,160,0.07));
    border: 1px solid rgba(0,180,216,0.25);
    border-radius: var(--radius-sm);
    padding: 14px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .edit-total-bar .elabel {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.7px;
  }
  .edit-total-bar .evalue {
    font-family: 'Roboto Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--teal-bright);
  }

  .add-item-box {
    background: rgba(0,180,216,0.04);
    border: 1px dashed rgba(0,180,216,0.2);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-top: 14px;
  }
  .add-item-box .add-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.7px;
    margin-bottom: 10px;
  }
  .add-item-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  .add-item-row .fg { flex: 1; min-width: 100px; margin: 0; }
  .add-item-row .fg label { font-size: 10px; margin-bottom: 4px; }

  .btn-icon {
    width: 32px; height: 32px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
    align-self: flex-end;
  }
  .btn-icon.remove { background: rgba(239,71,111,0.12); color: var(--coral); }
  .btn-icon.remove:hover { background: rgba(239,71,111,0.25); }

  @media (max-width: 600px) {
    .modal-body { padding: 14px 16px; }
    .modal-header, .modal-footer { padding: 14px 16px; }
    .edit-table { font-size: 12px; }
    .edit-table th, .edit-table td { padding: 6px 7px; }
  }

  /* ──────────────── FILTRO FECHAS DASHBOARD ──────────────── */
  .filter-bar {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .filter-bar-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .period-btns {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .period-btn {
    padding: 7px 14px;
    border-radius: 20px;
    border: 1px solid rgba(0,180,216,0.2);
    background: transparent;
    color: var(--text-secondary);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .period-btn:hover {
    border-color: rgba(0,180,216,0.5);
    color: var(--teal-pale);
  }

  .period-btn.active {
    background: rgba(0,180,216,0.15);
    border-color: var(--teal);
    color: var(--teal);
    font-weight: 600;
  }

  .date-range-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .date-range-inputs input[type="date"] {
    padding: 7px 12px;
    font-size: 13px;
    width: auto;
    color-scheme: dark;
  }

  .date-range-inputs .sep {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .filter-period-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    flex-shrink: 0;
  }

  .period-pill {
    background: rgba(6,214,160,0.12);
    border: 1px solid rgba(6,214,160,0.25);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
  }

  .stat-sublabel {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 4px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ──────────────── AUTOCOMPLETE NOMBRE ──────────────── */
  .autocomplete-wrap {
    position: relative;
  }

  .autocomplete-list {
    position: fixed;
    background: var(--ocean-mid);
    border: 1px solid rgba(0,180,216,0.3);
    border-radius: var(--radius-sm);
    z-index: 9999;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: none;
    min-width: 240px;
  }

  .autocomplete-list.open { display: block; }

  .autocomplete-item {
    padding: 10px 14px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.15s;
    border-bottom: 1px solid rgba(0,180,216,0.06);
  }

  .autocomplete-item:last-child { border-bottom: none; }

  .autocomplete-item:hover,
  .autocomplete-item.selected {
    background: rgba(0,180,216,0.1);
  }

  .autocomplete-item .ac-name { flex: 1; font-weight: 500; }

  .autocomplete-item .ac-tel {
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'Roboto Mono', monospace;
  }

  .autocomplete-item .ac-count {
    font-size: 11px;
    background: rgba(0,180,216,0.12);
    color: var(--teal);
    border-radius: 10px;
    padding: 2px 7px;
    font-weight: 600;
  }

  /* ──────────────── EVISCERADO SECTION ──────────────── */
  .ev-section-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin: 0 0 14px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .ev-section-title .ev-count {
    background: rgba(0,180,216,0.12);
    color: var(--teal);
    border-radius: 12px;
    padding: 2px 10px;
    font-size: 12px;
    font-weight: 700;
  }
  .ev-section-title.done-title .ev-count {
    background: rgba(6,214,160,0.1);
    color: var(--green);
  }
  .ev-divider { height: 1px; background: var(--card-border); margin: 28px 0 20px; }
  .ev-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
  }
  .ev-card {
    background: var(--card-bg);
    border: 1px solid rgba(0,180,216,0.25);
    border-radius: var(--radius);
    padding: 24px 26px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .ev-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 5px; height: 100%;
    background: var(--teal);
    border-radius: 4px 0 0 4px;
  }
  .ev-card.done { border-color: rgba(6,214,160,0.2); opacity: 0.72; }
  .ev-card.done::before { background: var(--green); }
  .ev-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
  }
  .ev-card-name {
    font-family: 'Syne', sans-serif;
    font-size: 19px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
  }
  .ev-card-meta { font-size: 12px; color: var(--text-muted); margin-top: 5px; font-family: 'Roboto Mono', monospace; }
  .ev-card-time { font-size: 12px; color: var(--text-muted); white-space: nowrap; flex-shrink: 0; text-align: right; }
  .ev-card-body { display: flex; flex-direction: column; gap: 8px; }
  .ev-card-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
  }
  .ev-card-row .label { color: var(--text-muted); font-size: 13px; }
  .ev-card-row .val { font-family: 'Roboto Mono', monospace; font-weight: 600; color: var(--teal-pale); }
  .ev-card-row .val.big { font-size: 26px; color: var(--teal); }
  .ev-species-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .ev-species-pill {
    background: rgba(0,180,216,0.1);
    border: 1px solid rgba(0,180,216,0.2);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 12px;
    color: var(--teal-pale);
    font-weight: 500;
  }
  .ev-card-footer { display: flex; gap: 10px; margin-top: 6px; }
  .btn-ev-done {
    flex: 1;
    padding: 13px;
    background: rgba(6,214,160,0.12);
    border: 1px solid rgba(6,214,160,0.3);
    border-radius: var(--radius-sm);
    color: var(--green);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
  }
  .btn-ev-done:hover { background: rgba(6,214,160,0.22); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(6,214,160,0.2); }
  .btn-ev-undo {
    padding: 13px 16px;
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-ev-undo:hover { border-color: rgba(0,180,216,0.3); color: var(--text-secondary); }
  .ev-done-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(6,214,160,0.1);
    border: 1px solid rgba(6,214,160,0.25);
    border-radius: 20px;
    padding: 5px 14px;
    font-size: 12px;
    font-weight: 600;
    color: var(--green);
    width: 100%;
    justify-content: center;
  }
  .ev-empty { text-align: center; padding: 32px 20px; color: var(--text-muted); font-size: 14px; }
  .ev-empty .icon { font-size: 36px; margin-bottom: 10px; }
  @media (max-width: 600px) { .ev-cards-grid { grid-template-columns: 1fr; } }

  /* ──────────────── MAYORISTA ──────────────── */
  .may-species-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-sm);
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: all 0.2s;
  }
  .may-species-card.has-value {
    border-color: rgba(0,198,160,0.45);
    background: rgba(0,198,160,0.05);
    box-shadow: 0 0 14px rgba(0,198,160,0.1);
  }
  .may-species-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .may-species-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
  }
  .may-species-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .may-input-wrap {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  .may-input-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
  }
  .may-input-wrap input {
    padding: 7px 10px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: 'Roboto Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: all 0.2s;
    width: 100%;
    box-sizing: border-box;
  }
  .may-input-wrap input:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(0,180,216,0.15);
  }
  .may-subtotal {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-muted);
    padding-top: 6px;
    border-top: 1px solid rgba(0,180,216,0.08);
  }
  .may-subtotal span:last-child {
    font-family: 'Roboto Mono', monospace;
    font-weight: 600;
    color: var(--green);
  }

  /* Desglose detal/mayorista en dashboard */
  .dash-desglose {
    display: flex;
    gap: 8px;
    margin-top: 6px;
    flex-wrap: wrap;
  }
  .dash-pill-detal {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    background: rgba(0,180,216,0.12);
    border: 1px solid rgba(0,180,216,0.25);
    color: var(--teal-bright);
    font-weight: 600;
  }
  .dash-pill-mayor {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    background: rgba(6,214,160,0.12);
    border: 1px solid rgba(6,214,160,0.25);
    color: var(--green);
    font-weight: 600;
  }
  .clientes-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 14px;
    align-items: end;
  }
  @media (max-width: 800px) {
    .clientes-form-row { grid-template-columns: 1fr 1fr; }
    .clientes-form-row .form-group-btn { grid-column: 1 / -1; }
  }
  @media (max-width: 500px) {
    .clientes-form-row { grid-template-columns: 1fr; }
  }
  .form-group-btn { display: flex; align-items: flex-end; }
  .form-group-btn .btn { width: 100%; justify-content: center; }

  .cli-compras-badge {
    display: inline-flex; align-items: center; gap: 5px;
    background: rgba(0,180,216,0.10);
    border: 1px solid rgba(0,180,216,0.20);
    color: var(--teal-bright);
    border-radius: 20px; padding: 2px 10px;
    font-size: 12px; font-weight: 700;
  }
  .cli-compras-badge.cero {
    background: rgba(255,255,255,0.04);
    border-color: var(--card-border);
    color: var(--text-muted);
  }
  .cli-total {
    font-family: 'Roboto Mono', monospace;
    font-size: 13px; font-weight: 600;
    color: var(--green);
  }
  .cli-total.cero { color: var(--text-muted); font-weight: 400; }
  .cli-origen {
    font-size: 11px; color: var(--text-muted);
    display: inline-flex; align-items: center; gap: 4px;
  }

  /* Fila clickeable */
  #clientes-tbody tr {
    cursor: pointer;
    transition: background 0.15s;
  }
  #clientes-tbody tr:hover { background: rgba(0,180,216,0.05); }

  /* ──────────────── PERFIL DE CLIENTE ──────────────── */
  #cli-profile-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    z-index: 500;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  #cli-profile-overlay.open { opacity: 1; pointer-events: all; }

  #cli-profile-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: min(460px, 100vw);
    background: var(--surface);
    border-left: 1px solid var(--card-border);
    z-index: 501;
    display: flex; flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(.4,0,.2,1);
    overflow: hidden;
  }
  #cli-profile-panel.open { transform: translateX(0); }

  .profile-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--card-border);
    display: flex; align-items: flex-start; gap: 14px;
    background: rgba(6,15,30,0.6);
    flex-shrink: 0;
  }
  .profile-avatar {
    width: 52px; height: 52px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; flex-shrink: 0;
    border: 2px solid rgba(0,180,216,0.3);
  }
  .profile-avatar.masculino  { background: rgba(0,120,255,0.12); border-color: rgba(0,120,255,0.3); }
  .profile-avatar.femenino   { background: rgba(255,80,150,0.12); border-color: rgba(255,80,150,0.3); }
  .profile-avatar.otro       { background: rgba(0,180,216,0.12); }

  .profile-name-block { flex: 1; min-width: 0; }
  .profile-name {
    font-size: 17px; font-weight: 800;
    color: var(--text-primary); margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .profile-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 10px; flex-wrap: wrap; }

  .profile-status {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 4px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
    cursor: pointer; border: 1px solid transparent;
    transition: all 0.2s; margin-top: 6px;
    user-select: none;
  }
  .profile-status.activo {
    background: rgba(6,214,160,0.12);
    border-color: rgba(6,214,160,0.3);
    color: var(--green);
  }
  .profile-status.vetado {
    background: rgba(255,82,82,0.12);
    border-color: rgba(255,82,82,0.3);
    color: var(--coral);
  }

  .profile-close-btn {
    background: none; border: none; cursor: pointer;
    color: var(--text-muted); font-size: 20px; padding: 4px;
    line-height: 1; transition: color 0.15s; flex-shrink: 0;
  }
  .profile-close-btn:hover { color: var(--text-primary); }

  .profile-body {
    flex: 1; overflow-y: auto; padding: 20px 24px;
    display: flex; flex-direction: column; gap: 20px;
  }
  .profile-body::-webkit-scrollbar { width: 4px; }
  .profile-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

  .profile-section-title {
    font-size: 10px; font-weight: 800; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text-muted);
    margin-bottom: 10px;
  }

  .profile-info-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  }
  .profile-info-item {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
  }
  .profile-info-item.full { grid-column: 1/-1; }
  .profile-info-label { font-size: 10px; color: var(--text-muted); font-weight: 600; margin-bottom: 3px; }
  .profile-info-value {
    font-size: 13px; font-weight: 600; color: var(--text-primary);
    word-break: break-word;
  }
  .profile-info-value.mono { font-family: 'Roboto Mono', monospace; font-size: 12px; }
  .profile-info-value.muted { color: var(--text-muted); font-weight: 400; }

  /* Top 3 especies */
  .top-especies { display: flex; flex-direction: column; gap: 8px; }
  .top-especie-row {
    display: flex; align-items: center; gap: 10px;
  }
  .top-especie-rank {
    width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 800; flex-shrink: 0;
  }
  .rank-1 { background: rgba(255,200,0,0.18); color: #ffc800; border: 1px solid rgba(255,200,0,0.3); }
  .rank-2 { background: rgba(180,180,180,0.15); color: #b0b0b0; border: 1px solid rgba(180,180,180,0.25); }
  .rank-3 { background: rgba(180,100,40,0.15); color: #cd7f32; border: 1px solid rgba(180,100,40,0.25); }

  .top-especie-info { flex: 1; min-width: 0; }
  .top-especie-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
  .top-especie-bar-track {
    height: 4px; background: rgba(0,180,216,0.1);
    border-radius: 2px; margin-top: 4px; overflow: hidden;
  }
  .top-especie-bar-fill {
    height: 100%; border-radius: 2px;
    background: linear-gradient(90deg, var(--teal), var(--green));
    transition: width 0.5s;
  }
  .top-especie-lb { font-size: 11px; color: var(--text-muted); font-family: 'Roboto Mono', monospace; flex-shrink: 0; }

  /* Indicador eviscerado */
  .ev-indicator {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 600;
  }
  .ev-indicator.yes {
    background: rgba(0,180,216,0.08);
    border: 1px solid rgba(0,180,216,0.2);
    color: var(--teal-bright);
  }
  .ev-indicator.no {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--card-border);
    color: var(--text-muted);
  }

  /* Campos editables del perfil */
  .profile-edit-field {
    display: flex; flex-direction: column; gap: 5px;
  }
  .profile-edit-field label {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.6px; color: var(--text-muted);
  }
  .profile-edit-field input,
  .profile-edit-field select,
  .profile-edit-field textarea {
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px; padding: 8px 12px;
    outline: none; transition: border-color 0.2s;
    width: 100%; box-sizing: border-box;
  }
  .profile-edit-field input:focus,
  .profile-edit-field select:focus,
  .profile-edit-field textarea:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(0,180,216,0.12);
  }
  .profile-edit-field textarea { resize: vertical; min-height: 72px; }
  .profile-edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .profile-edit-grid .full { grid-column: 1/-1; }

  .profile-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--card-border);
    display: flex; gap: 10px; justify-content: flex-end;
    flex-shrink: 0;
    background: rgba(6,15,30,0.6);
  }

  @media (max-width: 480px) {
    #cli-profile-panel { width: 100vw; }
    .profile-edit-grid { grid-template-columns: 1fr; }
    .profile-info-grid { grid-template-columns: 1fr; }
  }

  /* ════════════════════════════════════════
     MODO CLARO — overrides
  ════════════════════════════════════════ */
  body.light .card {
    box-shadow: 0 2px 16px rgba(0,100,180,0.08);
  }
  body.light .total-box {
    background: rgba(255,255,255,0.92);
    border-color: rgba(0,140,200,0.2);
    box-shadow: 0 4px 24px rgba(0,140,200,0.1);
  }
  body.light .stat-card {
    box-shadow: 0 2px 16px rgba(0,100,180,0.08);
  }
  body.light .tab-btn { color: var(--text-muted); }
  body.light .tab-btn:hover { color: var(--text-secondary); background: rgba(0,140,200,0.08); }
  body.light .tab-btn.active {
    color: #fff;
    background: linear-gradient(135deg, var(--teal), var(--green));
    box-shadow: 0 0 14px rgba(0,180,216,0.35), 0 2px 6px rgba(0,0,0,0.12);
  }
  body.light .tab-badge {
    background: rgba(0,140,200,0.15);
    color: var(--teal);
    border-color: rgba(0,140,200,0.25);
  }
  body.light .filter-bar { background: rgba(255,255,255,0.88); }
  body.light .period-btn { color: var(--text-secondary); border-color: rgba(0,140,200,0.2); }
  body.light .period-btn.active { background: rgba(0,140,200,0.12); border-color: var(--teal); color: var(--teal); }
  body.light select option { background: #fff; color: #0d1f3c; }
  body.light .ev-card { border-color: rgba(0,140,200,0.22); background: rgba(255,255,255,0.9); }
  body.light .ev-card::before { background: var(--teal); }
  body.light .modal { background: #ffffff; border-color: rgba(0,140,200,0.2); }
  body.light .modal-header { background: rgba(235,246,255,0.95); border-color: rgba(0,140,200,0.15); }
  body.light .modal-footer { background: rgba(235,246,255,0.95); border-color: rgba(0,140,200,0.15); }
  body.light #cli-profile-panel { background: #f8fbff; border-color: rgba(0,140,200,0.18); }
  body.light .profile-header { background: rgba(225,242,255,0.9); border-color: rgba(0,140,200,0.15); }
  body.light .profile-footer { background: rgba(225,242,255,0.9); border-color: rgba(0,140,200,0.15); }
  body.light .profile-info-item { background: rgba(235,248,255,0.9); border-color: rgba(0,140,200,0.14); }
  body.light #cli-profile-overlay { background: rgba(10,40,80,0.4); }
  body.light .quote-items-preview { background: rgba(235,248,255,0.8); }
  body.light .quote-item-row { border-color: rgba(0,140,200,0.1); }
  body.light .table-wrapper table th { color: var(--text-muted); border-color: rgba(0,140,200,0.12); }
  body.light .table-wrapper table td { border-color: rgba(0,140,200,0.08); }
  body.light .table-wrapper table tr:hover td { background: rgba(0,140,200,0.05); }
  body.light .autocomplete-list { background: #fff; border-color: rgba(0,140,200,0.25); box-shadow: 0 8px 24px rgba(0,100,180,0.12); }
  body.light .ac-item:hover { background: rgba(0,140,200,0.08); }
  body.light .toast { background: #0d2240; }
  body.light .may-species-card { background: rgba(235,248,255,0.85); border-color: rgba(0,140,200,0.18); }
  body.light .may-species-card.has-value { background: rgba(6,214,160,0.07); border-color: rgba(6,214,160,0.35); }
  body.light .species-card { background: rgba(235,248,255,0.85); border-color: rgba(0,140,200,0.18); }
  body.light .species-card.has-value { background: rgba(6,214,160,0.07); border-color: rgba(6,214,160,0.35); }
  body.light .ev-species-pill { background: rgba(0,140,200,0.1); border-color: rgba(0,140,200,0.22); }
  body.light .drive-status-bar { border-color: rgba(0,140,200,0.3); color: var(--text-secondary); }
  body.light .drive-dot { background: var(--text-muted); }
  body.light .drive-status-bar.connected { border-color: rgba(6,214,160,0.45); color: var(--green); }
  body.light .clientes-form-row .form-group { background: transparent; }

  /* ──── Botón toggle de tema ──── */
  #theme-toggle {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 300;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.3s cubic-bezier(.4,0,.2,1);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  body:not(.light) #theme-toggle {
    background: rgba(13,34,64,0.9);
    border: 1px solid rgba(0,180,216,0.35);
    color: #ffd166;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 12px rgba(255,209,102,0.15);
  }
  body.light #theme-toggle {
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(0,140,200,0.3);
    color: var(--teal);
    box-shadow: 0 4px 20px rgba(0,100,180,0.15);
  }
  #theme-toggle:hover { transform: scale(1.1) rotate(15deg); }

  /* ──────────────── BOTÓN FLOTANTE EV COUNTDOWN ──────────────── */
  #ev-float-btn {
    position: fixed;
    bottom: 24px;
    left: 24px;      /* lado izquierdo — lejos de los botones de acción */
    z-index: 300;
    min-width: 48px;
    height: 48px;
    border-radius: 28px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 0 14px;
    font-family: 'Roboto Mono', monospace;
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 0.3px;
    transition: all 0.3s cubic-bezier(.4,0,.2,1);
    user-select: none;
    white-space: nowrap;
  }
  /* Estado: hay pendientes */
  #ev-float-btn.pending {
    background: rgba(13,34,64,0.92);
    border: 1px solid rgba(255,209,102,0.45);
    color: var(--gold);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 14px rgba(255,209,102,0.18);
  }
  body.light #ev-float-btn.pending {
    background: rgba(255,255,255,0.96);
    border: 1px solid rgba(220,160,0,0.4);
    color: #b07a00;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 0 10px rgba(220,160,0,0.1);
  }
  /* Estado: urgente (>30 min pendientes) */
  #ev-float-btn.urgent {
    background: rgba(80,10,20,0.92);
    border: 1px solid rgba(239,71,111,0.6);
    color: var(--coral);
    box-shadow: 0 4px 20px rgba(0,0,0,0.45), 0 0 14px rgba(239,71,111,0.25);
    animation: floatPulse 2s infinite;
  }
  body.light #ev-float-btn.urgent {
    background: rgba(255,240,242,0.97);
    border-color: rgba(239,71,111,0.5);
    color: var(--coral);
  }
  /* Estado: todo listo */
  #ev-float-btn.done {
    background: rgba(6,40,30,0.88);
    border: 1px solid rgba(6,214,160,0.45);
    color: var(--green);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 14px rgba(6,214,160,0.18);
  }
  body.light #ev-float-btn.done {
    background: rgba(240,255,250,0.97);
    border-color: rgba(6,214,160,0.4);
    color: #048a62;
  }
  /* Estado oculto cuando no hay órdenes de eviscerado */
  #ev-float-btn.hidden { opacity: 0; pointer-events: none; transform: scale(0.7); }

  #ev-float-btn:hover:not(.hidden) { transform: scale(1.06) translateY(-2px); }

  @keyframes floatPulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(0,0,0,0.45), 0 0 14px rgba(239,71,111,0.25); }
    50%       { box-shadow: 0 4px 24px rgba(0,0,0,0.5),  0 0 22px rgba(239,71,111,0.45); }
  }

  /* ──────────────── CHART 15 DÍAS ──────────────── */
  .chart-card { overflow: hidden; }
  .chart-wrap {
    position: relative;
    width: 100%;
    height: 220px;
  }
  .chart-wrap canvas { display: block; }
  .chart-legend {
    display: flex; gap: 16px; flex-wrap: wrap;
    margin-top: 12px; margin-bottom: 4px;
  }
  .chart-legend-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; color: var(--text-secondary);
  }
  .chart-legend-dot {
    width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0;
  }

  /* ──────────────── EV TIMING ──────────────── */
  /* Chip de tiempo en cada tarjeta de eviscerado pendiente */
  .ev-timer-chip {
    display: inline-flex; align-items: center; gap: 5px;
    font-family: 'Roboto Mono', monospace;
    font-size: 11px; font-weight: 700;
    padding: 3px 10px; border-radius: 20px;
    border: 1px solid rgba(255,209,102,0.3);
    background: rgba(255,209,102,0.08);
    color: var(--gold);
  }
  .ev-timer-chip.urgent {
    border-color: rgba(239,71,111,0.4);
    background: rgba(239,71,111,0.08);
    color: var(--coral);
    animation: chipPulse 1.5s infinite;
  }
  @keyframes chipPulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.6; }
  }
  /* Tiempo real en tarjetas completadas */
  .ev-done-time {
    font-size: 11px; color: var(--green);
    font-family: 'Roboto Mono', monospace;
    text-align: center; margin-top: 6px;
    opacity: 0.8;
  }

  /* Estimador global */
  .ev-estimador {
    background: var(--card-bg);
    border: 1px solid rgba(255,209,102,0.25);
    border-radius: var(--radius);
    padding: 18px 22px;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
  }
  .ev-estimador-icon { font-size: 28px; flex-shrink: 0; }
  .ev-estimador-body { flex: 1; min-width: 0; }
  .ev-estimador-title {
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 6px;
  }
  .ev-estimador-hora {
    font-size: 22px; font-weight: 800;
    font-family: 'Roboto Mono', monospace;
    color: var(--gold); line-height: 1;
  }
  .ev-estimador-countdown {
    font-size: 13px; color: var(--text-secondary);
    margin-top: 4px;
  }
  .ev-estimador-countdown strong { color: var(--teal-bright); }
  .ev-estimador-basis {
    font-size: 11px; color: var(--text-muted); margin-top: 4px;
  }
  .ev-estimador.sin-datos {
    border-color: var(--card-border);
    opacity: 0.7;
  }
  .ev-estimador.listo {
    border-color: rgba(6,214,160,0.35);
    background: rgba(6,214,160,0.05);
  }
  .ev-estimador.listo .ev-estimador-hora { color: var(--green); }

  body.light .ev-estimador { background: rgba(255,255,255,0.9); }
  body.light .ev-timer-chip { background: rgba(255,209,102,0.12); }
</style>
</head>
<body>

<!-- Botón toggle modo claro/oscuro -->
<button id="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">☀️</button>

<!-- Botón flotante countdown eviscerado -->
<button id="ev-float-btn" class="hidden" onclick="showTab('eviscerado')" title="Ver órdenes de eviscerado">
  🔪 <span id="ev-float-text">—</span>
</button>

<div id="top-bar">
<header>
  <!-- Pez nadador libre -->
  <span id="fish-swimmer">🐠</span>

  <div class="header-inner">
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start;position:relative;z-index:1">
      <a class="logo" href="#">
        <span class="logo-text">LAGOS LA ISABELA</span>
      </a>
      <button class="drive-status-bar" id="drive-status-btn" onclick="openSetupModal()">
        <span class="drive-dot"></span>
        <span id="drive-status-text">CONECTAR</span>
      </button>
    </div>
    <div class="header-time" style="position:relative;z-index:1;margin-left:auto;text-align:right">
      <strong id="clock-time">--:--:--</strong>
      <span id="clock-date">-- de --- de ----</span>
    </div>
  </div>
</header>

<nav>
  <div class="nav-inner">
    <button class="tab-btn active" onclick="showTab('cotizar')" data-tab="cotizar">
      📋 Nueva Orden
    </button>
    <button class="tab-btn" onclick="showTab('mayorista')" data-tab="mayorista">
      📦 Mayorista
      <span class="tab-badge" id="badge-mayorista">0</span>
    </button>
    <button class="tab-btn" onclick="showTab('historial')" data-tab="historial">
      🗂️ Historial
      <span class="tab-badge" id="badge-count">0</span>
    </button>
    <button class="tab-btn" onclick="showTab('eviscerado')" data-tab="eviscerado">
      🔪 Eviscerado
      <span class="tab-badge" id="badge-ev">0</span>
    </button>
    <button class="tab-btn" onclick="showTab('clientes')" data-tab="clientes">
      👥 Clientes
      <span class="tab-badge" id="badge-clientes">0</span>
    </button>
    <button class="tab-btn" onclick="showTab('dashboard')" data-tab="dashboard">
      📊 Dashboard
    </button>
  </div>
</nav>
</div>

<main>

  <!-- ══════════════ PÁGINA: COTIZAR ══════════════ -->
  <div class="page active" id="page-cotizar">

    <!-- Datos del Cliente -->
    <div class="card section">
      <div class="card-title"> 🧜🏻‍♂️Datos del Cliente</div>
      <div class="grid-2">
        <div class="form-group" style="margin:0">
          <label>Nombre completo</label>
          <div class="autocomplete-wrap" id="ac-anchor">
            <input type="text" id="cliente-nombre" placeholder="Ej: Pepe Gomez"
              oninput="acNombre(this.value)"
              onkeydown="acKeydown(event)"
              onfocus="acNombre(this.value)"
              autocomplete="off">
          </div>
        </div>
        <div class="form-group" style="margin:0">
          <label>Celular</label>
          <div id="ac-tel-anchor">
            <input type="tel" id="cliente-tel" placeholder="Ej: 3165266913"
              oninput="acTel(this.value)"
              onkeydown="acTelKeydown(event)"
              onfocus="acTel(this.value)"
              autocomplete="off">
          </div>
        </div>
        <div class="form-group" style="margin:0;grid-column:1/-1">
          <label>identificación (CC / NIT)</label>
          <div id="ac-cc-anchor">
            <input type="text" id="cliente-cc" placeholder="Ej: 66656526"
              oninput="acCC(this.value)"
              onkeydown="acCCKeydown(event)"
              onfocus="acCC(this.value)"
              autocomplete="off"
              style="max-width:320px">
          </div>
        </div>
      </div>
    </div>

    <!-- Especies -->
    <div class="card section">
      <div class="card-title">🐟 Especies y Cantidades</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px;">Ingresa la cantidad en libras por especie. Activa el checkbox 🔪 para cobrar eviscerado (+$500/lb).</p>

      <div class="species-grid" id="species-grid">
        <!-- generado por JS -->
      </div>
    </div>

    <!-- Total -->
    <div class="section">
      <div class="total-box">
        <div>
          <div class="text-primary">TOTAL</div>
          <div class="total-amount" id="total-display">$0</div>
          <div class="total-details" id="total-details">— libras · Eviscerado: $0</div>
          <!-- Pago y devuelta -->
          <div class="pago-row">
            <div class="pago-input-wrap">
              <label>💵 Pago con</label>
              <input type="number" id="pago-input" placeholder="0" min="0" oninput="calcDevuelta()" onfocus="this.select()">
            </div>
            <div class="devuelta-box">
              <span class="devuelta-label">Devuelta</span>
              <span class="devuelta-amount pending" id="devuelta-display">—</span>
            </div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="resetForm()">✨ Limpiar</button>
          <button class="btn btn-success" onclick="guardarOrden()">💵 Cobrar</button>
        </div>
      </div>
    </div>

  </div><!-- /cotizar -->

  <!-- ══════════════ PÁGINA: HISTORIAL ══════════════ -->
  <div class="page" id="page-historial">

    <div class="card section">
      <div class="card-title">🔍 Buscar Ordenes</div>
      <div class="search-row">
        <input type="text" id="search-nombre" placeholder="Buscar por nombre…" oninput="filtrarHistorial()">
        <input type="tel" id="search-tel" placeholder="Buscar por celular…" oninput="filtrarHistorial()">
        <input type="text" id="search-cc" placeholder="Buscar por identificación…" oninput="filtrarHistorial()">
        <button class="btn btn-ghost btn-sm" onclick="exportarExcel()">📥 Exportar Excel</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">📂 Registro de Ordenes</div>
      <div class="table-wrapper">
        <table id="historial-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Identificación</th>
              <th>Celular</th>
              <th>Especies</th>
              <th>Libras</th>
              <th>Eviscerado</th>
              <th>Total</th>
              <th>Pago</th>
              <th>Devuelta</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="historial-tbody">
            <!-- dinámico -->
          </tbody>
        </table>
        <div class="empty-state" id="historial-empty">
          <div class="icon">📭</div>
          <p>No hay ordenes guardadas todavía.<br>¡Crea tu primera orden!</p>
        </div>
      </div>
    </div>

  </div><!-- /historial -->

  <!-- ══════════════ PÁGINA: DASHBOARD ══════════════ -->
  <div class="page" id="page-dashboard">

    <!-- Barra de filtro -->
    <div class="filter-bar">
      <span class="filter-bar-label">📅 Periodo</span>
      <div class="period-btns">
        <button class="period-btn active" onclick="setPeriod('today')"    data-period="today">Hoy</button>
        <button class="period-btn"        onclick="setPeriod('week')"     data-period="week">Esta semana</button>
        <button class="period-btn"        onclick="setPeriod('month')"    data-period="month">Este mes</button>
        <button class="period-btn"        onclick="setPeriod('all')"      data-period="all">Todo</button>
        <button class="period-btn"        onclick="setPeriod('custom')"   data-period="custom">Rango</button>
      </div>
      <div class="date-range-inputs" id="custom-range" style="display:none">
        <input type="date" id="date-desde" onchange="applyCustomRange()">
        <span class="sep">→</span>
        <input type="date" id="date-hasta" onchange="applyCustomRange()">
      </div>
      <div class="filter-period-indicator">
        <span class="period-pill" id="period-pill">Hoy</span>
      </div>
    </div>

    <!-- Stats principales -->
    <div class="grid-4 section" id="stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon">🛒</div>
        <div class="stat-value" id="stat-total-cot">0</div>
        <div class="stat-label">Ordenes</div>
        <div class="stat-sublabel" id="stat-period-label-1">—</div>
      </div>
      <div class="stat-card green">
        <div class="stat-icon">💵</div>
        <div class="stat-value" id="stat-ventas-dia">$0</div>
        <div class="stat-label">Ventas</div>
        <div class="stat-sublabel" id="stat-period-label-2">—</div>
        <div class="dash-desglose" id="stat-desglose-ventas"></div>
      </div>
      <div class="stat-card gold">
        <div class="stat-icon">⚖️</div>
        <div class="stat-value" id="stat-libras-dia">0 lb</div>
        <div class="stat-label">Libras</div>
        <div class="stat-sublabel" id="stat-period-label-3">—</div>
        <div class="dash-desglose" id="stat-desglose-libras"></div>
      </div>
      <div class="stat-card coral">
        <div class="stat-icon">🔪</div>
        <div class="stat-value" id="stat-eviscerado">$0</div>
        <div class="stat-label">Eviscerado</div>
        <div class="stat-sublabel" id="stat-period-label-4">—</div>
      </div>
    </div>

    <!-- Gráfico 15 días -->
    <div class="card section chart-card">
      <div class="card-title">📈 Ventas — Últimos 15 días</div>
      <div class="chart-legend">
        <div class="chart-legend-item">
          <div class="chart-legend-dot" style="background:var(--teal)"></div><span>Detal</span>
        </div>
        <div class="chart-legend-item">
          <div class="chart-legend-dot" style="background:var(--green)"></div><span>Mayorista</span>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="chart-15dias"></canvas></div>
    </div>

    <div class="grid-2">
      <!-- Ventas por especie -->
      <div class="card">
        <div class="card-title">🐠 Ventas por Especie <span id="species-period-tag" style="font-size:11px;font-weight:500;color:var(--text-muted);margin-left:6px"></span></div>
        <div id="species-stats">
          <div class="empty-state" style="padding:24px">
            <p>Sin datos de ventas</p>
          </div>
        </div>
      </div>

      <!-- Resumen financiero -->
      <div class="card">
        <div class="card-title">💰 Resumen Financiero <span id="finance-period-tag" style="font-size:11px;font-weight:500;color:var(--text-muted);margin-left:6px"></span></div>
        <div id="financial-summary">
          <div class="quote-items-preview">
            <div class="quote-item-row"><span>Total ordenes detal</span><span id="fs-total-cot">0</span></div>
            <div class="quote-item-row"><span>Libras detal</span><span id="fs-libras">0 lb</span></div>
            <div class="quote-item-row"><span>Ingresos por pescado</span><span id="fs-pescado">$0</span></div>
            <div class="quote-item-row highlight-row"><span>Ingresos por eviscerado</span><span id="fs-eviscerado">$0</span></div>
            <div class="quote-item-row highlight-row total-row"><span>Total detal</span><span id="fs-total">$0</span></div>
            <!-- Filas mayorista (se ocultan si no hay datos) -->
            <div id="fs-mayorista" style="display:none">
              <div class="quote-item-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(6,214,160,0.2)">
                <span style="color:var(--green);font-weight:600">Ventas mayoristas</span>
                <span id="fs-may-count" style="color:var(--green);font-weight:600">0</span>
              </div>
              <div class="quote-item-row"><span>Libras mayorista</span><span id="fs-may-libras">0 lb</span></div>
              <div class="quote-item-row highlight-row"><span>Total mayorista</span><span id="fs-may-total" style="color:var(--green)">$0</span></div>
            </div>
            <div id="fs-total-combinado" style="display:none">
              <div class="quote-item-row highlight-row total-row" style="border-top:2px solid rgba(0,180,216,0.3);margin-top:4px">
                <span style="font-size:14px">TOTAL GENERAL</span>
                <span id="fs-gran-total" style="font-size:15px">$0</span>
              </div>
            </div>
            <!-- Cuando no hay mayorista, mostrar el total único -->
          </div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="clearAllData()" style="margin-top:8px">🗑 Borrar todo el historial</button>
      </div>
    </div>

  </div><!-- /dashboard -->

  <!-- ══════════════ PÁGINA: EVISCERADO ══════════════ -->
  <div class="page" id="page-eviscerado">

    <div class="card section">
      <div class="card-title">🔪 Órdenes con Eviscerado</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:0">Ordenes que incluyen servicio de eviscerado. Márcalas como completadas una vez procesadas.</p>
    </div>

    <!-- Filtro fechas eviscerado -->
    <div class="filter-bar">
      <span class="filter-bar-label">📅 Período</span>
      <div class="period-btns">
        <button class="period-btn active" onclick="setEvPeriod('all')"    data-evperiod="all">Todo</button>
        <button class="period-btn"        onclick="setEvPeriod('today')"  data-evperiod="today">Hoy</button>
        <button class="period-btn"        onclick="setEvPeriod('week')"   data-evperiod="week">Esta semana</button>
        <button class="period-btn"        onclick="setEvPeriod('month')"  data-evperiod="month">Este mes</button>
        <button class="period-btn"        onclick="setEvPeriod('custom')" data-evperiod="custom">Rango…</button>
      </div>
      <div class="date-range-inputs" id="ev-custom-range" style="display:none">
        <input type="date" id="ev-date-desde" onchange="applyEvCustomRange()">
        <span class="sep">→</span>
        <input type="date" id="ev-date-hasta" onchange="applyEvCustomRange()">
      </div>
      <div class="filter-period-indicator">
        <span class="period-pill" id="ev-period-pill">Todo</span>
      </div>
    </div>

    <!-- Estimador de finalización -->
    <div class="ev-estimador sin-datos" id="ev-estimador">
      <div class="ev-estimador-icon" id="ev-est-icon">⏱️</div>
      <div class="ev-estimador-body">
        <div class="ev-estimador-title">Estimado de finalización</div>
        <div class="ev-estimador-hora" id="ev-est-hora">—</div>
        <div class="ev-estimador-countdown" id="ev-est-countdown">Sin órdenes pendientes</div>
        <div class="ev-estimador-basis" id="ev-est-basis"></div>
      </div>
    </div>

    <!-- Pendientes -->
    <div class="section" id="ev-pendientes-wrap">
      <div class="ev-section-title">
        ⏳ Pendientes
        <span class="ev-count" id="ev-badge-pendientes">0</span>
      </div>
      <div class="ev-cards-grid" id="ev-cards-pendientes"></div>
      <div class="ev-empty" id="ev-empty-pendientes" style="display:none">
        <div class="icon">✅</div>
        <p>¡Todas las órdenes han sido procesadas!</p>
      </div>
    </div>

    <div class="ev-divider"></div>

    <!-- Completadas -->
    <div class="section" id="ev-completadas-wrap">
      <div class="ev-section-title done-title">
        ✅ Completadas
        <span class="ev-count" id="ev-badge-completadas">0</span>
      </div>
      <div class="ev-cards-grid" id="ev-cards-completadas"></div>
      <div class="ev-empty" id="ev-empty-completadas" style="display:none">
        <div class="icon">🔪</div>
        <p>Aún no hay órdenes procesadas.</p>
      </div>
    </div>

  </div><!-- /eviscerado -->

  <!-- ══════════════ PÁGINA: CLIENTES ══════════════ -->
  <div class="page" id="page-clientes">

    <!-- Formulario agregar cliente -->
    <div class="card section">
      <div class="card-title">➕ Agregar Cliente</div>
      <div class="clientes-form-row">
        <div class="form-group">
          <label>Nombre completo</label>
          <input type="text" id="cli-nombre" placeholder="Ej: Juan Pérez" autocomplete="off">
        </div>
        <div class="form-group">
          <label>Celular</label>
          <input type="tel" id="cli-tel" placeholder="Ej: 3165266913" autocomplete="off">
        </div>
        <div class="form-group">
          <label>CC / NIT</label>
          <input type="text" id="cli-cc" placeholder="Ej: 66656526" autocomplete="off">
        </div>
        <div class="form-group form-group-btn">
          <button class="btn btn-success" onclick="agregarCliente()">💾 Guardar</button>
        </div>
      </div>
    </div>

    <!-- Buscador -->
    <div class="card section">
      <div class="card-title">🔍 Buscar Clientes</div>
      <div class="search-row">
        <input type="text" id="cli-search" placeholder="Buscar por nombre, celular o CC…" oninput="renderClientes()">
      </div>
    </div>

    <!-- Tabla -->
    <div class="card">
      <div class="card-title">📋 Directorio de Clientes</div>
      <div class="table-wrapper">
        <table id="clientes-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Celular</th>
              <th>CC / NIT</th>
              <th>Compras</th>
              <th>Total comprado</th>
              <th>Registrado</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="clientes-tbody"></tbody>
        </table>
        <div class="empty-state" id="clientes-empty">
          <div class="icon">👥</div>
          <p>No hay clientes registrados.<br>Agrega el primero arriba.</p>
        </div>
      </div>
    </div>

  </div><!-- /clientes -->

  <!-- ══════════════ PÁGINA: MAYORISTA ══════════════ -->
  <div class="page" id="page-mayorista">

    <!-- Datos del comprador -->
    <div class="card section">
      <div class="card-title">🏢 Datos del Comprador</div>
      <div class="grid-2">
        <div class="form-group" style="margin:0">
          <label>Nombre / Empresa</label>
          <input type="text" id="may-nombre" placeholder="Ej: Distribuidora Pérez" autocomplete="off">
        </div>
        <div class="form-group" style="margin:0">
          <label>Celular</label>
          <input type="tel" id="may-tel" placeholder="Ej: 3165266913" autocomplete="off">
        </div>
        <div class="form-group" style="margin:0;grid-column:1/-1">
          <label>CC / NIT</label>
          <input type="text" id="may-cc" placeholder="Ej: 900123456-1" autocomplete="off" style="max-width:320px">
        </div>
      </div>
    </div>

    <!-- Especies con precio negociado -->
    <div class="card section">
      <div class="card-title">📦 Especies y Precio Negociado</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px;">
        Ingresa la cantidad en libras y el precio negociado por libra para cada especie.
      </p>
      <div class="species-grid" id="may-species-grid">
        <!-- generado por JS -->
      </div>
    </div>

    <!-- Total -->
    <div class="section">
      <div class="total-box">
        <div>
          <div class="text-primary" style="font-size:11px;letter-spacing:1px;font-weight:700;color:var(--text-muted)">TOTAL MAYORISTA</div>
          <div class="total-amount" id="may-total-display">$0</div>
          <div class="total-details" id="may-total-details">— libras</div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="resetMayorista()">✨ Limpiar</button>
          <button class="btn btn-success" onclick="guardarVentaMayorista()">💾 Registrar Venta</button>
        </div>
      </div>
    </div>

    <!-- Historial mayorista -->
    <div class="card section">
      <div class="card-title">📋 Historial de Ventas Mayoristas
        <span class="tab-badge" id="badge-may-hist" style="margin-left:8px">0</span>
      </div>

      <!-- Filtros de período -->
      <div class="filter-bar">
        <span class="filter-bar-label">📅 Período</span>
        <div class="period-btns">
          <button class="period-btn active" onclick="setMayPeriod('today')"  data-mayperiod="today">Hoy</button>
          <button class="period-btn"        onclick="setMayPeriod('week')"   data-mayperiod="week">Esta semana</button>
          <button class="period-btn"        onclick="setMayPeriod('month')"  data-mayperiod="month">Este mes</button>
          <button class="period-btn"        onclick="setMayPeriod('all')"    data-mayperiod="all">Todo</button>
          <button class="period-btn"        onclick="setMayPeriod('custom')" data-mayperiod="custom">Rango…</button>
        </div>
        <div class="date-range-inputs" id="may-custom-range" style="display:none">
          <input type="date" id="may-date-desde" onchange="applyMayCustomRange()">
          <span class="sep">→</span>
          <input type="date" id="may-date-hasta" onchange="applyMayCustomRange()">
        </div>
        <div class="filter-period-indicator">
          <span class="period-pill" id="may-period-pill">Hoy</span>
        </div>
      </div>

      <!-- Búsqueda de texto -->
      <div class="search-row" style="margin-bottom:16px">
        <input type="text" id="may-search" placeholder="Buscar por nombre, celular o CC…" oninput="renderMayorista()">
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Comprador</th>
              <th>CC / NIT</th>
              <th>Celular</th>
              <th>Especies</th>
              <th>Libras</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="may-tbody"></tbody>
        </table>
        <div class="empty-state" id="may-empty">
          <div class="icon">📦</div>
          <p>No hay ventas mayoristas registradas.<br>¡Registra la primera arriba!</p>
        </div>
      </div>
    </div>

  </div><!-- /mayorista -->

</main>

<!-- ══════════════ MODAL: GOOGLE DRIVE SETUP ══════════════ -->
<div class="setup-modal-overlay" id="setup-modal-overlay" onclick="closeSetupOutside(event)">
  <div class="setup-modal">
    <div class="setup-header">
      <h3>
        <svg width="22" height="22" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
          <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
          <path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"/>
          <path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l5.852 11.5z" fill="#ea4335"/>
          <path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"/>
          <path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"/>
          <path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 27.5h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
        </svg>
        Sincronización...
      </h3>
      <button class="modal-close" onclick="closeSetupModal()">×</button>
    </div>

    <div class="setup-body">

      <!-- Estado actual -->
      <div id="drive-setup-connected" style="display:none">
        <div style="background:rgba(6,214,160,0.1);border:1px solid rgba(6,214,160,0.3);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
          <span style="font-size:24px">✅</span>
          <div>
            <div style="font-weight:600;color:var(--green);font-size:14px">Conectado a Google Drive</div>
            <div style="font-size:12px;color:var(--text-secondary);margin-top:2px" id="drive-user-email">—</div>
          </div>
        </div>
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
          Los datos se sincronizan automáticamente en el archivo <code style="background:rgba(0,180,216,0.1);border:1px solid rgba(0,180,216,0.2);border-radius:4px;padding:2px 7px;font-family:'Roboto Mono',monospace;font-size:11px;color:var(--teal-pale)">lagos-isabela-data.json</code> en tu Google Drive.
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" onclick="syncNow()">🔄 Sincronizar ahora</button>
          <button class="btn btn-ghost btn-sm" onclick="driveDisconnect()">🔌 Desconectar</button>
        </div>
      </div>

      <div id="drive-setup-disconnected">
        <!-- Paso 1 -->
        <div class="setup-step">
          <div class="step-num">1</div>
          <div class="step-content">
            <strong>Crea un proyecto en Google Cloud Console</strong>
            <p>Ve a <a href="https://console.cloud.google.com/" target="_blank">console.cloud.google.com</a>, crea un proyecto nuevo (ej: "Lagos La Isabela") y habilita la <strong>Google Drive API</strong>.</p>
          </div>
        </div>

        <!-- Paso 2 -->
        <div class="setup-step">
          <div class="step-num">2</div>
          <div class="step-content">
            <strong>Crea credenciales OAuth 2.0</strong>
            <p>En <em>APIs &amp; Services → Credentials → Create Credentials → OAuth client ID</em>. Tipo: <strong>Web application</strong>. Agrega estos valores:</p>
            <p style="margin-top:6px"><strong>Authorized JavaScript origins:</strong><br>
            <code>https://lagoslaisabela-lgtm.github.io</code></p>
            <p style="margin-top:6px"><strong>Authorized redirect URIs:</strong><br>
            <code>https://lagoslaisabela-lgtm.github.io/cotizador/</code></p>
          </div>
        </div>

        <!-- Paso 3 -->
        <div class="setup-step">
          <div class="step-num">3</div>
          <div class="step-content">
            <strong>Configura la pantalla de consentimiento</strong>
            <p>En <em>OAuth consent screen</em>: tipo <strong>External</strong>, agrega tu email como usuario de prueba. No necesitas publicarla.</p>
          </div>
        </div>

        <!-- Paso 4 - Client ID ya configurado -->
        <div class="setup-step">
          <div class="step-num">4</div>
          <div class="step-content">
            <strong>Client ID ya configurado ✓</strong>
            <p>El Client ID está integrado en la app. Solo necesitas iniciar sesión con tu cuenta Google.</p>
          </div>
        </div>

        <div class="divider-label">Inicia sesión</div>

        <!-- Botón Google Sign In -->
        <button class="google-btn" id="google-signin-btn" onclick="driveConnect()">
          <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
            <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
            <path d="M3.964 10.706A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.706V4.962H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.038l3.007-2.332z" fill="#FBBC05"/>
            <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.962L3.964 6.294C4.672 4.169 6.656 3.58 9 3.58z" fill="#EA4335"/>
          </svg>
          Iniciar sesión con Google
        </button>
      </div>

    </div>

    <div class="setup-footer">
      <span class="setup-footer-note">🔒 Solo se accede al archivo de datos de esta app. No se leen otros archivos de tu Drive.</span>
      <button class="btn btn-ghost btn-sm" onclick="closeSetupModal()">Cerrar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="modal-overlay" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-header">
      <h3>✏️ Editar Orden</h3>
      <button class="modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="modal-body">

      <!-- Datos cliente -->
      <div class="edit-section-title">👤 Datos del Cliente</div>
      <div class="grid-2">
        <div class="form-group" style="margin:0">
          <label>Nombre completo</label>
          <input type="text" id="edit-nombre" placeholder="Nombre del cliente">
        </div>
        <div class="form-group" style="margin:0">
          <label>Celular</label>
          <input type="tel" id="edit-tel" placeholder="Número de celular">
        </div>
        <div class="form-group" style="margin:0;grid-column:1/-1">
          <label>Número de identificación (CC / NIT)</label>
          <input type="text" id="edit-cc" placeholder="Ej: 1234567890" style="max-width:320px">
        </div>
      </div>

      <!-- Tabla de especies -->
      <div class="edit-section-title" style="margin-top:20px">🐟 Especies</div>
      <div style="overflow-x:auto">
        <table class="edit-table">
          <thead>
            <tr>
              <th>Especie</th>
              <th>Libras</th>
              <th>Precio/lb</th>
              <th>Eviscerado</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="edit-items-tbody"></tbody>
        </table>
      </div>

      <!-- Agregar nueva especie -->
      <div class="add-item-box">
        <div class="add-title">➕ Agregar especie a esta orden</div>
        <div class="add-item-row">
          <div class="fg">
            <label>Especie</label>
            <select id="add-especie" style="width:100%;background:var(--input-bg);border:1px solid rgba(0,180,216,0.25);border-radius:var(--radius-sm);padding:9px 12px;color:var(--text-primary);font-family:'DM Sans',sans-serif;font-size:13px;">
              <option value="">— Seleccionar —</option>
            </select>
          </div>
          <div class="fg">
            <label>Libras</label>
            <input type="number" id="add-qty" min="0.1" step="0.1" placeholder="0.0">
          </div>
          <div class="fg" id="add-precio-wrap" style="display:none">
            <label>Precio/lb</label>
            <input type="number" id="add-precio" min="0" step="100" placeholder="0">
          </div>
          <div class="fg">
            <label>🔪 Eviscerado</label>
            <select id="add-ev" style="width:100%;background:var(--input-bg);border:1px solid rgba(0,180,216,0.25);border-radius:var(--radius-sm);padding:9px 12px;color:var(--text-primary);font-family:'DM Sans',sans-serif;font-size:13px;">
              <option value="0">No</option>
              <option value="1">Sí</option>
            </select>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="addEditItem()" style="align-self:flex-end;flex-shrink:0">Agregar</button>
        </div>
      </div>

      <!-- Total actualizado -->
      <div class="edit-total-bar">
        <div>
          <div class="elabel">Total actualizado</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:3px" id="edit-total-detail">—</div>
        </div>
        <div class="evalue" id="edit-total-display">$0</div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-success" onclick="guardarEdicion()">💾 Guardar cambios</button>
    </div>
  </div>
</div>

<!-- ══════════════ PANEL: PERFIL DE CLIENTE ══════════════ -->
<div id="cli-profile-overlay" onclick="cerrarPerfil()"></div>
<div id="cli-profile-panel">

  <!-- Cabecera del perfil -->
  <div class="profile-header">
    <div class="profile-avatar" id="prof-avatar">👤</div>
    <div class="profile-name-block">
      <div class="profile-name" id="prof-nombre">—</div>
      <div class="profile-meta" id="prof-meta"></div>
      <div id="prof-status-btn" class="profile-status activo" onclick="toggleEstadoCliente()">
        <span id="prof-status-dot">●</span>
        <span id="prof-status-text">ACTIVO</span>
      </div>
    </div>
    <button class="profile-close-btn" onclick="cerrarPerfil()">✕</button>
  </div>

  <!-- Cuerpo scrollable -->
  <div class="profile-body">

    <!-- Datos de contacto -->
    <div>
      <div class="profile-section-title">📋 Datos de Contacto</div>
      <div class="profile-info-grid" id="prof-contacto-grid"></div>
    </div>

    <!-- Comportamiento de compra -->
    <div>
      <div class="profile-section-title">🛒 Comportamiento de Compra · últimos 2 años</div>
      <div class="top-especies" id="prof-top-especies"></div>
      <div style="margin-top:12px" id="prof-ev-indicator"></div>
    </div>

    <!-- Caracterización opcional -->
    <div>
      <div class="profile-section-title">✏️ Caracterización del Cliente</div>
      <div class="profile-edit-grid">
        <div class="profile-edit-field">
          <label>Género</label>
          <select id="prof-genero" onchange="marcarCambio()">
            <option value="">— Sin especificar —</option>
            <option value="masculino">Masculino</option>
            <option value="femenino">Femenino</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div class="profile-edit-field">
          <label>Fecha de nacimiento</label>
          <input type="date" id="prof-nacimiento" oninput="marcarCambio(); actualizarEdad()">
        </div>
        <div class="profile-edit-field full">
          <label>Lugar de residencia</label>
          <input type="text" id="prof-residencia" placeholder="Ej: Cali, Valle del Cauca" oninput="marcarCambio()">
        </div>
        <div class="profile-edit-field full">
          <label>Correo electrónico</label>
          <input type="email" id="prof-email" placeholder="Ej: cliente@correo.com" oninput="marcarCambio()">
        </div>
        <div class="profile-edit-field full">
          <label>Notas</label>
          <textarea id="prof-notas" placeholder="Preferencias, observaciones, información adicional…" oninput="marcarCambio()"></textarea>
        </div>
      </div>
    </div>

  </div><!-- /profile-body -->

  <!-- Footer con botones -->
  <div class="profile-footer">
    <button class="btn btn-ghost" onclick="cerrarPerfil()">Cerrar</button>
    <button class="btn btn-success" id="prof-save-btn" onclick="guardarPerfilCliente()" style="display:none">💾 Guardar cambios</button>
  </div>

</div><!-- /cli-profile-panel -->

<!-- ══════════════ MODAL: EDITAR CLIENTE ══════════════ -->
<div class="modal-overlay" id="cli-modal-overlay" onclick="closeCLiModalOutside(event)">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <h3>✏️ Editar Cliente</h3>
      <button class="modal-close" onclick="closeCliModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="grid-2" style="gap:14px">
        <div class="form-group" style="margin:0;grid-column:1/-1">
          <label>Nombre completo</label>
          <input type="text" id="cli-edit-nombre" placeholder="Nombre del cliente">
        </div>
        <div class="form-group" style="margin:0">
          <label>Celular</label>
          <input type="tel" id="cli-edit-tel" placeholder="Ej: 3165266913">
        </div>
        <div class="form-group" style="margin:0">
          <label>CC / NIT</label>
          <input type="text" id="cli-edit-cc" placeholder="Ej: 66656526">
        </div>
      </div>
      <div id="cli-edit-historial-note" style="display:none;margin-top:14px;padding:10px 14px;background:rgba(0,180,216,0.07);border:1px solid rgba(0,180,216,0.2);border-radius:8px;font-size:12px;color:var(--text-secondary)">
        ℹ️ Este cliente viene del historial. Los cambios se guardarán en el directorio y tendrán prioridad en el autocompletado.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCliModal()">Cancelar</button>
      <button class="btn btn-success" onclick="guardarEdicionCliente()">💾 Guardar</button>
    </div>
  </div>
</div>

<!-- ══════════════ MODAL: EDITAR VENTA MAYORISTA ══════════════ -->
<div class="modal-overlay" id="may-modal-overlay" onclick="if(event.target===this)closeMayModal()">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <h3>✏️ Editar Venta Mayorista</h3>
      <button class="modal-close" onclick="closeMayModal()">×</button>
    </div>
    <div class="modal-body">
      <!-- Datos comprador -->
      <div class="edit-section-title">🏢 Datos del Comprador</div>
      <div class="grid-2" style="gap:14px;margin-bottom:20px">
        <div class="form-group" style="margin:0;grid-column:1/-1">
          <label>Nombre / Empresa</label>
          <input type="text" id="may-edit-nombre" placeholder="Ej: Distribuidora Pérez">
        </div>
        <div class="form-group" style="margin:0">
          <label>Celular</label>
          <input type="tel" id="may-edit-tel" placeholder="Ej: 3165266913">
        </div>
        <div class="form-group" style="margin:0">
          <label>CC / NIT</label>
          <input type="text" id="may-edit-cc" placeholder="Ej: 900123456-1">
        </div>
      </div>
      <!-- Especies -->
      <div class="edit-section-title">📦 Especies y Precios</div>
      <div class="species-grid" id="may-edit-species-grid" style="margin-top:12px"></div>
      <!-- Total en tiempo real -->
      <div style="margin-top:14px;padding:12px 16px;background:rgba(6,214,160,0.06);border:1px solid rgba(6,214,160,0.2);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
        <span style="color:var(--text-secondary);font-size:13px">Total calculado</span>
        <strong style="font-family:'Roboto Mono',monospace;font-size:16px;color:var(--green)" id="may-edit-total">$0</strong>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeMayModal()">Cancelar</button>
      <button class="btn btn-success" onclick="guardarEdicionMayorista()">💾 Guardar cambios</button>
    </div>
  </div>
</div>

<!-- AUTOCOMPLETE FLOTANTE -->
<div class="autocomplete-list" id="ac-list"></div>
<div class="autocomplete-list" id="ac-tel-list"></div>
<div class="autocomplete-list" id="ac-cc-list"></div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ─────────────────────────────────────────────
//  DATOS
// ─────────────────────────────────────────────
const ESPECIES = [
  { id: 'tilapia_roja',       nombre: 'Tilapia Roja',        precio: 8000 },
  { id: 'tilapia_grill',      nombre: 'Tilapia Grilla',      precio: 7000 },
  { id: 'tilapia_roja_extra', nombre: 'Tilapia Roja Extra',  precio: 8500 },
  { id: 'cachama',            nombre: 'Cachama',             precio: 7000 },
  { id: 'dorada',             nombre: 'Dorada',              precio: 8000 },
  { id: 'bagre',              nombre: 'Bagre',               precio: 8000 },
  { id: 'otro',               nombre: 'Otro Pescado',        precio: null },
];

const EVISCERA_COSTO = 500;
const STORAGE_KEY    = 'aquacot_v1';
const CLIENTES_KEY   = 'aquacot_clientes_v1';
const MAYORISTA_KEY  = 'aquacot_mayorista_v1';

// ── Safe storage: fallback a memoria si localStorage está bloqueado ──
const safeStorage = (() => {
  const mem = {};
  let useLocal = true;
  try { localStorage.setItem('__test__', '1'); localStorage.removeItem('__test__'); }
  catch(e) { useLocal = false; console.warn('localStorage bloqueado — usando memoria temporal'); }
  return {
    getItem(k)    { return useLocal ? localStorage.getItem(k)    : (mem[k] ?? null); },
    setItem(k, v) { if (useLocal) localStorage.setItem(k, v);    else mem[k] = v; },
    removeItem(k) { if (useLocal) localStorage.removeItem(k);    else delete mem[k]; }
  };
})();

let ordenes   = JSON.parse(safeStorage.getItem(STORAGE_KEY)    || '[]');
let clientes  = JSON.parse(safeStorage.getItem(CLIENTES_KEY)   || '[]');
let mayorista = JSON.parse(safeStorage.getItem(MAYORISTA_KEY)  || '[]');
// clientes: [{ id, nombre, tel, cc, creadoEn, lastUpdated }]
// mayorista: [{ id, fecha, fechaObj, lastUpdated, nombre, tel, cc, items, totalLibras, total }]
// mayorista items: [{ especie, qty, precio, subTotal }]

// ─────────────────────────────────────────────
//  RELOJ
// ─────────────────────────────────────────────
const MESES = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock-time').textContent = `${h}:${m}:${s}`;
  document.getElementById('clock-date').textContent = `${now.getDate()} de ${MESES[now.getMonth()]} de ${now.getFullYear()}`;
}
setInterval(updateClock, 1000);
updateClock();

// ─────────────────────────────────────────────
//  TABS
// ─────────────────────────────────────────────
let activeTab = 'cotizar';

function showTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`page-${tab}`).classList.add('active');
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  // Marca si la pestaña activa tiene botones de acción en la parte inferior
  document.body.classList.toggle('tab-has-actions', tab === 'cotizar' || tab === 'mayorista');
  if (tab === 'historial')   renderHistorial();
  if (tab === 'dashboard')   renderDashboard();
  if (tab === 'eviscerado')  renderEviscerado();
  if (tab === 'clientes')    renderClientes();
  if (tab === 'mayorista')   renderMayorista();
}

// ─────────────────────────────────────────────
//  RENDER ESPECIES
// ─────────────────────────────────────────────
function buildSpeciesGrid() {
  const grid = document.getElementById('species-grid');
  grid.innerHTML = ESPECIES.map(e => `
    <div class="species-card" id="sc-${e.id}">
      <div class="species-header">
        <span class="species-name">${e.nombre}</span>
        <span class="species-price">${e.precio ? fmt(e.precio)+'/lb' : 'Precio libre'}</span>
      </div>
      <div class="species-inputs">
        ${e.precio === null ? `<input type="number" min="0" step="0.1" placeholder="Precio/lb" id="precio-${e.id}" oninput="calcular()" style="max-width:100px">` : ''}
        <input type="number" min="0" step="0.1" placeholder="0.0 lb" id="qty-${e.id}" oninput="calcular()">
        <label class="eviscera-label">
          <input type="checkbox" id="ev-${e.id}" onchange="calcular()">
          <div class="custom-check">✓</div>
          🔪
        </label>
      </div>
      <div class="species-subtotal">
        <span id="sub-label-${e.id}">— lb</span>
        <span id="sub-${e.id}">$0</span>
      </div>
    </div>
  `).join('');
}

// ─────────────────────────────────────────────
//  MAYORISTA — GRID Y CÁLCULO
// ─────────────────────────────────────────────
function buildMaySpeciesGrid() {
  const grid = document.getElementById('may-species-grid');
  if (!grid) return;
  grid.innerHTML = ESPECIES.map(e => `
    <div class="may-species-card" id="may-sc-${e.id}">
      <div class="may-species-header">
        <span class="may-species-name">${e.nombre}</span>
      </div>
      <div class="may-species-inputs">
        <div class="may-input-wrap">
          <span class="may-input-label">Precio / lb</span>
          <input type="number" min="0" step="100"
            placeholder="${e.precio ? e.precio : '0'}"
            id="may-precio-${e.id}"
            value="${e.precio || ''}"
            oninput="calcularMayorista()">
        </div>
        <div class="may-input-wrap">
          <span class="may-input-label">Libras</span>
          <input type="number" min="0" step="0.1"
            placeholder="0.0 lb"
            id="may-qty-${e.id}"
            oninput="calcularMayorista()">
        </div>
      </div>
      <div class="may-subtotal">
        <span id="may-sub-label-${e.id}">— lb</span>
        <span id="may-sub-${e.id}">$0</span>
      </div>
    </div>
  `).join('');
}

function calcularMayorista() {
  let totalLibras = 0, total = 0;

  ESPECIES.forEach(e => {
    const qty    = parseFloat(document.getElementById(`may-qty-${e.id}`)?.value)    || 0;
    const precio = parseFloat(document.getElementById(`may-precio-${e.id}`)?.value) || 0;
    const sub    = qty * precio;
    totalLibras += qty;
    total       += sub;

    const card = document.getElementById(`may-sc-${e.id}`);
    if (card) card.classList.toggle('has-value', qty > 0 && precio > 0);
    const subEl = document.getElementById(`may-sub-${e.id}`);
    const lblEl = document.getElementById(`may-sub-label-${e.id}`);
    if (subEl) subEl.textContent = fmt(sub);
    if (lblEl) lblEl.textContent = qty > 0 ? `${qty} lb` : '— lb';
  });

  const totalEl   = document.getElementById('may-total-display');
  const detailEl  = document.getElementById('may-total-details');
  if (totalEl)  totalEl.textContent  = fmt(total);
  if (detailEl) detailEl.textContent = `${totalLibras.toFixed(1)} libras`;
}

function guardarVentaMayorista() {
  const nombre = document.getElementById('may-nombre').value.trim();
  if (!nombre) { toast('Ingresa el nombre del comprador', true); return; }

  const tel = document.getElementById('may-tel').value.trim();
  const cc  = document.getElementById('may-cc').value.trim();
  const items = [];
  let totalLibras = 0, total = 0;

  ESPECIES.forEach(e => {
    const qty    = parseFloat(document.getElementById(`may-qty-${e.id}`)?.value)    || 0;
    const precio = parseFloat(document.getElementById(`may-precio-${e.id}`)?.value) || 0;
    if (qty <= 0) return;
    const sub = qty * precio;
    items.push({ especie: e.nombre, qty, precio, subTotal: sub });
    totalLibras += qty;
    total       += sub;
  });

  if (items.length === 0) { toast('Agrega al menos una especie', true); return; }

  const now = new Date();
  const venta = {
    id:          Date.now(),
    fecha:       now.toLocaleString('es-CO'),
    fechaObj:    now.toISOString(),
    lastUpdated: now.toISOString(),
    nombre, tel, cc, items, totalLibras, total
  };

  mayorista.unshift(venta);
  safeStorage.setItem(MAYORISTA_KEY, JSON.stringify(mayorista));
  updateBadge();
  toast('✅ Venta mayorista registrada');
  renderDashboard();
  renderMayorista();
  scheduleDriveSync();
  resetMayorista(true);
}

function resetMayorista(silent = false) {
  if (!silent && !confirm('¿Limpiar el formulario? Se perderán los datos no guardados.')) return;
  document.getElementById('may-nombre').value = '';
  document.getElementById('may-tel').value    = '';
  document.getElementById('may-cc').value     = '';
  ESPECIES.forEach(e => {
    const qtyEl    = document.getElementById(`may-qty-${e.id}`);
    const precioEl = document.getElementById(`may-precio-${e.id}`);
    if (qtyEl) qtyEl.value = '';
    // Restaurar precio estándar como placeholder/valor por defecto
    if (precioEl) precioEl.value = e.precio || '';
    const card = document.getElementById(`may-sc-${e.id}`);
    if (card) card.classList.remove('has-value');
    const subEl = document.getElementById(`may-sub-${e.id}`);
    const lblEl = document.getElementById(`may-sub-label-${e.id}`);
    if (subEl) subEl.textContent = '$0';
    if (lblEl) lblEl.textContent = '— lb';
  });
  const totalEl  = document.getElementById('may-total-display');
  const detailEl = document.getElementById('may-total-details');
  if (totalEl)  totalEl.textContent  = '$0';
  if (detailEl) detailEl.textContent = '— libras';
  if (!silent) toast('Formulario limpiado');
}

function eliminarVentaMayorista(id) {
  if (!confirm('¿Eliminar esta venta mayorista?')) return;
  mayorista = mayorista.filter(v => v.id !== id);
  safeStorage.setItem(MAYORISTA_KEY, JSON.stringify(mayorista));
  updateBadge();
  renderDashboard();
  renderMayorista();
  scheduleDriveSync();
  toast('Venta eliminada');
}

// ── Filtros de período para historial mayorista ──
let mayPeriod      = 'today';
let mayCustomDesde = null;
let mayCustomHasta = null;

function setMayPeriod(period) {
  mayPeriod = period;
  document.querySelectorAll('[data-mayperiod]').forEach(b => {
    b.classList.toggle('active', b.dataset.mayperiod === period);
  });
  const rangeEl = document.getElementById('may-custom-range');
  if (rangeEl) rangeEl.style.display = period === 'custom' ? 'flex' : 'none';
  renderMayorista();
}

function applyMayCustomRange() {
  mayCustomDesde = document.getElementById('may-date-desde')?.value || null;
  mayCustomHasta = document.getElementById('may-date-hasta')?.value || null;
  renderMayorista();
}

function getMayFiltered() {
  const now   = new Date();
  const hoy0  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
  const hoy23 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

  switch (mayPeriod) {
    case 'today':
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= hoy0 && d <= hoy23; });
    case 'week': {
      const diff = (now.getDay() === 0) ? 6 : now.getDay() - 1;
      const lunes   = new Date(hoy0); lunes.setDate(hoy0.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6); domingo.setHours(23,59,59,999);
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= lunes && d <= domingo; });
    }
    case 'month': {
      const ini = new Date(now.getFullYear(), now.getMonth(), 1);
      const fin = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= ini && d <= fin; });
    }
    case 'custom': {
      if (!mayCustomDesde || !mayCustomHasta) return mayorista;
      const desde = new Date(mayCustomDesde + 'T00:00:00');
      const hasta = new Date(mayCustomHasta + 'T23:59:59');
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= desde && d <= hasta; });
    }
    default: return mayorista;
  }
}

function getMayPeriodLabel() {
  const now = new Date();
  const fmt = d => d.toLocaleDateString('es-CO', { day:'numeric', month:'short' });
  switch (mayPeriod) {
    case 'today':  return `Hoy, ${fmt(now)}`;
    case 'week': {
      const diff = (now.getDay() === 0) ? 6 : now.getDay() - 1;
      const lunes  = new Date(now); lunes.setDate(now.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6);
      return `${fmt(lunes)} – ${fmt(domingo)}`;
    }
    case 'month': return now.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
    case 'custom':
      if (!mayCustomDesde || !mayCustomHasta) return 'Rango personalizado';
      return `${fmt(new Date(mayCustomDesde+'T00:00:00'))} – ${fmt(new Date(mayCustomHasta+'T00:00:00'))}`;
    default: return 'Todo el historial';
  }
}

function renderMayorista() {
  const q     = (document.getElementById('may-search')?.value || '').toLowerCase().trim();
  const tbody = document.getElementById('may-tbody');
  const empty = document.getElementById('may-empty');

  // Actualizar pill de período
  const pillEl = document.getElementById('may-period-pill');
  if (pillEl) pillEl.textContent = getMayPeriodLabel();

  let lista = getMayFiltered();
  if (q) lista = lista.filter(v =>
    v.nombre.toLowerCase().includes(q) ||
    (v.tel || '').includes(q) ||
    (v.cc  || '').toLowerCase().includes(q)
  );

  document.getElementById('badge-may-hist').textContent = mayorista.length;

  if (lista.length === 0) {
    if (tbody) tbody.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  tbody.innerHTML = lista.map((v) => `
    <tr>
      <td><span class="badge badge-teal">${mayorista.length - mayorista.indexOf(v)}</span></td>
      <td style="font-size:12px;color:var(--text-secondary)">${v.fecha}</td>
      <td><strong>${v.nombre}</strong></td>
      <td style="font-family:'Roboto Mono',monospace;font-size:12px">${v.cc || '—'}</td>
      <td>${v.tel || '—'}</td>
      <td><span class="badge badge-teal">${v.items.length} esp.</span></td>
      <td>${v.totalLibras.toFixed(1)} lb</td>
      <td><strong style="color:var(--green);font-family:'Roboto Mono',monospace">${fmt(v.total)}</strong></td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-sm may-edit-btn" data-id="${v.id}" title="Editar">✏️</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarVentaMayorista(${v.id})" title="Eliminar">🗑</button>
      </td>
    </tr>
  `).join('');

  // Eventos editar con data attributes
  tbody.querySelectorAll('.may-edit-btn').forEach(btn => {
    btn.addEventListener('click', () => abrirEdicionMayorista(Number(btn.dataset.id)));
  });
}

// ── Edición de venta mayorista ────────────────
let editingMayoristaId = null;

function abrirEdicionMayorista(id) {
  const venta = mayorista.find(v => v.id === id);
  if (!venta) return;
  editingMayoristaId = id;

  document.getElementById('may-edit-nombre').value = venta.nombre;
  document.getElementById('may-edit-tel').value    = venta.tel || '';
  document.getElementById('may-edit-cc').value     = venta.cc  || '';

  // Construir grid de especies con valores actuales
  const grid = document.getElementById('may-edit-species-grid');
  grid.innerHTML = ESPECIES.map(e => {
    const item  = venta.items.find(i => i.especie === e.nombre);
    const qty   = item ? item.qty   : '';
    const precio = item ? item.precio : (e.precio || '');
    return `
      <div class="may-species-card" id="may-edit-sc-${e.id}">
        <div class="may-species-header">
          <span class="may-species-name">${e.nombre}</span>
        </div>
        <div class="may-species-inputs">
          <div class="may-input-wrap">
            <span class="may-input-label">Precio / lb</span>
            <input type="number" min="0" step="100"
              id="may-edit-precio-${e.id}"
              value="${precio}"
              placeholder="${e.precio || 0}"
              oninput="calcularMayEdit()">
          </div>
          <div class="may-input-wrap">
            <span class="may-input-label">Libras</span>
            <input type="number" min="0" step="0.1"
              id="may-edit-qty-${e.id}"
              value="${qty}"
              placeholder="0.0 lb"
              oninput="calcularMayEdit()">
          </div>
        </div>
        <div class="may-subtotal">
          <span id="may-edit-sub-label-${e.id}">${qty ? qty + ' lb' : '— lb'}</span>
          <span id="may-edit-sub-${e.id}">${item ? fmt(item.subTotal) : '$0'}</span>
        </div>
      </div>
    `;
  }).join('');

  calcularMayEdit();
  document.getElementById('may-modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function calcularMayEdit() {
  let total = 0;
  ESPECIES.forEach(e => {
    const qty    = parseFloat(document.getElementById(`may-edit-qty-${e.id}`)?.value)    || 0;
    const precio = parseFloat(document.getElementById(`may-edit-precio-${e.id}`)?.value) || 0;
    const sub    = qty * precio;
    total += sub;
    const subEl = document.getElementById(`may-edit-sub-${e.id}`);
    const lblEl = document.getElementById(`may-edit-sub-label-${e.id}`);
    const card  = document.getElementById(`may-edit-sc-${e.id}`);
    if (subEl) subEl.textContent = fmt(sub);
    if (lblEl) lblEl.textContent = qty > 0 ? `${qty} lb` : '— lb';
    if (card)  card.classList.toggle('has-value', qty > 0 && precio > 0);
  });
  const totalEl = document.getElementById('may-edit-total');
  if (totalEl) totalEl.textContent = fmt(total);
}

function closeMayModal() {
  document.getElementById('may-modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
  editingMayoristaId = null;
}

function guardarEdicionMayorista() {
  const nombre = document.getElementById('may-edit-nombre').value.trim();
  if (!nombre) { toast('El nombre es obligatorio', true); return; }

  const tel = document.getElementById('may-edit-tel').value.trim();
  const cc  = document.getElementById('may-edit-cc').value.trim();

  const items = [];
  let totalLibras = 0, total = 0;
  ESPECIES.forEach(e => {
    const qty    = parseFloat(document.getElementById(`may-edit-qty-${e.id}`)?.value)    || 0;
    const precio = parseFloat(document.getElementById(`may-edit-precio-${e.id}`)?.value) || 0;
    if (qty <= 0) return;
    const sub = qty * precio;
    items.push({ especie: e.nombre, qty, precio, subTotal: sub });
    totalLibras += qty;
    total       += sub;
  });

  if (items.length === 0) { toast('Agrega al menos una especie', true); return; }

  const idx = mayorista.findIndex(v => v.id === editingMayoristaId);
  if (idx === -1) return;

  mayorista[idx] = {
    ...mayorista[idx],
    nombre, tel, cc, items, totalLibras, total,
    lastUpdated: new Date().toISOString()
  };

  safeStorage.setItem(MAYORISTA_KEY, JSON.stringify(mayorista));
  closeMayModal();
  updateBadge();
  renderDashboard();
  renderMayorista();
  scheduleDriveSync();
  toast('✅ Venta mayorista actualizada');
}

// ─────────────────────────────────────────────
//  CALCULAR
// ─────────────────────────────────────────────
function calcular() {
  let totalPescado = 0, totalEviscerado = 0, totalLibras = 0;

  ESPECIES.forEach(e => {
    const qtyEl = document.getElementById(`qty-${e.id}`);
    const evEl  = document.getElementById(`ev-${e.id}`);
    const card  = document.getElementById(`sc-${e.id}`);
    const qty   = parseFloat(qtyEl.value) || 0;
    const ev    = evEl.checked;
    let precio  = e.precio;

    if (e.precio === null) {
      const pEl = document.getElementById(`precio-${e.id}`);
      precio = parseFloat(pEl.value) || 0;
    }

    const subPescado   = qty * precio;
    const subEviscerado = ev ? qty * EVISCERA_COSTO : 0;
    const subTotal     = subPescado + subEviscerado;

    totalPescado    += subPescado;
    totalEviscerado += subEviscerado;
    totalLibras     += qty;

    document.getElementById(`sub-${e.id}`).textContent = fmt(subTotal);
    document.getElementById(`sub-label-${e.id}`).textContent = qty > 0 ? `${qty} lb${ev ? ' · con eviscerado':''}`:'— lb';
    card.classList.toggle('has-value', qty > 0);
  });

  const total = totalPescado + totalEviscerado;
  document.getElementById('total-display').textContent = fmt(total);
  document.getElementById('total-details').textContent =
    `${totalLibras.toFixed(1)} libras · Eviscerado: ${fmt(totalEviscerado)}`;

  // Recalcular devuelta si hay un valor de pago ingresado
  calcDevuelta();
}

function calcDevuelta() {
  const totalEl = document.getElementById('total-display').textContent;
  // Limpiar formato: quitar $, puntos de miles
  const total   = parseInt(totalEl.replace(/[$.,]/g, '').replace(/\s/g, '')) || 0;
  const pago    = parseInt((document.getElementById('pago-input').value || '0').replace(/\D/g,'')) || 0;
  const devEl   = document.getElementById('devuelta-display');

  if (pago === 0 || total === 0) {
    devEl.textContent = '—';
    devEl.className   = 'devuelta-amount pending';
    return;
  }

  const diff = pago - total;

  if (diff > 0) {
    devEl.textContent = fmt(diff);
    devEl.className   = 'devuelta-amount ok';
  } else if (diff === 0) {
    devEl.textContent = '¡Exacto!';
    devEl.className   = 'devuelta-amount exact';
  } else {
    devEl.textContent = `Falta ${fmt(Math.abs(diff))}`;
    devEl.className   = 'devuelta-amount falta';
  }
}

// ─────────────────────────────────────────────
//  GUARDAR
// ─────────────────────────────────────────────
function getFormData() {
  const nombre = document.getElementById('cliente-nombre').value.trim();
  const tel    = document.getElementById('cliente-tel').value.trim();
  const cc     = document.getElementById('cliente-cc').value.trim();
  const items  = [];
  let totalPescado = 0, totalEviscerado = 0, totalLibras = 0;

  ESPECIES.forEach(e => {
    const qty = parseFloat(document.getElementById(`qty-${e.id}`).value) || 0;
    if (qty <= 0) return;
    const ev = document.getElementById(`ev-${e.id}`).checked;
    let precio = e.precio;
    if (e.precio === null) {
      precio = parseFloat(document.getElementById(`precio-${e.id}`).value) || 0;
    }
    const subPescado    = qty * precio;
    const subEviscerado = ev ? qty * EVISCERA_COSTO : 0;
    totalPescado    += subPescado;
    totalEviscerado += subEviscerado;
    totalLibras     += qty;
    items.push({ especie: e.nombre, qty, precio, ev, subPescado, subEviscerado });
  });

  return { nombre, tel, cc, items, totalPescado, totalEviscerado, totalLibras, total: totalPescado + totalEviscerado };
}

function guardarOrden() {
  const data = getFormData();
  if (!data.nombre) { toast('Ingresa el nombre del cliente', true); return; }
  if (data.items.length === 0) { toast('Agrega al menos una especie', true); return; }

  const now = new Date();
  const pagoVal = parseInt((document.getElementById('pago-input').value || '0').replace(/\D/g,'')) || 0;
  const cot = {
    id: Date.now(),
    fecha: now.toLocaleString('es-CO'),
    fechaObj: now.toISOString(),
    lastUpdated: now.toISOString(),
    pagoCon: pagoVal || null,
    devuelta: pagoVal > 0 ? pagoVal - (data.totalPescado + data.totalEviscerado) : null,
    ...data
  };

  ordenes.unshift(cot);
  safeStorage.setItem(STORAGE_KEY, JSON.stringify(ordenes));
  updateBadge();
  toast('✅ Cobrado y Guardado');
  renderDashboard();
  scheduleDriveSync();
  resetForm(true);
}

// ─────────────────────────────────────────────
//  GENERAR PDF
// ─────────────────────────────────────────────
function generarPDF(cotId) {
  // Si se pasa un ID, genera PDF desde el historial; si no, desde el formulario activo
  let data;
  if (cotId !== undefined) {
    const cot = ordenes.find(c => c.id === cotId);
    if (!cot) { toast('Orden no encontrada', true); return; }
    data = { ...cot };
  } else {
    data = getFormData();
    if (!data.nombre) { toast('Ingresa el nombre del cliente', true); return; }
    if (data.items.length === 0) { toast('Agrega al menos una especie', true); return; }
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  const W = 210, M = 20;
  let y = 20;

  // Header fondo
  doc.setFillColor(10, 22, 40);
  doc.rect(0, 0, W, 45, 'F');

  doc.setFillColor(0, 180, 216);
  doc.rect(0, 43, W, 2, 'F');

  doc.setTextColor(0, 180, 216);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(22);
  doc.text('Lagos La Isabela', M, 18);

  doc.setTextColor(144, 180, 196);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.text('Gestión de Ordenes de Pescado', M, 26);
  doc.text(`Fecha: ${data.fecha || new Date().toLocaleString('es-CO')}`, M, 33);

  y = 58;

  // Cliente
  doc.setFillColor(13, 34, 64);
  doc.roundedRect(M, y-6, W-2*M, 22, 3, 3, 'F');
  doc.setTextColor(0, 180, 216);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(10);
  doc.text('DATOS DEL CLIENTE', M+4, y+2);
  doc.setTextColor(232, 244, 248);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  doc.text(`${data.nombre}`, M+4, y+9);
  doc.setTextColor(144, 180, 196);
  doc.setFontSize(10);
  doc.text(`Tel: ${data.tel || 'N/A'}${data.cc ? '   CC/NIT: ' + data.cc : ''}`, M+4, y+15);

  y += 32;

  // Tabla header
  doc.setFillColor(0, 100, 150);
  doc.rect(M, y-5, W-2*M, 10, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(9);

  const cols = [M+2, M+42, M+70, M+100, M+122, M+148];
  ['ESPECIE', 'LBS', 'PRECIO/LB', 'SUBTOTAL', 'EVISCERADO', 'TOTAL'].forEach((t, i) => {
    doc.text(t, cols[i], y+1);
  });

  y += 10;

  data.items.forEach((item, idx) => {
    if (idx % 2 === 0) {
      doc.setFillColor(230, 245, 255);
      doc.rect(M, y-4, W-2*M, 9, 'F');
    }
    doc.setTextColor(30, 30, 60);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text(item.especie, cols[0], y+1);
    doc.text(item.qty.toFixed(1), cols[1], y+1);
    doc.text(fmt(item.precio), cols[2], y+1);
    doc.text(fmt(item.subPescado), cols[3], y+1);
    doc.text(item.ev ? fmt(item.subEviscerado) : '—', cols[4], y+1);
    doc.text(fmt(item.subPescado + item.subEviscerado), cols[5], y+1);
    y += 9;
  });

  y += 6;
  doc.setDrawColor(0, 180, 216);
  doc.setLineWidth(0.5);
  doc.line(M, y, W-M, y);
  y += 8;

  // Totales
  const totalesData = [
    ['Subtotal pescado', fmt(data.totalPescado)],
    ['Subtotal eviscerado', fmt(data.totalEviscerado)],
  ];

  totalesData.forEach(([k, v]) => {
    doc.setTextColor(80, 80, 100);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.text(k, W - M - 80, y);
    doc.text(v, W - M - 5, y, { align: 'right' });
    y += 8;
  });

  y += 2;
  doc.setFillColor(0, 180, 216);
  doc.roundedRect(W-M-90, y-7, 90, 14, 3, 3, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(13);
  doc.text('TOTAL:', W-M-80, y+2);
  doc.text(fmt(data.total), W-M-5, y+2, { align: 'right' });

  y += 24;
  doc.setTextColor(144, 180, 196);
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(9);
  doc.text('Gracias por su preferencia — Lagos La Isabela', M, y);

  doc.save(`orden_${data.nombre.replace(/\s/g,'_')}_${Date.now()}.pdf`);
  toast('📄 PDF generado correctamente');
}

// ─────────────────────────────────────────────
//  HISTORIAL
// ─────────────────────────────────────────────
function renderHistorial(filter = '') {
  const nombre = document.getElementById('search-nombre')?.value.toLowerCase() || '';
  const tel    = document.getElementById('search-tel')?.value.toLowerCase() || '';
  const cc     = document.getElementById('search-cc')?.value.toLowerCase() || '';
  const tbody  = document.getElementById('historial-tbody');
  const empty  = document.getElementById('historial-empty');

  let lista = ordenes.filter(c => {
    return (!nombre || c.nombre.toLowerCase().includes(nombre)) &&
           (!tel    || (c.tel || '').includes(tel)) &&
           (!cc     || (c.cc  || '').toLowerCase().includes(cc));
  });

  if (lista.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = lista.map((c, i) => `
    <tr>
      <td><span class="badge badge-teal">${ordenes.length - ordenes.indexOf(c)}</span></td>
      <td style="font-size:12px;color:var(--text-secondary)">${c.fecha}</td>
      <td><strong>${c.nombre}</strong></td>
      <td style="font-family:'Roboto Mono',monospace;font-size:12px">${c.cc || '—'}</td>
      <td>${c.tel || '—'}</td>
      <td><span class="badge badge-teal">${c.items.length} esp.</span></td>
      <td>${c.totalLibras.toFixed(1)} lb</td>
      <td>${c.totalEviscerado > 0 ? `<span class="badge badge-gold">${fmt(c.totalEviscerado)}</span>` : '—'}</td>
      <td><strong style="color:var(--teal-bright);font-family:'Roboto Mono',monospace">${fmt(c.total)}</strong></td>
      <td style="font-family:'Roboto Mono',monospace;font-size:12px">${c.pagoCon ? fmt(c.pagoCon) : '—'}</td>
      <td style="font-family:'Roboto Mono',monospace;font-size:12px;font-weight:600">${
        c.devuelta == null ? '—'
        : c.devuelta > 0  ? `<span style="color:var(--green)">${fmt(c.devuelta)}</span>`
        : c.devuelta === 0 ? `<span style="color:var(--teal-bright)">Exacto</span>`
        : `<span style="color:var(--coral)">Faltó ${fmt(Math.abs(c.devuelta))}</span>`
      }</td>
      <td style="white-space:nowrap">
        <button class="btn btn-primary btn-sm" onclick="generarPDF(${c.id})" style="margin-right:6px" title="Generar PDF">📄</button>
        <button class="btn btn-whatsapp btn-sm" onclick="enviarWhatsApp(${c.id})" style="margin-right:6px" title="Enviar por WhatsApp">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        </button>
        <button class="btn btn-ghost btn-sm" onclick="abrirEdicion(${c.id})" style="margin-right:6px" title="Editar">✏️</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarCot(${c.id})" title="Eliminar">🗑</button>
      </td>
    </tr>
  `).join('');
}

function filtrarHistorial() { renderHistorial(); }

function eliminarCot(id) {
  if (!confirm('¿Eliminar esta orden?')) return;
  ordenes = ordenes.filter(c => c.id !== id);
  // Registrar eliminación para sync bilateral
  const deleted = getDeletedIds();
  deleted[id] = new Date().toISOString();
  safeStorage.setItem(DELETED_IDS_KEY, JSON.stringify(deleted));
  safeStorage.setItem(STORAGE_KEY, JSON.stringify(ordenes));
  updateBadge();
  renderHistorial();
  toast('Orden eliminada');
  scheduleDriveSync();
}

// ─────────────────────────────────────────────
//  EXPORTAR EXCEL
// ─────────────────────────────────────────────
function exportarExcel() {
  if (ordenes.length === 0) { toast('No hay ordenes para exportar', true); return; }

  const rows = [];
  rows.push(['#', 'Fecha', 'Cliente', 'Celular', 'Especie', 'Cantidad (lb)', 'Precio/lb', 'Eviscerado', 'Subtotal Pescado', 'Subtotal Eviscerado', 'Total Especie', 'Total Orden']);

  ordenes.forEach((c, idx) => {
    c.items.forEach((item, iItem) => {
      rows.push([
        iItem === 0 ? ordenes.length - idx : '',
        iItem === 0 ? c.fecha : '',
        iItem === 0 ? c.nombre : '',
        iItem === 0 ? c.tel : '',
        item.especie,
        item.qty,
        item.precio,
        item.ev ? 'Sí' : 'No',
        item.subPescado,
        item.subEviscerado,
        item.subPescado + item.subEviscerado,
        iItem === 0 ? c.total : ''
      ]);
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = rows[0].map(() => ({ wch: 18 }));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ordenes');

  // Hoja resumen
  const resumen = buildExcelResumen();
  const ws2 = XLSX.utils.aoa_to_sheet(resumen);
  XLSX.utils.book_append_sheet(wb, ws2, 'Resumen por Especie');

  XLSX.writeFile(wb, `LagosLaIsabela_${new Date().toLocaleDateString('es-CO').replace(/\//g,'-')}.xlsx`);
  toast('📥 Excel exportado');
}

function buildExcelResumen() {
  const rows = [['Especie', 'Total Libras', 'Ingresos Pescado', 'Ingresos Eviscerado', 'Total']];
  const map = {};
  ordenes.forEach(c => {
    c.items.forEach(item => {
      if (!map[item.especie]) map[item.especie] = { lb:0, pescado:0, ev:0 };
      map[item.especie].lb      += item.qty;
      map[item.especie].pescado += item.subPescado;
      map[item.especie].ev      += item.subEviscerado;
    });
  });
  Object.entries(map).forEach(([k, v]) => {
    rows.push([k, v.lb, v.pescado, v.ev, v.pescado + v.ev]);
  });
  return rows;
}

// ─────────────────────────────────────────────
//  DASHBOARD — FILTRO DE FECHAS
// ─────────────────────────────────────────────
let activePeriod = 'today';
let customDesde  = null;
let customHasta  = null;

function setPeriod(period) {
  activePeriod = period;

  // Actualizar botones activos
  document.querySelectorAll('.period-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.period === period);
  });

  // Mostrar / ocultar rango personalizado
  const rangeEl = document.getElementById('custom-range');
  rangeEl.style.display = period === 'custom' ? 'flex' : 'none';

  if (period !== 'custom') renderDashboard();
}

function applyCustomRange() {
  const desde = document.getElementById('date-desde').value;
  const hasta = document.getElementById('date-hasta').value;
  if (!desde || !hasta) return;
  customDesde = desde;
  customHasta = hasta;
  renderDashboard();
}

function getFilteredOrdenes() {
  const now   = new Date();
  const hoy0  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
  const hoy23 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

  switch (activePeriod) {
    case 'today':
      return ordenes.filter(c => {
        const d = new Date(c.fechaObj);
        return d >= hoy0 && d <= hoy23;
      });

    case 'week': {
      const day  = now.getDay(); // 0=dom
      const diff = (day === 0) ? 6 : day - 1; // lunes = inicio
      const lunes  = new Date(hoy0); lunes.setDate(hoy0.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6); domingo.setHours(23,59,59,999);
      return ordenes.filter(c => {
        const d = new Date(c.fechaObj);
        return d >= lunes && d <= domingo;
      });
    }

    case 'month': {
      const inicio = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
      const fin    = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
      return ordenes.filter(c => {
        const d = new Date(c.fechaObj);
        return d >= inicio && d <= fin;
      });
    }

    case 'custom': {
      if (!customDesde || !customHasta) return ordenes;
      const desde = new Date(customDesde + 'T00:00:00');
      const hasta = new Date(customHasta + 'T23:59:59');
      return ordenes.filter(c => {
        const d = new Date(c.fechaObj);
        return d >= desde && d <= hasta;
      });
    }

    case 'all':
    default:
      return ordenes;
  }
}

// Aplica el mismo filtro de período a las ventas mayoristas
function getFilteredMayorista() {
  const now   = new Date();
  const hoy0  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
  const hoy23 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

  switch (activePeriod) {
    case 'today':
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= hoy0 && d <= hoy23; });
    case 'week': {
      const diff = (now.getDay() === 0) ? 6 : now.getDay() - 1;
      const lunes   = new Date(hoy0); lunes.setDate(hoy0.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6); domingo.setHours(23,59,59,999);
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= lunes && d <= domingo; });
    }
    case 'month': {
      const inicio = new Date(now.getFullYear(), now.getMonth(), 1);
      const fin    = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= inicio && d <= fin; });
    }
    case 'custom': {
      if (!customDesde || !customHasta) return mayorista;
      const desde = new Date(customDesde + 'T00:00:00');
      const hasta = new Date(customHasta + 'T23:59:59');
      return mayorista.filter(v => { const d = new Date(v.fechaObj); return d >= desde && d <= hasta; });
    }
    default: return mayorista;
  }
}

function getPeriodLabel() {
  const now = new Date();
  const fmtDate = d => d.toLocaleDateString('es-CO', { day:'numeric', month:'short' });

  switch (activePeriod) {
    case 'today':  return `Hoy, ${fmtDate(now)}`;
    case 'week': {
      const day  = now.getDay();
      const diff = (day === 0) ? 6 : day - 1;
      const lunes  = new Date(now); lunes.setDate(now.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6);
      return `${fmtDate(lunes)} – ${fmtDate(domingo)}`;
    }
    case 'month':
      return now.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
    case 'custom':
      if (!customDesde || !customHasta) return 'Rango personalizado';
      return `${fmtDate(new Date(customDesde+'T00:00:00'))} – ${fmtDate(new Date(customHasta+'T00:00:00'))}`;
    case 'all':
      return 'Todo el historial';
    default: return '';
  }
}

function renderDashboard() {
  const lista       = getFilteredOrdenes();
  const listaMay    = getFilteredMayorista();
  const periodLabel = getPeriodLabel();

  // Pill y etiquetas de período
  document.getElementById('period-pill').textContent = periodLabel;
  const sublabel = periodLabel;
  ['stat-period-label-1','stat-period-label-2','stat-period-label-3','stat-period-label-4'].forEach(id => {
    document.getElementById(id).textContent = sublabel;
  });
  document.getElementById('species-period-tag').textContent  = `· ${periodLabel}`;
  document.getElementById('finance-period-tag').textContent  = `· ${periodLabel}`;

  // Acumulados del período — detal
  const totalVentasDetal     = lista.reduce((s, c) => s + c.total, 0);
  const totalLibrasDetal     = lista.reduce((s, c) => s + c.totalLibras, 0);
  const totalEviscerado      = lista.reduce((s, c) => s + c.totalEviscerado, 0);
  const totalPescadoDetal    = lista.reduce((s, c) => s + c.totalPescado, 0);

  // Acumulados del período — mayorista
  const totalVentasMay  = listaMay.reduce((s, v) => s + v.total, 0);
  const totalLibrasMay  = listaMay.reduce((s, v) => s + v.totalLibras, 0);

  // Totales combinados
  const totalVentas = totalVentasDetal + totalVentasMay;
  const totalLibras = totalLibrasDetal + totalLibrasMay;
  const totalOrdenes = lista.length + listaMay.length;

  // Stat cards
  document.getElementById('stat-total-cot').textContent  = totalOrdenes;
  document.getElementById('stat-ventas-dia').textContent = fmtShort(totalVentas);
  document.getElementById('stat-libras-dia').textContent = totalLibras.toFixed(1) + ' lb';
  document.getElementById('stat-eviscerado').textContent = fmtShort(totalEviscerado);

  // Desglose detal/mayorista bajo la stat de ventas
  const desgloseEl = document.getElementById('stat-desglose-ventas');
  if (desgloseEl) {
    desgloseEl.innerHTML = totalVentasMay > 0
      ? `<span class="dash-pill-detal">Detal ${fmtShort(totalVentasDetal)}</span>
         <span class="dash-pill-mayor">Mayor ${fmtShort(totalVentasMay)}</span>`
      : `<span class="dash-pill-detal">Detal ${fmtShort(totalVentasDetal)}</span>`;
  }
  const desgloseLibEl = document.getElementById('stat-desglose-libras');
  if (desgloseLibEl) {
    desgloseLibEl.innerHTML = totalLibrasMay > 0
      ? `<span class="dash-pill-detal">${totalLibrasDetal.toFixed(1)} lb detal</span>
         <span class="dash-pill-mayor">${totalLibrasMay.toFixed(1)} lb mayor</span>`
      : `<span class="dash-pill-detal">${totalLibrasDetal.toFixed(1)} lb detal</span>`;
  }

  // Resumen financiero
  document.getElementById('fs-total-cot').textContent  = lista.length;
  document.getElementById('fs-libras').textContent     = totalLibrasDetal.toFixed(1) + ' lb';
  document.getElementById('fs-pescado').textContent    = fmt(totalPescadoDetal);
  document.getElementById('fs-eviscerado').textContent = fmt(totalEviscerado);
  document.getElementById('fs-total').textContent      = fmt(totalVentasDetal);

  // Filas mayorista en resumen financiero
  const fsMayEl = document.getElementById('fs-mayorista');
  if (fsMayEl) {
    fsMayEl.style.display = listaMay.length > 0 ? '' : 'none';
    document.getElementById('fs-may-count').textContent  = listaMay.length;
    document.getElementById('fs-may-libras').textContent = totalLibrasMay.toFixed(1) + ' lb';
    document.getElementById('fs-may-total').textContent  = fmt(totalVentasMay);
  }
  const fsTotalCombEl = document.getElementById('fs-total-combinado');
  if (fsTotalCombEl) {
    fsTotalCombEl.style.display = listaMay.length > 0 ? '' : 'none';
    document.getElementById('fs-gran-total').textContent = fmt(totalVentas);
  }

  // Estadísticas por especie (solo detal — mayorista tiene precios diferentes)
  const map = {};
  lista.forEach(c => {
    c.items.forEach(item => {
      if (!map[item.especie]) map[item.especie] = { lb: 0, total: 0 };
      map[item.especie].lb    += item.qty;
      map[item.especie].total += item.subPescado + item.subEviscerado;
    });
  });
  // Agregar mayorista al mapa de especies
  listaMay.forEach(v => {
    v.items.forEach(item => {
      if (!map[item.especie]) map[item.especie] = { lb: 0, total: 0 };
      map[item.especie].lb    += item.qty;
      map[item.especie].total += item.subTotal;
    });
  });

  const entries = Object.entries(map).sort((a, b) => b[1].total - a[1].total);
  const maxTotal = entries.length > 0 ? entries[0][1].total : 1;
  const cont = document.getElementById('species-stats');

  if (entries.length === 0) {
    cont.innerHTML = `<div class="empty-state" style="padding:24px"><div class="icon">📭</div><p>Sin ventas en el período seleccionado</p></div>`;
    return;
  }

  cont.innerHTML = entries.map(([esp, data]) => `
    <div class="species-bar">
      <div class="bar-label">${esp}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${Math.round(data.total / maxTotal * 100)}%"></div>
      </div>
      <div class="bar-value">${data.lb.toFixed(1)} lb</div>
    </div>
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;padding-left:152px">${fmt(data.total)}</div>
  `).join('');

  // Gráfico 15 días (siempre usa datos completos, sin filtro de período)
  requestAnimationFrame(() => renderChart15dias());
}

// ─────────────────────────────────────────────
//  UTILS
// ─────────────────────────────────────────────
function fmt(n) {
  return '$' + Math.round(n).toLocaleString('es-CO');
}

function fmtShort(n) {
  if (n >= 1000000) return '$' + (n/1000000).toFixed(1) + 'M';
  if (n >= 1000)    return '$' + (n/1000).toFixed(0) + 'K';
  return fmt(n);
}

function resetForm(silent = false) {
  if (!silent && !confirm('¿Limpiar el formulario? Se perderán los datos no guardados.')) return;
  document.getElementById('cliente-nombre').value = '';
  document.getElementById('cliente-tel').value = '';
  document.getElementById('cliente-cc').value = '';
  ESPECIES.forEach(e => {
    document.getElementById(`qty-${e.id}`).value = '';
    document.getElementById(`ev-${e.id}`).checked = false;
    if (e.precio === null) document.getElementById(`precio-${e.id}`).value = '';
    document.getElementById(`sc-${e.id}`).classList.remove('has-value');
    document.getElementById(`sub-${e.id}`).textContent = '$0';
    document.getElementById(`sub-label-${e.id}`).textContent = '— lb';
  });
  document.getElementById('total-display').textContent = '$0';
  document.getElementById('total-details').textContent = '— libras · Eviscerado: $0';
  document.getElementById('pago-input').value = '';
  const dev = document.getElementById('devuelta-display');
  dev.textContent = '—';
  dev.className = 'devuelta-amount pending';
  if (!silent) toast('Formulario limpiado');
}

function updateBadge() {
  document.getElementById('badge-count').textContent = ordenes.length;
  updateEvBadge();
  updateClientesBadge();
  document.getElementById('badge-mayorista').textContent = mayorista.length;
}

function updateClientesBadge() {
  // Badge muestra total de clientes únicos (directorio + historial)
  const todos = getTodosClientes();
  document.getElementById('badge-clientes').textContent = todos.length;
}

// ─────────────────────────────────────────────
//  CLIENTES
// ─────────────────────────────────────────────

// Devuelve lista unificada: clientes del directorio + clientes que solo
// aparecen en el historial (sin duplicados por nombre normalizado o tel o cc).
// Cada entrada incluye: id, nombre, tel, cc, compras (count), totalComprado, origen
function getTodosClientes() {
  // Empezar con los del directorio
  const map = new Map(); // key: nombre.toLowerCase()

  clientes.forEach(c => {
    const key = c.nombre.trim().toLowerCase();
    map.set(key, {
      ...c,
      compras:       0,
      totalComprado: 0,
      origen:        'directorio'
    });
  });

  // Agregar/enriquecer con datos del historial
  ordenes.forEach(o => {
    if (!o.nombre) return;
    const key = o.nombre.trim().toLowerCase();
    if (map.has(key)) {
      const entry = map.get(key);
      entry.compras++;
      entry.totalComprado += (o.total || 0);
      // Completar campos vacíos con lo que hay en la orden
      if (!entry.tel && o.tel) entry.tel = o.tel;
      if (!entry.cc  && o.cc)  entry.cc  = o.cc;
    } else {
      map.set(key, {
        id:            'hist_' + key,
        nombre:        o.nombre,
        tel:           o.tel  || '',
        cc:            o.cc   || '',
        creadoEn:      o.fechaObj,
        lastUpdated:   o.fechaObj,
        compras:       1,
        totalComprado: o.total || 0,
        origen:        'historial'
      });
    }
  });

  return Array.from(map.values())
    .sort((a, b) => a.nombre.localeCompare(b.nombre, 'es'));
}

function agregarCliente() {
  const nombre = document.getElementById('cli-nombre').value.trim();
  const tel    = document.getElementById('cli-tel').value.trim();
  const cc     = document.getElementById('cli-cc').value.trim();

  if (!nombre) { toast('El nombre es obligatorio', true); return; }

  // Evitar duplicados exactos por nombre
  const existe = clientes.find(c => c.nombre.trim().toLowerCase() === nombre.toLowerCase());
  if (existe) { toast('Ya existe un cliente con ese nombre', true); return; }

  const now = new Date().toISOString();
  const nuevo = { id: Date.now(), nombre, tel, cc, creadoEn: now, lastUpdated: now };
  clientes.unshift(nuevo);
  safeStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));

  document.getElementById('cli-nombre').value = '';
  document.getElementById('cli-tel').value    = '';
  document.getElementById('cli-cc').value     = '';

  updateClientesBadge();
  renderClientes();
  scheduleDriveSync();
  toast('✅ Cliente guardado');
}

function eliminarCliente(id) {
  if (!confirm('¿Eliminar este cliente del directorio?')) return;
  clientes = clientes.filter(c => c.id !== id);
  safeStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));
  updateClientesBadge();
  renderClientes();
  scheduleDriveSync();
  toast('Cliente eliminado');
}

let editingClienteId   = null;
let editingClienteOrig = null; // 'directorio' | 'historial'

function abrirEdicionCliente(id, nombre, tel, cc, origen) {
  editingClienteId   = id;
  editingClienteOrig = origen;

  document.getElementById('cli-edit-nombre').value = nombre;
  document.getElementById('cli-edit-tel').value    = tel;
  document.getElementById('cli-edit-cc').value     = cc;
  document.getElementById('cli-edit-historial-note').style.display =
    origen === 'historial' ? 'block' : 'none';

  document.getElementById('cli-modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  document.getElementById('cli-edit-nombre').focus();
}

function closeCliModal() {
  document.getElementById('cli-modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
  editingClienteId   = null;
  editingClienteOrig = null;
}

function closeCLiModalOutside(e) {
  if (e.target === document.getElementById('cli-modal-overlay')) closeCliModal();
}

function guardarEdicionCliente() {
  const nombre = document.getElementById('cli-edit-nombre').value.trim();
  const tel    = document.getElementById('cli-edit-tel').value.trim();
  const cc     = document.getElementById('cli-edit-cc').value.trim();

  if (!nombre) { toast('El nombre es obligatorio', true); return; }

  const now = new Date().toISOString();

  if (editingClienteOrig === 'directorio') {
    // Editar entrada existente en el directorio
    const idx = clientes.findIndex(c => c.id === editingClienteId);
    if (idx !== -1) {
      clientes[idx] = { ...clientes[idx], nombre, tel, cc, lastUpdated: now };
      safeStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));
    }
  } else {
    // Cliente del historial: promoverlo al directorio con los datos editados
    // Verificar que no exista ya en directorio con ese nombre
    const yaExiste = clientes.find(c =>
      c.nombre.trim().toLowerCase() === nombre.toLowerCase()
    );
    if (yaExiste) {
      toast('Ya existe un cliente con ese nombre en el directorio', true);
      return;
    }
    const nuevo = { id: Date.now(), nombre, tel, cc, creadoEn: now, lastUpdated: now };
    clientes.unshift(nuevo);
    safeStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));
  }

  closeCliModal();
  updateClientesBadge();
  renderClientes();
  scheduleDriveSync();
  toast('✅ Cliente actualizado');
}

function renderClientes() {
  const q      = (document.getElementById('cli-search')?.value || '').toLowerCase().trim();
  const tbody  = document.getElementById('clientes-tbody');
  const empty  = document.getElementById('clientes-empty');

  let lista = getTodosClientes();

  if (q) {
    lista = lista.filter(c =>
      c.nombre.toLowerCase().includes(q) ||
      (c.tel || '').includes(q) ||
      (c.cc  || '').toLowerCase().includes(q)
    );
  }

  if (lista.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = lista.map((c, i) => `
    <tr data-cid="${c.id}" data-ckey="${encodeURIComponent(c.nombre.trim().toLowerCase())}">
      <td style="color:var(--text-muted);font-size:12px">${i + 1}</td>
      <td>
        <strong style="color:var(--text-primary)">${c.nombre}</strong>
        ${c.perfil?.estado === 'vetado' ? '<span style="margin-left:6px;font-size:10px;font-weight:700;color:var(--coral);background:rgba(255,82,82,0.12);border:1px solid rgba(255,82,82,0.25);border-radius:20px;padding:1px 7px">VETADO</span>' : ''}
      </td>
      <td style="font-size:13px">${c.tel || '—'}</td>
      <td style="font-family:'Roboto Mono',monospace;font-size:12px;color:var(--text-secondary)">${c.cc || '—'}</td>
      <td>
        <span class="cli-compras-badge ${c.compras === 0 ? 'cero' : ''}">
          ${c.compras === 0 ? 'Sin compras' : `${c.compras} compra${c.compras !== 1 ? 's' : ''}`}
        </span>
      </td>
      <td>
        <span class="cli-total ${c.totalComprado === 0 ? 'cero' : ''}">
          ${c.totalComprado === 0 ? '—' : fmt(c.totalComprado)}
        </span>
      </td>
      <td>
        <span class="cli-origen">
          ${c.origen === 'directorio' ? '📁 Directorio' : '🛒 Historial'}
        </span>
      </td>
      <td style="white-space:nowrap" class="cli-action-cell">
        <button class="btn btn-ghost btn-sm cli-edit-btn"
          data-id="${c.id}"
          data-nombre="${encodeURIComponent(c.nombre)}"
          data-tel="${encodeURIComponent(c.tel||'')}"
          data-cc="${encodeURIComponent(c.cc||'')}"
          data-origen="${c.origen}"
          title="Editar">✏️</button>
        ${c.origen === 'directorio'
          ? `<button class="btn btn-danger btn-sm cli-del-btn" data-id="${c.id}" title="Eliminar">🗑</button>`
          : ''
        }
      </td>
    </tr>
  `).join('');

  // Clic en fila → abrir perfil (excepto si se hace clic en la celda de acciones)
  tbody.querySelectorAll('tr').forEach(row => {
    row.addEventListener('click', (e) => {
      if (e.target.closest('.cli-action-cell')) return;
      const key = decodeURIComponent(row.dataset.ckey);
      const cid = row.dataset.cid;
      abrirPerfilCliente(cid, key);
    });
  });

  // Botones editar
  tbody.querySelectorAll('.cli-edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      abrirEdicionCliente(
        isNaN(btn.dataset.id) ? btn.dataset.id : Number(btn.dataset.id),
        decodeURIComponent(btn.dataset.nombre),
        decodeURIComponent(btn.dataset.tel),
        decodeURIComponent(btn.dataset.cc),
        btn.dataset.origen
      );
    });
  });

  // Botones eliminar
  tbody.querySelectorAll('.cli-del-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      eliminarCliente(isNaN(btn.dataset.id) ? btn.dataset.id : Number(btn.dataset.id));
    });
  });
}

// ─────────────────────────────────────────────
//  PERFIL DE CLIENTE
// ─────────────────────────────────────────────
let perfilClienteId   = null;  // id numérico (directorio) o 'hist_key'
let perfilClienteKey  = null;  // nombre.trim().toLowerCase()
let perfilDirtyFlag   = false;
let edadInterval      = null;

function abrirPerfilCliente(cid, ckey) {
  perfilClienteId  = cid;
  perfilClienteKey = ckey;
  perfilDirtyFlag  = false;

  // Obtener el cliente unificado
  const todos  = getTodosClientes();
  const c      = todos.find(x => String(x.id) === String(cid) || x.nombre.trim().toLowerCase() === ckey);
  if (!c) return;

  // Buscar perfil extra en directorio (solo directorio tiene perfil)
  const dirEntry = clientes.find(x => String(x.id) === String(cid));
  const perfil   = dirEntry?.perfil || {};

  // ── Cabecera ──
  const genero = perfil.genero || '';
  const avatarEl = document.getElementById('prof-avatar');
  avatarEl.textContent = genero === 'femenino' ? '👩' : genero === 'masculino' ? '👨' : '👤';
  avatarEl.className   = `profile-avatar ${genero || 'otro'}`;

  document.getElementById('prof-nombre').textContent = c.nombre;

  // Meta: origen + fecha registro
  const metaEl = document.getElementById('prof-meta');
  const reg = c.creadoEn ? new Date(c.creadoEn).toLocaleDateString('es-CO', { day:'numeric', month:'short', year:'numeric' }) : '—';
  metaEl.innerHTML = `
    <span>${c.origen === 'directorio' ? '📁 Directorio' : '🛒 Historial'}</span>
    <span>· Desde ${reg}</span>
  `;

  // Estado
  const estado = perfil.estado || 'activo';
  actualizarBotonesEstado(estado);

  // ── Datos de contacto ──
  const contactoGrid = document.getElementById('prof-contacto-grid');
  contactoGrid.innerHTML = `
    <div class="profile-info-item">
      <div class="profile-info-label">📞 Celular</div>
      <div class="profile-info-value mono ${c.tel ? '' : 'muted'}">${c.tel || '—'}</div>
    </div>
    <div class="profile-info-item">
      <div class="profile-info-label">🪪 CC / NIT</div>
      <div class="profile-info-value mono ${c.cc ? '' : 'muted'}">${c.cc || '—'}</div>
    </div>
    <div class="profile-info-item ${perfil.email ? '' : 'muted'}">
      <div class="profile-info-label">✉️ Correo</div>
      <div class="profile-info-value ${perfil.email ? '' : 'muted'}">${perfil.email || '—'}</div>
    </div>
    <div class="profile-info-item">
      <div class="profile-info-label">📍 Residencia</div>
      <div class="profile-info-value ${perfil.residencia ? '' : 'muted'}">${perfil.residencia || '—'}</div>
    </div>
    ${perfil.nacimiento ? `
    <div class="profile-info-item full">
      <div class="profile-info-label">🎂 Edad</div>
      <div class="profile-info-value" id="prof-edad-display">—</div>
    </div>` : ''}
  `;

  // ── Top 3 especies (últimos 2 años) ──
  const hace2a = new Date(); hace2a.setFullYear(hace2a.getFullYear() - 2);
  const specMap = {};
  ordenes.forEach(o => {
    if (!o.nombre) return;
    if (o.nombre.trim().toLowerCase() !== ckey) return;
    const d = new Date(o.fechaObj);
    if (d < hace2a) return;
    (o.items || []).forEach(item => {
      if (!specMap[item.especie]) specMap[item.especie] = { lb: 0, total: 0 };
      specMap[item.especie].lb    += item.qty || 0;
      specMap[item.especie].total += (item.subPescado || 0) + (item.subEviscerado || 0);
    });
  });

  const top3 = Object.entries(specMap)
    .sort((a, b) => b[1].lb - a[1].lb)
    .slice(0, 3);
  const maxLb = top3.length > 0 ? top3[0][1].lb : 1;

  const topEl = document.getElementById('prof-top-especies');
  if (top3.length === 0) {
    topEl.innerHTML = `<div class="profile-info-value muted" style="font-size:13px;padding:8px 0">Sin compras registradas en los últimos 2 años</div>`;
  } else {
    const rankClass = ['rank-1','rank-2','rank-3'];
    const rankLabel = ['1°','2°','3°'];
    topEl.innerHTML = top3.map(([esp, data], i) => `
      <div class="top-especie-row">
        <div class="top-especie-rank ${rankClass[i]}">${rankLabel[i]}</div>
        <div class="top-especie-info">
          <div class="top-especie-name">${esp}</div>
          <div class="top-especie-bar-track">
            <div class="top-especie-bar-fill" style="width:${Math.round(data.lb / maxLb * 100)}%"></div>
          </div>
        </div>
        <div class="top-especie-lb">${data.lb.toFixed(1)} lb</div>
      </div>
    `).join('');
  }

  // ── Indicador eviscerado ──
  const usaEv = ordenes.some(o =>
    o.nombre?.trim().toLowerCase() === ckey &&
    (o.totalEviscerado || 0) > 0
  );
  document.getElementById('prof-ev-indicator').innerHTML = `
    <div class="ev-indicator ${usaEv ? 'yes' : 'no'}">
      <span style="font-size:16px">🔪</span>
      ${usaEv
        ? 'Este cliente ha tomado el servicio de eviscerado'
        : 'No ha solicitado eviscerado en sus compras'}
    </div>
  `;

  // ── Campos de caracterización ──
  document.getElementById('prof-genero').value      = perfil.genero     || '';
  document.getElementById('prof-nacimiento').value  = perfil.nacimiento || '';
  document.getElementById('prof-residencia').value  = perfil.residencia || '';
  document.getElementById('prof-email').value       = perfil.email      || '';
  document.getElementById('prof-notas').value       = perfil.notas      || '';

  // Edad en tiempo real
  if (edadInterval) clearInterval(edadInterval);
  if (perfil.nacimiento) actualizarEdad(perfil.nacimiento);

  // Botón guardar oculto hasta que haya cambios
  document.getElementById('prof-save-btn').style.display = 'none';
  perfilDirtyFlag = false;

  // Abrir panel
  document.getElementById('cli-profile-overlay').classList.add('open');
  document.getElementById('cli-profile-panel').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function actualizarEdad(nacFijo) {
  const nac = nacFijo || document.getElementById('prof-nacimiento').value;
  const el  = document.getElementById('prof-edad-display');
  if (!nac || !el) { if (el) el.textContent = '—'; return; }

  const calcular = () => {
    const hoy  = new Date();
    const born = new Date(nac + 'T00:00:00');
    let age = hoy.getFullYear() - born.getFullYear();
    const m = hoy.getMonth() - born.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < born.getDate())) age--;
    const elNow = document.getElementById('prof-edad-display');
    if (elNow) elNow.textContent = age >= 0 ? `${age} años` : '—';
  };

  calcular();
  if (edadInterval) clearInterval(edadInterval);
  // Recalcular cada día a medianoche (con un interval diario)
  edadInterval = setInterval(calcular, 86400000);
}

function actualizarBotonesEstado(estado) {
  const btn  = document.getElementById('prof-status-btn');
  const text = document.getElementById('prof-status-text');
  btn.className  = `profile-status ${estado}`;
  text.textContent = estado === 'vetado' ? 'VETADO' : 'ACTIVO';
  document.getElementById('prof-status-dot').textContent = '●';
}

function toggleEstadoCliente() {
  // Solo directorio puede cambiar estado
  const dirEntry = clientes.find(x => String(x.id) === String(perfilClienteId));
  if (!dirEntry) { toast('Solo los clientes del directorio pueden ser vetados/activados', true); return; }

  const actual  = dirEntry.perfil?.estado || 'activo';
  const nuevo   = actual === 'vetado' ? 'activo' : 'vetado';
  const accion  = nuevo === 'vetado' ? 'vetar' : 'reactivar';
  if (!confirm(`¿Deseas ${accion} a ${dirEntry.nombre}?`)) return;

  dirEntry.perfil = { ...(dirEntry.perfil || {}), estado: nuevo, lastUpdated: new Date().toISOString() };
  dirEntry.lastUpdated = new Date().toISOString();
  safeStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));
  actualizarBotonesEstado(nuevo);
  renderClientes();
  scheduleDriveSync();
  toast(nuevo === 'vetado' ? '🚫 Cliente vetado' : '✅ Cliente reactivado');
}

function marcarCambio() {
  perfilDirtyFlag = true;
  document.getElementById('prof-save-btn').style.display = '';

  // Actualizar avatar según género seleccionado
  const genero  = document.getElementById('prof-genero').value;
  const avatarEl = document.getElementById('prof-avatar');
  avatarEl.textContent = genero === 'femenino' ? '👩' : genero === 'masculino' ? '👨' : '👤';
  avatarEl.className   = `profile-avatar ${genero || 'otro'}`;

  // Actualizar edad si cambia la fecha
  actualizarEdad();
}

function guardarPerfilCliente() {
  // Solo directorio tiene perfil guardable
  let dirEntry = clientes.find(x => String(x.id) === String(perfilClienteId));

  if (!dirEntry) {
    // Cliente del historial: promoverlo al directorio primero
    const todos = getTodosClientes();
    const c = todos.find(x => x.nombre.trim().toLowerCase() === perfilClienteKey);
    if (!c) return;
    const now = new Date().toISOString();
    dirEntry = { id: Date.now(), nombre: c.nombre, tel: c.tel || '', cc: c.cc || '', creadoEn: now, lastUpdated: now, perfil: {} };
    clientes.unshift(dirEntry);
    perfilClienteId = dirEntry.id;
  }

  dirEntry.perfil = {
    ...(dirEntry.perfil || {}),
    genero:      document.getElementById('prof-genero').value,
    nacimiento:  document.getElementById('prof-nacimiento').value,
    residencia:  document.getElementById('prof-residencia').value.trim(),
    email:       document.getElementById('prof-email').value.trim(),
    notas:       document.getElementById('prof-notas').value.trim(),
  };
  dirEntry.lastUpdated = new Date().toISOString();

  safeStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));
  perfilDirtyFlag = false;
  document.getElementById('prof-save-btn').style.display = 'none';
  renderClientes();
  scheduleDriveSync();
  toast('✅ Perfil guardado');
}

function cerrarPerfil() {
  if (perfilDirtyFlag && !confirm('¿Cerrar sin guardar los cambios?')) return;
  document.getElementById('cli-profile-overlay').classList.remove('open');
  document.getElementById('cli-profile-panel').classList.remove('open');
  document.body.style.overflow = '';
  if (edadInterval) { clearInterval(edadInterval); edadInterval = null; }
  perfilClienteId  = null;
  perfilClienteKey = null;
  perfilDirtyFlag  = false;
}

function toast(msg, isError = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (isError ? ' error' : '');
  setTimeout(() => el.className = '', 3000);
}

function clearAllData() {
  if (!confirm('¿Borrar TODAS las ordenes? Esta acción es irreversible.')) return;
  ordenes = [];
  safeStorage.removeItem(STORAGE_KEY);
  updateBadge();
  renderDashboard();
  toast('Historial borrado');
  scheduleDriveSync();
}

// ─────────────────────────────────────────────
//  MODAL EDICIÓN
// ─────────────────────────────────────────────
let editingId = null;
let editItems = [];

function abrirEdicion(id) {
  const cot = ordenes.find(c => c.id === id);
  if (!cot) return;

  editingId = id;
  // Deep copy de los items para editar sin mutar el original
  editItems = cot.items.map(i => ({ ...i }));

  document.getElementById('edit-nombre').value = cot.nombre;
  document.getElementById('edit-tel').value    = cot.tel || '';
  document.getElementById('edit-cc').value     = cot.cc  || '';

  // Poblar select de especies
  const sel = document.getElementById('add-especie');
  sel.innerHTML = '<option value="">— Seleccionar —</option>' +
    ESPECIES.map(e => `<option value="${e.id}" data-precio="${e.precio ?? ''}" data-nombre="${e.nombre}">${e.nombre}</option>`).join('');

  sel.onchange = () => {
    const opt = sel.options[sel.selectedIndex];
    const precio = opt.dataset.precio;
    document.getElementById('add-precio-wrap').style.display = precio === '' ? 'block' : 'none';
  };

  renderEditItems();
  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
  editingId = null;
  editItems = [];
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function renderEditItems() {
  const tbody = document.getElementById('edit-items-tbody');

  tbody.innerHTML = editItems.map((item, idx) => {
    const subTotal = (item.qty * item.precio) + (item.ev ? item.qty * EVISCERA_COSTO : 0);
    return `
    <tr>
      <td style="font-weight:600;min-width:120px">${item.especie}</td>
      <td>
        <input type="number" min="0.1" step="0.1" value="${item.qty}"
          oninput="updateEditItem(${idx},'qty',this.value)" style="max-width:80px">
      </td>
      <td>
        <input type="number" min="0" step="100" value="${item.precio}"
          oninput="updateEditItem(${idx},'precio',this.value)" style="max-width:90px">
      </td>
      <td>
        <select onchange="updateEditItem(${idx},'ev',this.value)"
          style="background:var(--input-bg);border:1px solid rgba(0,180,216,0.25);border-radius:6px;padding:6px 9px;color:var(--text-primary);font-family:'DM Sans',sans-serif;font-size:13px;">
          <option value="0" ${!item.ev ? 'selected' : ''}>No</option>
          <option value="1" ${item.ev  ? 'selected' : ''}>Sí ✓</option>
        </select>
      </td>
      <td style="font-family:'Roboto Mono',monospace;font-size:13px;color:var(--gold);white-space:nowrap" id="edit-sub-${idx}">
        ${fmt(subTotal)}
      </td>
      <td>
        <button class="btn-icon remove" onclick="removeEditItem(${idx})" title="Eliminar">×</button>
      </td>
    </tr>`;
  }).join('');

  recalcEditTotal();
}

function updateEditItem(idx, field, value) {
  if (field === 'ev') {
    editItems[idx].ev = value === '1';
  } else {
    editItems[idx][field] = parseFloat(value) || 0;
  }
  // Actualizar subtotal de esa fila
  const item = editItems[idx];
  const sub = (item.qty * item.precio) + (item.ev ? item.qty * EVISCERA_COSTO : 0);
  const cell = document.getElementById(`edit-sub-${idx}`);
  if (cell) cell.textContent = fmt(sub);
  recalcEditTotal();
}

function removeEditItem(idx) {
  editItems.splice(idx, 1);
  renderEditItems();
}

function addEditItem() {
  const sel      = document.getElementById('add-especie');
  const opt      = sel.options[sel.selectedIndex];
  const qtyVal   = parseFloat(document.getElementById('add-qty').value) || 0;
  const evVal    = document.getElementById('add-ev').value === '1';
  const precioData = opt.dataset.precio;

  if (!opt.value) { toast('Selecciona una especie', true); return; }
  if (qtyVal <= 0)  { toast('Ingresa una cantidad mayor a 0', true); return; }

  let precio;
  if (precioData === '') {
    precio = parseFloat(document.getElementById('add-precio').value) || 0;
    if (precio <= 0) { toast('Ingresa el precio por libra', true); return; }
  } else {
    precio = parseFloat(precioData);
  }

  const subPescado    = qtyVal * precio;
  const subEviscerado = evVal ? qtyVal * EVISCERA_COSTO : 0;

  editItems.push({
    especie: opt.dataset.nombre,
    qty: qtyVal,
    precio,
    ev: evVal,
    subPescado,
    subEviscerado
  });

  // Limpiar campos de agregar
  sel.value = '';
  document.getElementById('add-qty').value   = '';
  document.getElementById('add-precio').value = '';
  document.getElementById('add-ev').value    = '0';
  document.getElementById('add-precio-wrap').style.display = 'none';

  renderEditItems();
  toast('Especie agregada ✓');
}

function recalcEditTotal() {
  let totalPescado = 0, totalEviscerado = 0, totalLibras = 0;
  editItems.forEach(item => {
    const sub = item.qty * item.precio;
    const ev  = item.ev ? item.qty * EVISCERA_COSTO : 0;
    // Recalcular subPescado / subEviscerado en el objeto también
    item.subPescado    = sub;
    item.subEviscerado = ev;
    totalPescado    += sub;
    totalEviscerado += ev;
    totalLibras     += item.qty;
  });
  const total = totalPescado + totalEviscerado;
  document.getElementById('edit-total-display').textContent = fmt(total);
  document.getElementById('edit-total-detail').textContent =
    `${totalLibras.toFixed(1)} lb · Eviscerado: ${fmt(totalEviscerado)}`;
}

function guardarEdicion() {
  const nombre = document.getElementById('edit-nombre').value.trim();
  const tel    = document.getElementById('edit-tel').value.trim();
  const cc     = document.getElementById('edit-cc').value.trim();

  if (!nombre)           { toast('El nombre no puede estar vacío', true); return; }
  if (editItems.length === 0) { toast('Debe haber al menos una especie', true); return; }

  let totalPescado = 0, totalEviscerado = 0, totalLibras = 0;
  editItems.forEach(item => {
    totalPescado    += item.subPescado;
    totalEviscerado += item.subEviscerado;
    totalLibras     += item.qty;
  });

  const idx = ordenes.findIndex(c => c.id === editingId);
  if (idx === -1) { toast('Orden no encontrada', true); return; }

  ordenes[idx] = {
    ...ordenes[idx],
    nombre,
    tel,
    cc,
    items: editItems,
    totalPescado,
    totalEviscerado,
    totalLibras,
    total: totalPescado + totalEviscerado,
    editadoEn: new Date().toLocaleString('es-CO'),
    lastUpdated: new Date().toISOString()
  };

  safeStorage.setItem(STORAGE_KEY, JSON.stringify(ordenes));
  closeModal();
  renderHistorial();
  renderDashboard();
  toast('✅ Orden actualizada correctamente');
  scheduleDriveSync();
}

// ═════════════════════════════════════════════
//  GOOGLE DRIVE SYNC ENGINE  v2 — bilateral
// ═════════════════════════════════════════════
const DRIVE_CLIENT_ID_KEY = 'aquacot_client_id';
const DRIVE_TOKEN_KEY     = 'aquacot_drive_token';
const DRIVE_FILE_NAME     = 'lagos-isabela-data.json';
const DRIVE_SCOPE         = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file';
const HARDCODED_CLIENT_ID = '355744497215-b46rsra82q7sgk2j6r4ekoobiq8pgq6d.apps.googleusercontent.com';
const DELETED_IDS_KEY     = 'aquacot_deleted_ids';

let driveToken    = null;
let driveFileId   = null;
let syncPending   = false;   // hay cambios locales pendientes de subir
let syncDebounce  = null;    // timer para el debounce al guardar
let autoSyncTimer = null;    // interval cada 20s

// ── Helpers para deletedIds ──────────────────
// deletedIds: { [id]: isoTimestamp } — registro de qué se eliminó y cuándo
function getDeletedIds() {
  try { return JSON.parse(safeStorage.getItem(DELETED_IDS_KEY) || '{}'); }
  catch(e) { return {}; }
}
function saveDeletedIds(obj) {
  safeStorage.setItem(DELETED_IDS_KEY, JSON.stringify(obj));
}

// ── Guardar estado de UI para restaurar tras sync ──
function captureUIState() {
  return {
    tab:           activeTab,
    scrollY:       window.scrollY,
    // Dashboard
    dashPeriod:    activePeriod,
    dashDesde:     customDesde,
    dashHasta:     customHasta,
    // Eviscerado
    evPeriod:      activeEvPeriod,
    evDesde:       evCustomDesde,
    evHasta:       evCustomHasta,
    // Historial búsqueda
    searchNombre:  document.getElementById('search-nombre')?.value || '',
    searchTel:     document.getElementById('search-tel')?.value    || '',
    searchCc:      document.getElementById('search-cc')?.value     || '',
  };
}

function restoreUIState(state) {
  if (!state) return;

  // Restaurar tab
  showTab(state.tab);

  // Restaurar filtros Dashboard
  if (state.dashPeriod && state.dashPeriod !== activePeriod) {
    activePeriod = state.dashPeriod;
    document.querySelectorAll('[data-period]').forEach(b =>
      b.classList.toggle('active', b.dataset.period === activePeriod)
    );
    if (activePeriod === 'custom') {
      document.getElementById('custom-range').style.display = 'flex';
      customDesde = state.dashDesde;
      customHasta = state.dashHasta;
      if (customDesde) document.getElementById('date-desde').value = customDesde;
      if (customHasta) document.getElementById('date-hasta').value = customHasta;
    }
  }

  // Restaurar filtros Eviscerado
  if (state.evPeriod && state.evPeriod !== activeEvPeriod) {
    activeEvPeriod = state.evPeriod;
    document.querySelectorAll('[data-evperiod]').forEach(b =>
      b.classList.toggle('active', b.dataset.evperiod === activeEvPeriod)
    );
    if (activeEvPeriod === 'custom') {
      document.getElementById('ev-custom-range').style.display = 'flex';
      evCustomDesde = state.evDesde;
      evCustomHasta = state.evHasta;
      if (evCustomDesde) document.getElementById('ev-date-desde').value = evCustomDesde;
      if (evCustomHasta) document.getElementById('ev-date-hasta').value = evCustomHasta;
    }
  }

  // Restaurar búsqueda del historial
  if (state.searchNombre) document.getElementById('search-nombre').value = state.searchNombre;
  if (state.searchTel)    document.getElementById('search-tel').value    = state.searchTel;
  if (state.searchCc)     document.getElementById('search-cc').value     = state.searchCc;

  // Restaurar scroll (ligero delay para que el DOM esté pintado)
  requestAnimationFrame(() => window.scrollTo({ top: state.scrollY, behavior: 'instant' }));
}

// ── Merge bilateral: "el más reciente gana" ─
// Recibe datos locales y remotos, devuelve el resultado fusionado
function mergeBilateral(localOrdenes, remoteData) {
  const remoteOrdenes  = remoteData.ordenes  || [];
  const remoteDeleted  = remoteData.deletedIds || {};
  const localDeleted   = getDeletedIds();

  // Unir todos los registros de eliminación de ambos lados
  const allDeleted = { ...localDeleted, ...remoteDeleted };
  // Guardar la unión localmente para que la próxima subida la incluya
  saveDeletedIds(allDeleted);

  // Construir mapa unificado: id → orden (gana el lastUpdated mayor)
  const map = new Map();

  for (const orden of localOrdenes) {
    map.set(orden.id, orden);
  }
  for (const orden of remoteOrdenes) {
    const existing = map.get(orden.id);
    if (!existing) {
      map.set(orden.id, orden);
    } else {
      // Gana el más recientemente modificado
      const localTs  = existing.lastUpdated  ? new Date(existing.lastUpdated).getTime()  : 0;
      const remoteTs = orden.lastUpdated      ? new Date(orden.lastUpdated).getTime()     : 0;
      if (remoteTs > localTs) map.set(orden.id, orden);
    }
  }

  // Aplicar eliminaciones: quitar cualquier orden que esté en allDeleted
  // Solo la quitamos si el timestamp de eliminación es POSTERIOR al lastUpdated de la orden
  // (evita borrar una orden que fue re-creada después de eliminarse)
  for (const [deletedId, deletedAt] of Object.entries(allDeleted)) {
    const id = parseInt(deletedId);
    const existing = map.get(id);
    if (existing) {
      const updatedTs = existing.lastUpdated ? new Date(existing.lastUpdated).getTime() : 0;
      const deletedTs = new Date(deletedAt).getTime();
      if (deletedTs >= updatedTs) map.delete(id);
    }
  }

  // Convertir a array y ordenar más reciente primero
  return Array.from(map.values())
    .sort((a, b) => new Date(b.fechaObj) - new Date(a.fechaObj));
}

// ── evDone bilateral ─────────────────────────
// evDone también se sincroniza: gana la unión de los sets de ambos dispositivos
function mergeEvDone(localDone, remoteDone) {
  const remoteSet = new Set(remoteDone || []);
  const localSet  = getEvDone();
  return new Set([...localSet, ...remoteSet]);
}

// ── Clientes bilateral ───────────────────────
function mergeClientes(localClientes, remoteClientes) {
  const map = new Map();
  localClientes.forEach(c => map.set(c.id, c));
  (remoteClientes || []).forEach(c => {
    const existing = map.get(c.id);
    if (!existing) {
      map.set(c.id, c);
    } else {
      const localTs  = existing.lastUpdated ? new Date(existing.lastUpdated).getTime() : 0;
      const remoteTs = c.lastUpdated        ? new Date(c.lastUpdated).getTime()        : 0;
      if (remoteTs > localTs) map.set(c.id, c);
    }
  });
  return Array.from(map.values())
    .sort((a, b) => new Date(b.creadoEn) - new Date(a.creadoEn));
}

// ── Mayorista bilateral ──────────────────────
function mergeMayorista(localMay, remoteMay) {
  const map = new Map();
  localMay.forEach(v => map.set(v.id, v));
  (remoteMay || []).forEach(v => {
    const existing = map.get(v.id);
    if (!existing) {
      map.set(v.id, v);
    } else {
      const localTs  = existing.lastUpdated ? new Date(existing.lastUpdated).getTime() : 0;
      const remoteTs = v.lastUpdated        ? new Date(v.lastUpdated).getTime()        : 0;
      if (remoteTs > localTs) map.set(v.id, v);
    }
  });
  return Array.from(map.values())
    .sort((a, b) => new Date(b.fechaObj) - new Date(a.fechaObj));
}

// ── Refrescar UI preservando estado ─────────
function refreshUI(uiState) {
  updateBadge();
  updateEvBadge();
  renderHistorial();
  renderDashboard();
  renderEviscerado();
  renderClientes();
  renderMayorista();
  if (uiState) restoreUIState(uiState);
}

// ── Estado UI ──────────────────────────────
function setDriveStatus(state, text, syncTime) {
  const btn  = document.getElementById('drive-status-btn');
  const span = document.getElementById('drive-status-text');
  btn.className = 'drive-status-bar ' + (state || '');
  let label = text;
  if (syncTime) label += ` <span class="drive-sync-time">· ${syncTime}</span>`;
  span.innerHTML = label;
}

// ── Setup Modal ─────────────────────────────
function openSetupModal() {
  const overlay = document.getElementById('setup-modal-overlay');
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';

  if (driveToken) {
    document.getElementById('drive-setup-connected').style.display = 'block';
    document.getElementById('drive-setup-disconnected').style.display = 'none';
    const payload = parseJwt(driveToken);
    document.getElementById('drive-user-email').textContent = payload?.email || 'Cuenta Google conectada';
  } else {
    document.getElementById('drive-setup-connected').style.display = 'none';
    document.getElementById('drive-setup-disconnected').style.display = 'block';
  }
}

function closeSetupModal() {
  document.getElementById('setup-modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function closeSetupOutside(e) {
  if (e.target === document.getElementById('setup-modal-overlay')) closeSetupModal();
}

function saveClientId() {
  const val = document.getElementById('client-id-input').value.trim();
  if (!val) { toast('Pega un Client ID válido', true); return; }
  safeStorage.setItem(DRIVE_CLIENT_ID_KEY, val);
  document.getElementById('client-id-saved-msg').style.display = 'block';
  document.getElementById('google-signin-btn').disabled = false;
  toast('✓ Client ID guardado');
}

// ── OAuth con redirección (login manual) ──
function driveConnect() {
  safeStorage.setItem('aquacot_oauth_pending', '1');
  const redirectUri = window.location.origin + window.location.pathname;
  const params = new URLSearchParams({
    client_id:     HARDCODED_CLIENT_ID,
    redirect_uri:  redirectUri,
    response_type: 'token',
    scope:         DRIVE_SCOPE,
    prompt:        'consent',
    include_granted_scopes: 'true'
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
}

// ── Capturar token del hash tras redirección manual ──
function handleOAuthRedirect() {
  const hash = window.location.hash;
  if (!hash || !hash.includes('access_token')) return;
  const params    = new URLSearchParams(hash.substring(1));
  const token     = params.get('access_token');
  const expiresIn = parseInt(params.get('expires_in') || '3600');
  if (!token) return;
  history.replaceState(null, '', window.location.pathname);
  applyNewToken(token, expiresIn, true);
}

// ── Aplicar token (manual o renovado) ───────
function applyNewToken(token, expiresIn, isFirstConnect = false) {
  driveToken = token;
  const expiry = Date.now() + expiresIn * 1000;
  safeStorage.setItem(DRIVE_TOKEN_KEY, JSON.stringify({ token, expiry }));
  safeStorage.removeItem('aquacot_oauth_pending');
  scheduleRenewal(expiry);
  if (isFirstConnect) {
    toast('✅ Google Drive conectado. Sincronizando…');
    initDriveSync();
  }
}

// ── Renovación silenciosa del token ─────────
// Usa un iframe oculto con prompt=none — el usuario no ve nada.
// Google renueva el token automáticamente si su sesión sigue activa.
let renewalTimer = null;

function scheduleRenewal(expiry) {
  if (renewalTimer) clearTimeout(renewalTimer);
  // Renovar 5 minutos antes de que expire
  const msUntilRenew = expiry - Date.now() - 5 * 60 * 1000;
  const delay = Math.max(msUntilRenew, 10000); // mínimo 10s
  renewalTimer = setTimeout(silentRenew, delay);
}

function silentRenew() {
  if (!driveToken) return;
  const redirectUri = window.location.origin + window.location.pathname;
  const params = new URLSearchParams({
    client_id:     HARDCODED_CLIENT_ID,
    redirect_uri:  redirectUri,
    response_type: 'token',
    scope:         DRIVE_SCOPE,
    prompt:        'none',        // ← sin UI, falla si sesión Google cerrada
    include_granted_scopes: 'true'
  });

  // Crear iframe oculto
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'position:fixed;width:0;height:0;border:none;opacity:0;pointer-events:none';
  iframe.src = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
  document.body.appendChild(iframe);

  // Timeout de seguridad: si en 15s no hubo respuesta, limpiar
  const cleanup = setTimeout(() => {
    iframe.remove();
  }, 15000);

  // El iframe redirige de vuelta a nuestra URL con el token en el hash.
  // Escuchamos el mensaje desde el iframe via postMessage (ver handler abajo).
  iframe._cleanup = cleanup;
}

// ── Listener: recibir token renovado desde iframe ──
window.addEventListener('message', (e) => {
  if (e.origin !== window.location.origin) return;
  if (!e.data || e.data.type !== 'aquacot_token_renewal') return;

  const { token, expiresIn, error } = e.data;

  // Limpiar iframes de renovación
  document.querySelectorAll('iframe[src*="accounts.google.com"]').forEach(f => {
    clearTimeout(f._cleanup);
    f.remove();
  });

  if (error || !token) {
    // Sesión Google cerrada: avisar discretamente sin interrumpir
    console.warn('Renovación silenciosa fallida:', error);
    setDriveStatus('error', 'Sesión expirada — reconecta');
    toast('⚠️ Sesión de Drive expirada. Reconecta para continuar sincronizando.', true);
    return;
  }

  driveToken = token;
  const expiry = Date.now() + expiresIn * 1000;
  safeStorage.setItem(DRIVE_TOKEN_KEY, JSON.stringify({ token, expiry }));
  scheduleRenewal(expiry);
  // Actualizar estado visual solo si había error
  const btn = document.getElementById('drive-status-btn');
  if (btn && btn.classList.contains('error')) {
    const now = new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });
    setDriveStatus('connected', '✓ Sincronizado', now);
  }
});

// ── Detectar si esta página fue cargada dentro de un iframe de renovación ──
// Si estamos en un iframe y la URL tiene access_token, enviarlo al padre.
(function detectIframeRenewal() {
  try {
    if (window.self === window.top) return; // no estamos en iframe
    const hash = window.location.hash;
    if (!hash) return;

    const params = new URLSearchParams(hash.substring(1));
    const token     = params.get('access_token');
    const expiresIn = parseInt(params.get('expires_in') || '3600');
    const error     = params.get('error');

    if (token || error) {
      window.parent.postMessage({
        type:      'aquacot_token_renewal',
        token:     token || null,
        expiresIn: expiresIn,
        error:     error  || null
      }, window.location.origin);
    }
  } catch(e) { /* cross-origin iframe — ignorar */ }
})();

function driveDisconnect() {
  driveToken  = null;
  driveFileId = null;
  if (autoSyncTimer)  clearInterval(autoSyncTimer);
  if (renewalTimer)   clearTimeout(renewalTimer);
  autoSyncTimer = null;
  renewalTimer  = null;
  safeStorage.removeItem(DRIVE_TOKEN_KEY);
  setDriveStatus('', 'Conectar Drive');
  closeSetupModal();
  toast('Drive desconectado. Los datos siguen en local.');
}

// ── Restaurar sesión al cargar ───────────────
function restoreDriveSession() {
  // 1. ¿Venimos de un redirect OAuth manual?
  if (window.location.hash.includes('access_token')) {
    handleOAuthRedirect();
    return;
  }
  // 2. Limpiar flag de intento pendiente sin respuesta
  if (safeStorage.getItem('aquacot_oauth_pending')) {
    safeStorage.removeItem('aquacot_oauth_pending');
  }
  // 3. Restaurar token guardado
  const saved = safeStorage.getItem(DRIVE_TOKEN_KEY);
  if (!saved) return;
  try {
    const { token, expiry } = JSON.parse(saved);
    const msLeft = expiry - Date.now();
    if (msLeft > 60000) {
      // Token aún válido: úsalo y programa su renovación
      driveToken = token;
      scheduleRenewal(expiry);
      initDriveSync();
    } else if (msLeft > 0) {
      // Queda menos de 1 minuto: renovar ahora mismo antes de usarlo
      driveToken = token;
      scheduleRenewal(Date.now() + 5000); // renovar en 5s
      initDriveSync();
    } else {
      // Expirado: intentar renovación silenciosa inmediata
      // Si falla, el usuario verá el aviso de reconectar
      driveToken = token; // mantener temporalmente para el status
      scheduleRenewal(Date.now() + 2000); // renovar en 2s
      setDriveStatus('syncing', 'Renovando sesión…');
    }
  } catch(e) { safeStorage.removeItem(DRIVE_TOKEN_KEY); }
}

// ── Inicializar sincronización ──────────────
async function initDriveSync() {
  setDriveStatus('syncing', 'Sincronizando…');
  try {
    driveFileId = await findDriveFile();
    const uiState = captureUIState();

    if (driveFileId) {
      const remoteData = await downloadDriveFile();
      if (remoteData) {
        const merged          = mergeBilateral(ordenes, remoteData);
        const evDone          = mergeEvDone(getEvDone(), remoteData.evDone);
        const mergedClientes  = mergeClientes(clientes, remoteData.clientes);
        const mergedMayorista = mergeMayorista(mayorista, remoteData.mayorista);
        ordenes   = merged;
        clientes  = mergedClientes;
        mayorista = mergedMayorista;
        setEvDone(evDone);
        safeStorage.setItem(STORAGE_KEY,   JSON.stringify(ordenes));
        safeStorage.setItem(CLIENTES_KEY,  JSON.stringify(clientes));
        safeStorage.setItem(MAYORISTA_KEY, JSON.stringify(mayorista));
        // Subir el resultado del merge para que todos tengan la misma versión
        await uploadDriveFile();
        refreshUI(uiState);
      }
    } else {
      // Primera vez: subir datos locales
      await uploadDriveFile();
    }

    const now = new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });
    setDriveStatus('connected', '✓ Sincronizado', now);

    // Auto-sync cada 20 segundos
    if (autoSyncTimer) clearInterval(autoSyncTimer);
    autoSyncTimer = setInterval(autoSync, 20000);

  } catch(e) {
    console.error('Drive sync error:', e);
    setDriveStatus('error', 'Error al sincronizar');
    toast('Error de sincronización. Comprueba tu conexión.', true);
  }
}

// ── API Drive v3 helpers ─────────────────────
async function driveRequest(url, options = {}) {
  if (!driveToken) throw new Error('No hay token de Drive');
  const res = await fetch(url, {
    ...options,
    headers: {
      'Authorization': 'Bearer ' + driveToken,
      ...(options.headers || {})
    }
  });
  if (res.status === 401) {
    driveToken = null;
    safeStorage.removeItem(DRIVE_TOKEN_KEY);
    if (autoSyncTimer) clearInterval(autoSyncTimer);
    setDriveStatus('error', 'Sesión expirada');
    toast('Sesión de Drive expirada. Reconecta.', true);
    throw new Error('Token expired');
  }
  return res;
}

async function findDriveFile() {
  const res  = await driveRequest(
    `https://www.googleapis.com/drive/v3/files?q=name%3D'${DRIVE_FILE_NAME}'+and+trashed%3Dfalse&spaces=drive&fields=files(id,name,modifiedTime)`
  );
  const data = await res.json();
  if (data.files && data.files.length > 0) {
    data.files.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
    return data.files[0].id;
  }
  return null;
}

async function downloadDriveFile() {
  if (!driveFileId) return null;
  const res = await driveRequest(
    `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`
  );
  if (!res.ok) return null;
  return await res.json();
}

async function uploadDriveFile() {
  const payload = JSON.stringify({
    ordenes,
    clientes,
    mayorista,
    evDone:     [...getEvDone()],
    deletedIds: getDeletedIds(),
    lastUpdated: new Date().toISOString(),
    version: '2.2'
  });

  if (!driveFileId) {
    const boundary   = '-------314159265358979323846';
    const delimiter  = '\r\n--' + boundary + '\r\n';
    const closeDelim = '\r\n--' + boundary + '--';
    const metadata   = JSON.stringify({ name: DRIVE_FILE_NAME, mimeType: 'application/json' });
    const body = delimiter +
      'Content-Type: application/json\r\n\r\n' + metadata +
      delimiter + 'Content-Type: application/json\r\n\r\n' + payload + closeDelim;
    const res = await driveRequest(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
      { method: 'POST', headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, body }
    );
    const data = await res.json();
    driveFileId = data.id;
  } else {
    await driveRequest(
      `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`,
      { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: payload }
    );
  }
}

// ── Debounce al guardar: sube cambios locales ──
// Se llama cada vez que el usuario crea/edita/elimina/cambia evDone
function scheduleDriveSync() {
  if (!driveToken) return;
  syncPending = true;
  if (syncDebounce) clearTimeout(syncDebounce);
  syncDebounce = setTimeout(async () => {
    if (!syncPending) return;
    setDriveStatus('syncing', 'Guardando en Drive…');
    try {
      await uploadDriveFile();
      syncPending = false;
      const now = new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });
      setDriveStatus('connected', '✓ Drive sincronizado', now);
    } catch(e) {
      setDriveStatus('error', 'Error al guardar');
    }
  }, 1500);
}

// ── Auto-sync bilateral cada 20s ────────────
// Descarga remoto, hace merge, si hay cambios los aplica y re-sube
async function autoSync() {
  // No sincronizar si hay un upload pendiente (evita pisarlo)
  if (!driveToken || syncPending) return;
  try {
    const remoteData = await downloadDriveFile();
    if (!remoteData) return;

    const uiState         = captureUIState();
    const merged          = mergeBilateral(ordenes, remoteData);
    const evDone          = mergeEvDone(getEvDone(), remoteData.evDone);
    const mergedClientes  = mergeClientes(clientes, remoteData.clientes);
    const mergedMayorista = mergeMayorista(mayorista, remoteData.mayorista);

    // Detectar si realmente hubo cambios comparando serializado
    const localSerial     = JSON.stringify(ordenes.map(c => c.id + (c.lastUpdated||'')).sort());
    const mergedSerial    = JSON.stringify(merged.map(c => c.id + (c.lastUpdated||'')).sort());
    const evLocalSerial   = JSON.stringify([...getEvDone()].sort());
    const evMergedSerial  = JSON.stringify([...evDone].sort());
    const cliLocalSerial  = JSON.stringify(clientes.map(c => c.id + (c.lastUpdated||'')).sort());
    const cliMergedSerial = JSON.stringify(mergedClientes.map(c => c.id + (c.lastUpdated||'')).sort());
    const mayLocalSerial  = JSON.stringify(mayorista.map(v => v.id + (v.lastUpdated||'')).sort());
    const mayMergedSerial = JSON.stringify(mergedMayorista.map(v => v.id + (v.lastUpdated||'')).sort());
    const hayDiferencias  = localSerial !== mergedSerial || evLocalSerial !== evMergedSerial ||
                            cliLocalSerial !== cliMergedSerial || mayLocalSerial !== mayMergedSerial;

    if (hayDiferencias) {
      ordenes   = merged;
      clientes  = mergedClientes;
      mayorista = mergedMayorista;
      setEvDone(evDone);
      safeStorage.setItem(STORAGE_KEY,   JSON.stringify(ordenes));
      safeStorage.setItem(CLIENTES_KEY,  JSON.stringify(clientes));
      safeStorage.setItem(MAYORISTA_KEY, JSON.stringify(mayorista));
      // Subir el merge para que todos los dispositivos converjan
      await uploadDriveFile();
      refreshUI(uiState);
      const now = new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });
      setDriveStatus('connected', '✓ Drive sincronizado', now);
      toast('🔄 Cambios recibidos de otro dispositivo');
    }
  } catch(e) { /* silencioso en auto-sync */ }
}

// ── Sincronizar ahora (botón manual) ────────
async function syncNow() {
  if (!driveToken) { toast('No estás conectado a Drive', true); return; }
  closeSetupModal();
  setDriveStatus('syncing', 'Sincronizando…');
  try {
    const uiState    = captureUIState();
    const remoteData = await downloadDriveFile();
    if (remoteData) {
      const merged          = mergeBilateral(ordenes, remoteData);
      const evDone          = mergeEvDone(getEvDone(), remoteData.evDone);
      const mergedClientes  = mergeClientes(clientes, remoteData.clientes);
      const mergedMayorista = mergeMayorista(mayorista, remoteData.mayorista);
      ordenes   = merged;
      clientes  = mergedClientes;
      mayorista = mergedMayorista;
      setEvDone(evDone);
      safeStorage.setItem(STORAGE_KEY,   JSON.stringify(ordenes));
      safeStorage.setItem(CLIENTES_KEY,  JSON.stringify(clientes));
      safeStorage.setItem(MAYORISTA_KEY, JSON.stringify(mayorista));
    }
    await uploadDriveFile();
    refreshUI(uiState);
    const now = new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });
    setDriveStatus('connected', '✓ Drive sincronizado', now);
    toast('✅ Sincronización completada');
  } catch(e) {
    setDriveStatus('error', 'Error al sincronizar');
    toast('Error al sincronizar', true);
  }
}

// ── Util: parsear JWT (para email del usuario) ──
function parseJwt(token) {
  try {
    const base64 = token.split('.')[1]?.replace(/-/g,'+').replace(/_/g,'/');
    if (!base64) return null;
    return JSON.parse(atob(base64));
  } catch(e) { return null; }
}

// ─────────────────────────────────────────────
//  WHATSAPP
// ─────────────────────────────────────────────
function enviarWhatsApp(cotId) {
  let data;
  if (cotId !== undefined) {
    const cot = ordenes.find(c => c.id === cotId);
    if (!cot) { toast('Orden no encontrada', true); return; }
    data = { ...cot };
  } else {
    data = getFormData();
    if (!data.nombre) { toast('Ingresa el nombre del cliente', true); return; }
    if (data.items.length === 0) { toast('Agrega al menos una especie', true); return; }
  }

  if (!data.tel) { toast('Este cliente no tiene número de celular registrado', true); return; }

  // Formatear número colombiano: quitar espacios, guiones, +57 si ya viene
  let tel = data.tel.replace(/[\s\-\(\)]/g, '');
  if (tel.startsWith('0')) tel = tel.substring(1);
  if (!tel.startsWith('57')) tel = '57' + tel;

  // Construir mensaje
  const lineas = data.items.map(item => {
    const subTotal = item.subPescado + item.subEviscerado;
    return `  • ${item.especie}: ${item.qty} lb${item.ev ? ' (eviscerado)' : ''} → ${fmt(subTotal)}`;
  }).join('\n');

  const msg = [
    `🐟 *Lagos La Isabela*`,
    `📋 *Orden para ${data.nombre}*`,
    data.cc ? `🪪 CC/NIT: ${data.cc}` : null,
    `📅 ${data.fecha || new Date().toLocaleString('es-CO')}`,
    ``,
    `*Detalle del pedido:*`,
    lineas,
    ``,
    data.totalEviscerado > 0 ? `🔪 Eviscerado: ${fmt(data.totalEviscerado)}` : null,
    ``,
    `💰 *TOTAL A PAGAR: ${fmt(data.total)}*`,
    ``,
    `_Gracias por preferirnos_ 🙏`,
  ].filter(l => l !== null).join('\n');

  const url = `https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}
let acIndex = -1; // índice seleccionado con teclado

function getClientesSugeridos(query) {
  if (!query || query.length < 2) return [];
  const q = query.toLowerCase().trim();

  // Agrupar clientes únicos del historial
  const mapa = {};
  ordenes.forEach(c => {
    if (!c.nombre) return;
    const key = c.nombre.toLowerCase();
    if (!mapa[key]) mapa[key] = { nombre: c.nombre, tel: c.tel || '', cc: c.cc || '', count: 0 };
    mapa[key].count++;
  });

  // Incluir también clientes del directorio (sin compras aún)
  clientes.forEach(c => {
    if (!c.nombre) return;
    const key = c.nombre.toLowerCase();
    if (!mapa[key]) mapa[key] = { nombre: c.nombre, tel: c.tel || '', cc: c.cc || '', count: 0 };
    else {
      // Completar campos vacíos con los del directorio
      if (!mapa[key].tel && c.tel) mapa[key].tel = c.tel;
      if (!mapa[key].cc  && c.cc)  mapa[key].cc  = c.cc;
    }
  });

  return Object.values(mapa)
    .filter(c => c.nombre.toLowerCase().includes(q))
    .sort((a, b) => {
      const aStart = a.nombre.toLowerCase().startsWith(q) ? 0 : 1;
      const bStart = b.nombre.toLowerCase().startsWith(q) ? 0 : 1;
      return aStart - bStart || b.count - a.count;
    })
    .slice(0, 6);
}

function acNombre(val) {
  acIndex = -1;
  const list = document.getElementById('ac-list');
  const sugs = getClientesSugeridos(val);

  if (sugs.length === 0) { list.style.display = 'none'; return; }

  list.innerHTML = sugs.map((c, i) => `
    <div class="autocomplete-item" data-idx="${i}"
      onmousedown="acSelect('${c.nombre.replace(/'/g,"\\'")}','${c.tel.replace(/'/g,"\\'")}','${c.cc.replace(/'/g,"\\'")}')">
      <span class="ac-name">${highlightMatch(c.nombre, val)}</span>
      ${c.tel ? `<span class="ac-tel">${c.tel}</span>` : ''}
      <span class="ac-count">${c.count} cot.</span>
    </div>
  `).join('');

  // Posicionar el dropdown flotante debajo del input
  const anchor = document.getElementById('cliente-nombre');
  const rect   = anchor.getBoundingClientRect();
  list.style.top    = (rect.bottom + 4) + 'px';
  list.style.left   = rect.left + 'px';
  list.style.width  = rect.width + 'px';
  list.style.display = 'block';
}

function highlightMatch(text, query) {
  const idx = text.toLowerCase().indexOf(query.toLowerCase());
  if (idx === -1) return text;
  return text.slice(0, idx) +
    `<strong style="color:var(--teal)">${text.slice(idx, idx + query.length)}</strong>` +
    text.slice(idx + query.length);
}

function acSelect(nombre, tel, cc) {
  document.getElementById('cliente-nombre').value = nombre;
  if (tel) document.getElementById('cliente-tel').value = tel;
  if (cc)  document.getElementById('cliente-cc').value  = cc;
  document.getElementById('ac-list').style.display = 'none';
  acIndex = -1;
}

function acKeydown(e) {
  const list  = document.getElementById('ac-list');
  const items = list.querySelectorAll('.autocomplete-item');
  if (list.style.display === 'none' || items.length === 0) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    acIndex = Math.min(acIndex + 1, items.length - 1);
    acHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    acIndex = Math.max(acIndex - 1, -1);
    acHighlight(items);
  } else if (e.key === 'Enter' && acIndex >= 0) {
    e.preventDefault();
    items[acIndex].dispatchEvent(new MouseEvent('mousedown'));
  } else if (e.key === 'Escape') {
    list.style.display = 'none';
    acIndex = -1;
  }
}

function acHighlight(items) {
  items.forEach((el, i) => el.classList.toggle('selected', i === acIndex));
  if (acIndex >= 0) items[acIndex].scrollIntoView({ block: 'nearest' });
}

// Cerrar autocomplete al hacer clic fuera
document.addEventListener('click', e => {
  if (!e.target.closest('#ac-anchor') && !e.target.closest('#ac-list')) {
    document.getElementById('ac-list').style.display = 'none';
    acIndex = -1;
  }
});

// Reposicionar al hacer scroll o resize
window.addEventListener('scroll', () => {
  const list = document.getElementById('ac-list');
  if (list.style.display === 'none') return;
  const anchor = document.getElementById('cliente-nombre');
  const rect   = anchor.getBoundingClientRect();
  list.style.top  = (rect.bottom + 4) + 'px';
  list.style.left = rect.left + 'px';
}, true);

window.addEventListener('resize', () => {
  document.getElementById('ac-list').style.display = 'none';
  document.getElementById('ac-tel-list').style.display = 'none';
});

// ─────────────────────────────────────────────
//  AUTOCOMPLETE TELÉFONO
// ─────────────────────────────────────────────
let acTelIndex = -1;

function getClientesPorTel(query) {
  if (!query || query.length < 3) return [];
  const q = query.trim();
  const mapa = {};
  ordenes.forEach(c => {
    if (!c.tel) return;
    const key = c.tel;
    if (!mapa[key]) mapa[key] = { nombre: c.nombre, tel: c.tel, cc: c.cc || '', count: 0 };
    mapa[key].count++;
  });
  // Incluir clientes del directorio
  clientes.forEach(c => {
    if (!c.tel) return;
    const key = c.tel;
    if (!mapa[key]) mapa[key] = { nombre: c.nombre, tel: c.tel, cc: c.cc || '', count: 0 };
  });
  return Object.values(mapa)
    .filter(c => c.tel.includes(q))
    .sort((a, b) => {
      const aStart = a.tel.startsWith(q) ? 0 : 1;
      const bStart = b.tel.startsWith(q) ? 0 : 1;
      return aStart - bStart || b.count - a.count;
    })
    .slice(0, 6);
}

function acTel(val) {
  acTelIndex = -1;
  const list = document.getElementById('ac-tel-list');
  const sugs = getClientesPorTel(val);

  if (sugs.length === 0) { list.style.display = 'none'; return; }

  list.innerHTML = sugs.map((c, i) => `
    <div class="autocomplete-item" data-idx="${i}"
      onmousedown="acTelSelect('${c.nombre.replace(/'/g,"\\'")}','${c.tel.replace(/'/g,"\\'")}','${c.cc.replace(/'/g,"\\'")}')">
      <span class="ac-name">${highlightMatch(c.tel, val)}</span>
      <span class="ac-tel">${c.nombre}</span>
      <span class="ac-count">${c.count} cot.</span>
    </div>
  `).join('');

  const anchor = document.getElementById('cliente-tel');
  const rect   = anchor.getBoundingClientRect();
  list.style.top   = (rect.bottom + 4) + 'px';
  list.style.left  = rect.left + 'px';
  list.style.width = rect.width + 'px';
  list.style.display = 'block';
}

function acTelSelect(nombre, tel) {
  document.getElementById('cliente-tel').value    = tel;
  document.getElementById('cliente-nombre').value = nombre;
  document.getElementById('ac-tel-list').style.display = 'none';
  acTelIndex = -1;
}

function acTelKeydown(e) {
  const list  = document.getElementById('ac-tel-list');
  const items = list.querySelectorAll('.autocomplete-item');
  if (list.style.display === 'none' || items.length === 0) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    acTelIndex = Math.min(acTelIndex + 1, items.length - 1);
    acTelHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    acTelIndex = Math.max(acTelIndex - 1, -1);
    acTelHighlight(items);
  } else if (e.key === 'Enter' && acTelIndex >= 0) {
    e.preventDefault();
    items[acTelIndex].dispatchEvent(new MouseEvent('mousedown'));
  } else if (e.key === 'Escape') {
    list.style.display = 'none';
    acTelIndex = -1;
  }
}

function acTelHighlight(items) {
  items.forEach((el, i) => el.classList.toggle('selected', i === acTelIndex));
  if (acTelIndex >= 0) items[acTelIndex].scrollIntoView({ block: 'nearest' });
}

// Cerrar tel autocomplete al hacer clic fuera
document.addEventListener('click', e => {
  if (!e.target.closest('#ac-tel-anchor') && !e.target.closest('#ac-tel-list')) {
    document.getElementById('ac-tel-list').style.display = 'none';
    acTelIndex = -1;
  }
});

// Reposicionar tel dropdown al scroll
window.addEventListener('scroll', () => {
  const list = document.getElementById('ac-tel-list');
  if (list.style.display === 'none') return;
  const anchor = document.getElementById('cliente-tel');
  const rect   = anchor.getBoundingClientRect();
  list.style.top  = (rect.bottom + 4) + 'px';
  list.style.left = rect.left + 'px';
}, true);

// ─────────────────────────────────────────────
//  AUTOCOMPLETE CÉDULA / NIT
// ─────────────────────────────────────────────
let acCCIndex = -1;

function getClientesPorCC(query) {
  if (!query || query.length < 3) return [];
  const q = query.trim();
  const mapa = {};
  ordenes.forEach(c => {
    if (!c.cc) return;
    const key = c.cc;
    if (!mapa[key]) mapa[key] = { nombre: c.nombre, tel: c.tel || '', cc: c.cc, count: 0 };
    mapa[key].count++;
  });
  // Incluir clientes del directorio
  clientes.forEach(c => {
    if (!c.cc) return;
    const key = c.cc;
    if (!mapa[key]) mapa[key] = { nombre: c.nombre, tel: c.tel || '', cc: c.cc, count: 0 };
  });
  return Object.values(mapa)
    .filter(c => c.cc.includes(q))
    .sort((a, b) => {
      const aStart = a.cc.startsWith(q) ? 0 : 1;
      const bStart = b.cc.startsWith(q) ? 0 : 1;
      return aStart - bStart || b.count - a.count;
    })
    .slice(0, 6);
}

function acCC(val) {
  acCCIndex = -1;
  const list = document.getElementById('ac-cc-list');
  const sugs = getClientesPorCC(val);

  if (sugs.length === 0) { list.style.display = 'none'; return; }

  list.innerHTML = sugs.map((c, i) => `
    <div class="autocomplete-item" data-idx="${i}"
      onmousedown="acCCSelect('${c.nombre.replace(/'/g,"\\'")}','${c.tel.replace(/'/g,"\\'")}','${c.cc.replace(/'/g,"\\'")}')">
      <span class="ac-name">${highlightMatch(c.cc, val)}</span>
      <span class="ac-tel">${c.nombre}</span>
      <span class="ac-count">${c.count} cot.</span>
    </div>
  `).join('');

  const anchor = document.getElementById('cliente-cc');
  const rect   = anchor.getBoundingClientRect();
  list.style.top   = (rect.bottom + 4) + 'px';
  list.style.left  = rect.left + 'px';
  list.style.width = rect.width + 'px';
  list.style.display = 'block';
}

function acCCSelect(nombre, tel, cc) {
  document.getElementById('cliente-cc').value    = cc;
  document.getElementById('cliente-nombre').value = nombre;
  document.getElementById('cliente-tel').value    = tel;
  document.getElementById('ac-cc-list').style.display = 'none';
  acCCIndex = -1;
}

function acCCKeydown(e) {
  const list  = document.getElementById('ac-cc-list');
  const items = list.querySelectorAll('.autocomplete-item');
  if (list.style.display === 'none' || items.length === 0) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    acCCIndex = Math.min(acCCIndex + 1, items.length - 1);
    acCCHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    acCCIndex = Math.max(acCCIndex - 1, -1);
    acCCHighlight(items);
  } else if (e.key === 'Enter' && acCCIndex >= 0) {
    e.preventDefault();
    items[acCCIndex].dispatchEvent(new MouseEvent('mousedown'));
  } else if (e.key === 'Escape') {
    list.style.display = 'none';
    acCCIndex = -1;
  }
}

function acCCHighlight(items) {
  items.forEach((el, i) => el.classList.toggle('selected', i === acCCIndex));
  if (acCCIndex >= 0) items[acCCIndex].scrollIntoView({ block: 'nearest' });
}

document.addEventListener('click', e => {
  if (!e.target.closest('#ac-cc-anchor') && !e.target.closest('#ac-cc-list')) {
    document.getElementById('ac-cc-list').style.display = 'none';
    acCCIndex = -1;
  }
});

window.addEventListener('scroll', () => {
  const list = document.getElementById('ac-cc-list');
  if (list.style.display === 'none') return;
  const anchor = document.getElementById('cliente-cc');
  const rect   = anchor.getBoundingClientRect();
  list.style.top  = (rect.bottom + 4) + 'px';
  list.style.left = rect.left + 'px';
}, true);

// ═════════════════════════════════════════════
//  EVISCERADO — ÓRDENES EN TIEMPO REAL
// ═════════════════════════════════════════════
const EV_DONE_KEY  = 'aquacot_ev_done'; // Set de IDs marcados como completados
const EV_TIMES_KEY = 'aquacot_ev_times'; // Map id→{start, end} para medir tiempos

function getEvDone() {
  try { return new Set(JSON.parse(safeStorage.getItem(EV_DONE_KEY) || '[]')); }
  catch(e) { return new Set(); }
}

function setEvDone(set) {
  safeStorage.setItem(EV_DONE_KEY, JSON.stringify([...set]));
}

function getEvTimes() {
  try { return JSON.parse(safeStorage.getItem(EV_TIMES_KEY) || '{}'); }
  catch(e) { return {}; }
}
function setEvTimes(map) {
  safeStorage.setItem(EV_TIMES_KEY, JSON.stringify(map));
}

function toggleEvDone(cotId) {
  const done  = getEvDone();
  const times = getEvTimes();
  const now   = Date.now();

  if (done.has(cotId)) {
    // Desmarcar → eliminar timestamp de fin
    done.delete(cotId);
    if (times[cotId]) { delete times[cotId].end; }
  } else {
    // Marcar como completado → guardar timestamp de completado
    done.add(cotId);
    const orden = ordenes.find(c => c.id === cotId);
    const start = orden ? new Date(orden.fechaObj).getTime() : now;
    times[cotId] = { start, end: now };
  }
  setEvDone(done);
  setEvTimes(times);
  renderEviscerado();
  updateEvBadge();
  scheduleDriveSync();
}

function updateEvBadge() {
  const done    = getEvDone();
  const total   = ordenes.filter(c => c.totalEviscerado > 0);
  const pending = total.filter(c => !done.has(c.id)).length;
  document.getElementById('badge-ev').textContent = pending;
}

// ─────────────────────────────────────────────
//  EVISCERADO — FILTRO DE FECHAS
// ─────────────────────────────────────────────
let activeEvPeriod  = 'all';
let evCustomDesde   = null;
let evCustomHasta   = null;

function setEvPeriod(period) {
  activeEvPeriod = period;
  document.querySelectorAll('[data-evperiod]').forEach(b => {
    b.classList.toggle('active', b.dataset.evperiod === period);
  });
  const rangeEl = document.getElementById('ev-custom-range');
  rangeEl.style.display = period === 'custom' ? 'flex' : 'none';
  if (period !== 'custom') renderEviscerado();
}

function applyEvCustomRange() {
  const desde = document.getElementById('ev-date-desde').value;
  const hasta = document.getElementById('ev-date-hasta').value;
  if (!desde || !hasta) return;
  evCustomDesde = desde;
  evCustomHasta = hasta;
  renderEviscerado();
}

function getEvFiltered() {
  const now  = new Date();
  const hoy0 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
  const hoy23= new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

  let lista = ordenes.filter(c => c.totalEviscerado > 0);

  switch (activeEvPeriod) {
    case 'today':
      lista = lista.filter(c => { const d = new Date(c.fechaObj); return d >= hoy0 && d <= hoy23; });
      break;
    case 'week': {
      const day  = now.getDay();
      const diff = day === 0 ? 6 : day - 1;
      const lunes   = new Date(hoy0); lunes.setDate(hoy0.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6); domingo.setHours(23,59,59,999);
      lista = lista.filter(c => { const d = new Date(c.fechaObj); return d >= lunes && d <= domingo; });
      break;
    }
    case 'month': {
      const ini = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
      const fin = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
      lista = lista.filter(c => { const d = new Date(c.fechaObj); return d >= ini && d <= fin; });
      break;
    }
    case 'custom': {
      if (!evCustomDesde || !evCustomHasta) break;
      const desde = new Date(evCustomDesde + 'T00:00:00');
      const hasta  = new Date(evCustomHasta + 'T23:59:59');
      lista = lista.filter(c => { const d = new Date(c.fechaObj); return d >= desde && d <= hasta; });
      break;
    }
    default: break; // 'all'
  }
  return lista.sort((a, b) => new Date(a.fechaObj) - new Date(b.fechaObj));
}

function getEvPeriodLabel() {
  const now = new Date();
  const fd  = d => d.toLocaleDateString('es-CO', { day:'numeric', month:'short' });
  switch (activeEvPeriod) {
    case 'today':  return `Hoy, ${fd(now)}`;
    case 'week': {
      const day  = now.getDay();
      const diff = day === 0 ? 6 : day - 1;
      const lunes   = new Date(now); lunes.setDate(now.getDate() - diff);
      const domingo = new Date(lunes); domingo.setDate(lunes.getDate() + 6);
      return `${fd(lunes)} – ${fd(domingo)}`;
    }
    case 'month':  return now.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
    case 'custom': return evCustomDesde && evCustomHasta
      ? `${fd(new Date(evCustomDesde+'T00:00:00'))} – ${fd(new Date(evCustomHasta+'T00:00:00'))}`
      : 'Rango personalizado';
    default: return 'Todo el historial';
  }
}

function renderEviscerado() {
  const done = getEvDone();
  const conEv = getEvFiltered();

  // Actualizar pill de período
  document.getElementById('ev-period-pill').textContent = getEvPeriodLabel();

  const pendientes  = conEv.filter(c => !done.has(c.id));
  const completadas = conEv.filter(c =>  done.has(c.id))
    .sort((a, b) => new Date(b.fechaObj) - new Date(a.fechaObj)); // más reciente primero

  document.getElementById('ev-badge-pendientes').textContent  = pendientes.length;
  document.getElementById('ev-badge-completadas').textContent = completadas.length;

  const gridP  = document.getElementById('ev-cards-pendientes');
  const emptyP = document.getElementById('ev-empty-pendientes');
  if (pendientes.length === 0) {
    gridP.innerHTML = '';
    emptyP.style.display = 'block';
  } else {
    emptyP.style.display = 'none';
    gridP.innerHTML = pendientes.map(c => buildEvCard(c, false)).join('');
  }

  const gridC  = document.getElementById('ev-cards-completadas');
  const emptyC = document.getElementById('ev-empty-completadas');
  if (completadas.length === 0) {
    gridC.innerHTML = '';
    emptyC.style.display = 'block';
  } else {
    emptyC.style.display = 'none';
    gridC.innerHTML = completadas.map(c => buildEvCard(c, true)).join('');
  }

  // Actualizar estimador
  calcularEstimadorEv();
}

function buildEvCard(c, isDone) {
  // Solo las especies con eviscerado
  const evItems = c.items.filter(i => i.ev);
  const totalLbsEv = evItems.reduce((s, i) => s + i.qty, 0);
  const totalLbsAll = c.totalLibras;

  const pills = evItems.map(i =>
    `<span class="ev-species-pill">${i.especie} · ${i.qty} lb</span>`
  ).join('');

  // Formatear fecha corta
  const d = new Date(c.fechaObj);
  const fechaCorta = d.toLocaleDateString('es-CO', { day:'2-digit', month:'short', year:'numeric' });
  const horaCorta  = d.toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });

  // Timer chip (solo pendientes)
  let timerChipHtml = '';
  let doneTimeHtml  = '';

  if (!isDone) {
    const elapsed = Math.floor((Date.now() - d.getTime()) / 60000); // minutos
    const hrs = Math.floor(elapsed / 60);
    const min = elapsed % 60;
    const label = hrs > 0 ? `${hrs}h ${min}m esperando` : `${min}m esperando`;
    const urgent = elapsed > 30;
    timerChipHtml = `<span class="ev-timer-chip${urgent ? ' urgent' : ''}" data-start="${d.getTime()}">⏱ ${label}</span>`;
  } else {
    // Tiempo total de procesamiento
    const times = getEvTimes();
    if (times[c.id]?.end && times[c.id]?.start) {
      const dur = Math.round((times[c.id].end - times[c.id].start) / 60000);
      const hrs = Math.floor(dur / 60), min = dur % 60;
      const durStr = hrs > 0 ? `${hrs}h ${min}m` : `${min} min`;
      doneTimeHtml = `<div class="ev-done-time">✅ Procesado en ${durStr}</div>`;
    }
  }

  const footerBtn = isDone
    ? `<div class="ev-done-badge">✅ Eviscerado completado</div>
       <button class="btn-ev-undo" onclick="toggleEvDone(${c.id})" title="Desmarcar">↩</button>`
    : `<button class="btn-ev-done" onclick="toggleEvDone(${c.id})">
         ✓ Marcar como completado
       </button>`;

  return `
    <div class="ev-card ${isDone ? 'done' : ''}">
      <div class="ev-card-header">
        <div>
          <div class="ev-card-name">${c.nombre}</div>
          <div class="ev-card-meta">
            ${c.tel  ? `📱 ${c.tel}` : ''}
            ${c.cc   ? `&nbsp;·&nbsp;CC ${c.cc}` : ''}
          </div>
        </div>
        <div class="ev-card-time">
          ${fechaCorta}<br>${horaCorta}
        </div>
      </div>

      <div class="ev-card-body">
        <div class="ev-card-row">
          <span class="label">Libras a eviscerar</span>
          <span class="val big">${totalLbsEv.toFixed(1)} lb</span>
        </div>
        <div class="ev-card-row">
          <span class="label">Total libras (orden)</span>
          <span class="val">${totalLbsAll.toFixed(1)} lb</span>
        </div>
        ${!isDone ? `<div>${timerChipHtml}</div>` : ''}
      </div>

      <div class="ev-species-list">${pills}</div>

      <div class="ev-card-footer">${footerBtn}</div>
      ${doneTimeHtml}
    </div>
  `;
}

// ─────────────────────────────────────────────
//  ESTIMADOR DE FINALIZACIÓN — EVISCERADO
// ─────────────────────────────────────────────
let evCountdownInterval = null;

function calcularEstimadorEv() {
  const done      = getEvDone();
  const times     = getEvTimes();
  const pendientes = ordenes.filter(c => c.totalEviscerado > 0 && !done.has(c.id));
  const el        = document.getElementById('ev-estimador');
  const elHora    = document.getElementById('ev-est-hora');
  const elCount   = document.getElementById('ev-est-countdown');
  const elBasis   = document.getElementById('ev-est-basis');
  const elIcon    = document.getElementById('ev-est-icon');
  if (!el) return;

  // Limpiar countdown previo
  if (evCountdownInterval) { clearInterval(evCountdownInterval); evCountdownInterval = null; }

  const floatBtn  = document.getElementById('ev-float-btn');
  const floatText = document.getElementById('ev-float-text');

  if (pendientes.length === 0) {
    // ¿Hay órdenes ev totales? Si no hay ninguna, ocultar el botón
    const hayEv = ordenes.some(c => c.totalEviscerado > 0);
    el.className = 'ev-estimador listo';
    elIcon.textContent = '✅';
    elHora.textContent  = '¡Todo listo!';
    elCount.innerHTML   = 'Todas las órdenes de eviscerado han sido completadas.';
    elBasis.textContent = '';
    if (floatBtn) {
      if (hayEv) {
        floatBtn.className = 'done';
        floatText.textContent = '¡Listo!';
      } else {
        floatBtn.className = 'hidden';
      }
    }
    return;
  }

  // Calcular velocidad promedio: min/lb de órdenes COMPLETADAS del mismo día
  const hoy0  = new Date(); hoy0.setHours(0,0,0,0);
  const completadasHoy = ordenes.filter(c =>
    c.totalEviscerado > 0 &&
    done.has(c.id) &&
    times[c.id]?.end && times[c.id]?.start &&
    new Date(times[c.id].start) >= hoy0
  );

  let minPorLb = null; // minutos por libra
  let basisMsg = '';

  if (completadasHoy.length > 0) {
    let totalMin = 0, totalLb = 0;
    completadasHoy.forEach(c => {
      const dur = (times[c.id].end - times[c.id].start) / 60000;
      const lb  = c.items.filter(i => i.ev).reduce((s, i) => s + i.qty, 0);
      if (lb > 0 && dur > 0) { totalMin += dur; totalLb += lb; }
    });
    if (totalLb > 0) {
      minPorLb = totalMin / totalLb;
      basisMsg = `Promedio hoy: ${minPorLb.toFixed(1)} min/lb · ${completadasHoy.length} orden${completadasHoy.length !== 1 ? 'es' : ''} de referencia`;
    }
  }

  // Fallback: asumir 20 seg/lb si no hay datos del día
  if (minPorLb === null) {
    minPorLb = 20 / 60; // 20 segundos por libra → 0.333 min/lb
    basisMsg = 'Sin datos del día — estimado con referencia estándar (20 seg/lb)';
  }

  // Calcular libras pendientes totales (ordenadas por creación, FIFO)
  const pendientesOrdenados = pendientes.sort((a,b) => new Date(a.fechaObj) - new Date(b.fechaObj));
  let totalLibrasPend = 0;
  pendientesOrdenados.forEach(c => {
    totalLibrasPend += c.items.filter(i => i.ev).reduce((s, i) => s + i.qty, 0);
  });

  const minRestantes = Math.round(totalLibrasPend * minPorLb);
  const finEstimado  = new Date(Date.now() + minRestantes * 60000);

  // Si no hay libras pendientes o tiempo es cero → ocultar botón flotante
  if (totalLibrasPend === 0 || minRestantes === 0) {
    if (floatBtn) floatBtn.className = 'hidden';
    el.className = 'ev-estimador sin-datos';
    elIcon.textContent  = '⏱️';
    elHora.textContent  = '—';
    elCount.innerHTML   = 'Sin libras pendientes de eviscerado.';
    elBasis.textContent = '';
    return;
  }

  el.className = 'ev-estimador';

  const fmtHora = d => d.toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' });

  function actualizarCountdown() {
    const ahora  = new Date();
    const diffMs = finEstimado - ahora;

    if (diffMs <= 0) {
      elHora.textContent  = '¡Ahora!';
      elCount.innerHTML   = 'El tiempo estimado ya se cumplió.';
      if (floatBtn) floatBtn.className = 'hidden'; // tiempo = 0 → ocultar
      if (evCountdownInterval) { clearInterval(evCountdownInterval); evCountdownInterval = null; }
      return;
    }

    const diffMin  = Math.ceil(diffMs / 60000);
    const hh       = Math.floor(diffMin / 60);
    const mm       = diffMin % 60;
    const countStr = hh > 0 ? `${hh}h ${mm}m` : `${mm} min`;

    elHora.textContent = fmtHora(finEstimado);
    elCount.innerHTML  = `<strong>~${countStr} restantes</strong> · ${pendientes.length} orden${pendientes.length !== 1 ? 'es' : ''} · ${totalLibrasPend.toFixed(1)} lb`;

    // Botón flotante: visible con tiempo > 0
    if (floatBtn) {
      const isUrgent = diffMin > 30;
      floatBtn.className = isUrgent ? 'urgent pending' : 'pending';
      floatText.textContent = hh > 0 ? `${hh}h ${mm}m` : `${mm} min`;
      floatBtn.title = `Eviscerado: ~${countStr} restantes — clic para ir a la sección`;
    }
  }

  actualizarCountdown();
  elBasis.textContent = basisMsg;
  elIcon.textContent  = '⏱️';
  evCountdownInterval = setInterval(actualizarCountdown, 60000);
}

// ─────────────────────────────────────────────
//  GRÁFICO 15 DÍAS — barras apiladas
// ─────────────────────────────────────────────
let chart15Instance = null;

function renderChart15dias() {
  const canvas = document.getElementById('chart-15dias');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const now = new Date();

  // Generar los 15 días (hoy incluido)
  const dias = [];
  for (let i = 14; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
    dias.push(d);
  }

  // Sumar ventas detal y mayorista por día
  const detalPorDia    = dias.map(d => {
    const d0 = new Date(d); d0.setHours(0,0,0,0);
    const d1 = new Date(d); d1.setHours(23,59,59,999);
    return ordenes
      .filter(o => { const od = new Date(o.fechaObj); return od >= d0 && od <= d1; })
      .reduce((s, o) => s + (o.total || 0), 0);
  });

  const mayPorDia = dias.map(d => {
    const d0 = new Date(d); d0.setHours(0,0,0,0);
    const d1 = new Date(d); d1.setHours(23,59,59,999);
    return mayorista
      .filter(v => { const vd = new Date(v.fechaObj); return vd >= d0 && vd <= d1; })
      .reduce((s, v) => s + (v.total || 0), 0);
  });

  const labels = dias.map(d => {
    const today = new Date(); today.setHours(0,0,0,0);
    const isToday = d.getTime() === today.getTime();
    const label = d.toLocaleDateString('es-CO', { day:'numeric', month:'short' });
    return isToday ? `Hoy` : label;
  });

  // Detectar modo claro para colores del eje
  const isLight   = document.body.classList.contains('light');
  const textColor = isLight ? 'rgba(10,40,80,0.6)' : 'rgba(200,230,240,0.5)';
  const gridColor = isLight ? 'rgba(0,140,200,0.08)' : 'rgba(0,180,216,0.08)';

  if (chart15Instance) { chart15Instance.destroy(); chart15Instance = null; }

  // Ajustar canvas al contenedor
  const wrap = canvas.parentElement;
  canvas.width  = wrap.clientWidth  || 600;
  canvas.height = wrap.clientHeight || 220;

  // Dibujar gráfico de barras apiladas manualmente (sin dependencias externas)
  const W = canvas.width, H = canvas.height;
  const PAD_L = 72, PAD_R = 16, PAD_T = 16, PAD_B = 48;
  const chartW = W - PAD_L - PAD_R;
  const chartH = H - PAD_T - PAD_B;
  const n = dias.length;
  const barW  = Math.floor(chartW / n * 0.65);
  const barGap = chartW / n;

  const maxVal = Math.max(...dias.map((_, i) => detalPorDia[i] + mayPorDia[i]), 1);
  const niceMax = Math.ceil(maxVal / 1000) * 1000 || 1000;

  ctx.clearRect(0, 0, W, H);

  // Grid horizontal
  const gridLines = 4;
  ctx.textAlign = 'right';
  ctx.font = '10px Roboto Mono, monospace';
  ctx.fillStyle = textColor;
  for (let g = 0; g <= gridLines; g++) {
    const y = PAD_T + chartH - (g / gridLines) * chartH;
    const val = (g / gridLines) * niceMax;
    ctx.beginPath();
    ctx.strokeStyle = gridColor;
    ctx.lineWidth = 1;
    ctx.moveTo(PAD_L, y);
    ctx.lineTo(PAD_L + chartW, y);
    ctx.stroke();
    const label = val >= 1000000 ? `$${(val/1000000).toFixed(1)}M`
                : val >= 1000    ? `$${(val/1000).toFixed(0)}K`
                : `$${val}`;
    ctx.fillText(label, PAD_L - 6, y + 4);
  }

  // Barras
  for (let i = 0; i < n; i++) {
    const x    = PAD_L + i * barGap + (barGap - barW) / 2;
    const vDet = detalPorDia[i];
    const vMay = mayPorDia[i];
    const hDet = (vDet / niceMax) * chartH;
    const hMay = (vMay / niceMax) * chartH;

    // Barra detal (abajo, teal)
    if (hDet > 0) {
      const grd = ctx.createLinearGradient(0, PAD_T + chartH - hDet, 0, PAD_T + chartH);
      grd.addColorStop(0, 'rgba(0,180,216,0.9)');
      grd.addColorStop(1, 'rgba(0,100,160,0.7)');
      ctx.fillStyle = grd;
      const r = Math.min(4, barW / 2, hDet);
      ctx.beginPath();
      const yBot = PAD_T + chartH;
      const yTop = yBot - hDet;
      if (hMay > 0) {
        // Esquinas redondeadas solo abajo
        ctx.roundRect(x, yTop, barW, hDet, [0, 0, r, r]);
      } else {
        ctx.roundRect(x, yTop, barW, hDet, r);
      }
      ctx.fill();
    }

    // Barra mayorista (encima, verde)
    if (hMay > 0) {
      const grd = ctx.createLinearGradient(0, PAD_T + chartH - hDet - hMay, 0, PAD_T + chartH - hDet);
      grd.addColorStop(0, 'rgba(6,214,160,0.9)');
      grd.addColorStop(1, 'rgba(6,160,110,0.7)');
      ctx.fillStyle = grd;
      const r = Math.min(4, barW / 2, hMay);
      const yBot = PAD_T + chartH - hDet;
      const yTop = yBot - hMay;
      ctx.beginPath();
      ctx.roundRect(x, yTop, barW, hMay, [r, r, 0, 0]);
      ctx.fill();
    }

    // Etiqueta eje X
    ctx.fillStyle = textColor;
    ctx.font = i === n - 1 ? 'bold 10px DM Sans, sans-serif' : '10px DM Sans, sans-serif';
    ctx.textAlign = 'center';
    // Mostrar solo días alternos + hoy para no saturar
    if (i % 2 === 0 || i === n - 1) {
      ctx.fillText(labels[i], x + barW / 2, H - PAD_B + 16);
    }

    // Tooltip: total encima de la barra si hay datos
    const total = vDet + vMay;
    if (total > 0) {
      const hTotal = hDet + hMay;
      ctx.fillStyle = isLight ? 'rgba(0,50,100,0.7)' : 'rgba(200,240,255,0.7)';
      ctx.font = '9px Roboto Mono, monospace';
      ctx.textAlign = 'center';
      const shortVal = total >= 1000000 ? `${(total/1000000).toFixed(1)}M`
                     : total >= 1000    ? `${(total/1000).toFixed(0)}K`
                     : `${total}`;
      if (hTotal > 18) {
        ctx.fillText(`$${shortVal}`, x + barW / 2, PAD_T + chartH - hTotal - 4);
      }
    }
  }

  // Guardar referencia para poder destruirlo en el próximo render
  chart15Instance = { destroy: () => {} }; // placeholder
}

// ─────────────────────────────────────────────
//  PEZ NADADOR — nada horizontalmente con ondulación natural
// ─────────────────────────────────────────────
(function() {
  const fish   = document.getElementById('fish-swimmer');
  const header = fish.closest('header');

  const PECES = ['🐠','🐟','🐡','🦈','🐬','🐳','🦐','🦑','🐙','🦞','🦀','🐊','🐋','🦭'];
  let fishIdx = 0;

  function nextFish() {
    fishIdx = (fishIdx + 1) % PECES.length;
    fish.textContent = PECES[fishIdx];
  }

  const fw = 26; // ancho emoji aprox
  const fh = 24; // alto emoji aprox

  // Posición horizontal y dirección
  let x   = 80;
  let dir = 1; // 1 = derecha, -1 = izquierda

  // Velocidad base y variación
  let speed     = 1.0;   // velocidad horizontal actual
  let targetSpd = 1.0;   // velocidad objetivo (va cambiando)
  let spdTimer  = 0;     // contador para cambiar velocidad objetivo

  // Ondulación vertical: suma de dos senos con distintas frecuencias y amplitudes
  let t = 0;

  // Ángulo de inclinación suave
  let angle = 0;

  function loop() {
    const hw = header.offsetWidth;
    const hh = header.offsetHeight;

    // — Cambio gradual de velocidad —
    spdTimer++;
    if (spdTimer > 120) { // cada ~2s a 60fps cambia el objetivo
      targetSpd = 0.5 + Math.random() * 1.8; // entre 0.5 y 2.3
      spdTimer  = 0;
    }
    speed += (targetSpd - speed) * 0.008; // suaviza hacia el objetivo

    // — Avance horizontal —
    x += dir * speed;

    // — Rebotar: al llegar al borde cambia dirección y pez —
    if (x >= hw - fw) {
      x   = hw - fw;
      dir = -1;
      nextFish();
    } else if (x <= 0) {
      x   = 0;
      dir = 1;
      nextFish();
    }

    // — Oscilación vertical: mezcla de dos ondas —
    t += 0.022;
    const margin = 6; // margen del borde
    const centerY   = (hh - fh) / 2;
    const amplitude = (hh - fh) / 2 - margin;
    // Onda principal lenta + onda secundaria más rápida y pequeña
    const rawY = centerY
      + Math.sin(t * 0.9)          * amplitude * 0.6
      + Math.sin(t * 2.3 + 1.1)   * amplitude * 0.25
      + Math.sin(t * 0.4 + 0.5)   * amplitude * 0.15;
    const y = Math.max(margin, Math.min(hh - fh - margin, rawY));

    // — Inclinación: sigue la derivada vertical (subiendo/bajando) —
    const dy = Math.cos(t * 0.9)  * amplitude * 0.6  * 0.022 * 0.9
             + Math.cos(t * 2.3 + 1.1) * amplitude * 0.25 * 0.022 * 2.3;
    const targetAngle = dy * 180; // convierte a grados leve
    angle += (targetAngle - angle) * 0.1;
    const clampedAngle = Math.max(-18, Math.min(18, angle));

    // — Espejo horizontal según dirección —
    const scaleX = dir === 1 ? 1 : -1;

    fish.style.left      = x + 'px';
    fish.style.top       = y + 'px';
    fish.style.transform = `scaleX(${scaleX}) rotate(${clampedAngle * scaleX}deg)`;

    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);
})();

// ─────────────────────────────────────────────
//  TEMA CLARO / OSCURO
// ─────────────────────────────────────────────
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  const btn = document.getElementById('theme-toggle');
  btn.textContent = isLight ? '🌙' : '☀️';
  btn.title = isLight ? 'Cambiar a modo oscuro' : 'Cambiar a modo claro';
  safeStorage.setItem('aquacot_theme', isLight ? 'light' : 'dark');
  // Redibujar chart con colores del tema correcto
  requestAnimationFrame(() => renderChart15dias());
}

function initTheme() {
  const saved = safeStorage.getItem('aquacot_theme');
  const btn   = document.getElementById('theme-toggle');
  if (saved === 'light') {
    document.body.classList.add('light');
    btn.textContent = '🌙';
    btn.title = 'Cambiar a modo oscuro';
  } else {
    btn.textContent = '☀️';
    btn.title = 'Cambiar a modo claro';
  }
}

// ─────────────────────────────────────────────
//  INIT
// ─────────────────────────────────────────────
initTheme();
buildSpeciesGrid();
buildMaySpeciesGrid();
updateBadge();
updateEvBadge();
restoreDriveSession();

// Ticker cada 60s: refresca chips de tiempo en tarjetas pendientes y redibuja chart si dashboard visible
setInterval(() => {
  // Actualizar chips de espera en tarjetas de eviscerado
  document.querySelectorAll('.ev-timer-chip[data-start]').forEach(chip => {
    const start   = parseInt(chip.dataset.start);
    const elapsed = Math.floor((Date.now() - start) / 60000);
    const hrs = Math.floor(elapsed / 60), min = elapsed % 60;
    const label = hrs > 0 ? `${hrs}h ${min}m esperando` : `${min}m esperando`;
    chip.textContent = `⏱ ${label}`;
    chip.classList.toggle('urgent', elapsed > 30);
  });
  // Redibujar chart si el dashboard está activo
  if (document.getElementById('page-dashboard')?.classList.contains('active')) {
    renderChart15dias();
  }
}, 60000);
</script>
</body>
</html>
